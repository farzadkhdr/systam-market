<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام بيع الإلكترونيات - نظام إدارة المبيعات المتكامل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --gradient: linear-gradient(135deg, #4361ee, #3a0ca3, #7209b7);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fb;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* أنيميشن للخلفية */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* صفحة تسجيل الدخول */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            animation: slideUp 0.8s ease-out;
            backdrop-filter: blur(10px);
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            width: 120px;
            height: 120px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            animation: pulse 2s infinite;
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .logo i {
            font-size: 50px;
            color: white;
        }
        
        .system-name {
            color: var(--secondary);
            font-size: 28px;
            font-weight: 800;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .system-subtitle {
            color: var(--primary);
            font-size: 16px;
            margin-top: 5px;
        }
        
        .login-form h2 {
            color: var(--dark);
            margin-bottom: 25px;
            text-align: center;
            font-weight: 700;
            position: relative;
            padding-bottom: 10px;
        }
        
        .login-form h2:after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 80px;
            height: 4px;
            background: var(--gradient);
            border-radius: 2px;
            right: 50%;
            transform: translateX(50%);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f9f9f9;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            outline: none;
            background: white;
        }
        
        .btn {
            display: inline-block;
            padding: 15px 30px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-info {
            background: var(--info);
        }
        
        /* النظام الرئيسي */
        .main-system {
            display: none;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-logo .logo {
            width: 50px;
            height: 50px;
            animation: none;
        }
        
        .header-logo .logo i {
            font-size: 24px;
        }
        
        .header-info h1 {
            font-size: 22px;
            color: var(--secondary);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: #d1145a;
        }
        
        .sidebar {
            width: 250px;
            background: white;
            height: calc(100vh - 80px);
            position: fixed;
            right: 0;
            top: 80px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            transition: all 0.3s;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 5px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #555;
            text-decoration: none;
            transition: all 0.3s;
            gap: 12px;
            border-right: 4px solid transparent;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border-right-color: var(--primary);
        }
        
        .sidebar-menu a i {
            width: 20px;
            text-align: center;
        }
        
        .content {
            margin-right: 250px;
            padding: 30px;
            min-height: calc(100vh - 80px);
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            color: var(--secondary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* بطاقات الإحصائيات */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.3s;
            border-top: 5px solid var(--primary);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card:nth-child(2) { border-top-color: var(--success); }
        .stat-card:nth-child(3) { border-top-color: var(--warning); }
        .stat-card:nth-child(4) { border-top-color: var(--info); }
        .stat-card:nth-child(5) { border-top-color: #9d4edd; }
        .stat-card:nth-child(6) { border-top-color: #ff9e00; }
        
        .stat-icon {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
        }
        
        .stat-card:nth-child(1) .stat-icon { background: var(--primary); }
        .stat-card:nth-child(2) .stat-icon { background: var(--success); }
        .stat-card:nth-child(3) .stat-icon { background: var(--warning); }
        .stat-card:nth-child(4) .stat-icon { background: var(--info); }
        .stat-card:nth-child(5) .stat-icon { background: #9d4edd; }
        .stat-card:nth-child(6) .stat-icon { background: #ff9e00; }
        
        .stat-content {
            text-align: right;
            margin-right: 70px;
        }
        
        .stat-title {
            color: #777;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            color: var(--dark);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 13px;
            font-weight: 600;
        }
        
        .stat-change.positive {
            color: #2ecc71;
        }
        
        .stat-change.negative {
            color: #e74c3c;
        }
        
        /* تصميم الجداول */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--gradient);
            color: white;
        }
        
        th {
            padding: 18px 15px;
            text-align: right;
            font-weight: 600;
        }
        
        tbody tr {
            border-bottom: 1px solid #eee;
            transition: all 0.2s;
        }
        
        tbody tr:hover {
            background: #f9f9f9;
        }
        
        td {
            padding: 15px;
            color: #555;
        }
        
        /* أزرار العمل */
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #4cc9f0;
            color: white;
        }
        
        .btn-delete {
            background: #f72585;
            color: white;
        }
        
        .btn-print {
            background: #4361ee;
            color: white;
        }
        
        .btn-view {
            background: #7209b7;
            color: white;
        }
        
        .btn-small:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        /* نموذج البحث */
        .search-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .search-box {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        
        /* المنتجات في السلة */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.3s;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
        }
        
        .product-img {
            height: 150px;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 50px;
        }
        
        .product-info {
            padding: 20px;
        }
        
        .product-name {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .product-price {
            color: var(--primary);
            font-weight: 800;
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        /* طباعة الفواتير */
        .print-options {
            display: flex;
            gap: 20px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        .print-option {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        
        .print-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }
        
        .print-icon {
            font-size: 50px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        /* الطباعة A4 */
        .invoice-a4 {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            padding: 20mm;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .invoice-logo {
            width: 80px;
            height: 80px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
        }
        
        /* الباركود */
        .barcode-container {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.06);
            margin: 30px 0;
        }
        
        .barcode {
            width: 100%;
            max-width: 300px;
            height: 120px;
            background: #f5f5f5;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: monospace;
            font-size: 24px;
            letter-spacing: 2px;
            color: #333;
            padding: 10px;
        }
        
        /* الفاتورة الصغيرة */
        .small-invoice {
            width: 80mm;
            background: white;
            padding: 15px;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* النوافذ المنبثقة */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }
        
        /* التبويبات */
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 700;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* التجاوب */
        @media (max-width: 992px) {
            .sidebar {
                right: -250px;
            }
            
            .sidebar.active {
                right: 0;
            }
            
            .content {
                margin-right: 0;
            }
            
            .menu-toggle {
                display: block;
                background: var(--primary);
                color: white;
                border: none;
                width: 45px;
                height: 45px;
                border-radius: 10px;
                font-size: 20px;
                cursor: pointer;
            }
        }
        
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .header {
                padding: 15px 20px;
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .content {
                padding: 20px;
            }
        }
        
        /* الألوان للاقتراح التلقائي */
        .color-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-option:hover {
            transform: scale(1.1);
        }
        
        .color-option.selected {
            border-color: #333;
        }
        
        /* شجرة القائمة */
        .menu-tree {
            list-style: none;
            padding-right: 20px;
        }
        
        .menu-tree li {
            margin-bottom: 10px;
        }
        
        .menu-tree label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        /* الحقول المتقدمة */
        .advanced-fields {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .advanced-fields.active {
            display: block;
        }
        
        /* التحميل */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* نافذة إضافة كائن جديد */
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideDown 0.3s ease-out;
        }
        
        .notification.success {
            background-color: #4CAF50;
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        .notification.warning {
            background-color: #ff9800;
        }
        
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-30px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .confirmation-modal {
            max-width: 400px;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .confirmation-buttons button {
            flex: 1;
        }
    </style>
</head>
<body>
    <!-- أنيميشن الخلفية -->
    <div class="bg-animation"></div>
    
    <!-- صفحة تسجيل الدخول -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h1 class="system-name">نظام إدارة بيع الإلكترونيات</h1>
                <p class="system-subtitle">متجرك الإلكتروني المتكامل لإدارة المبيعات والمخزون</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <h2>تسجيل الدخول</h2>
                
                <div class="form-group">
                    <label for="username">اسم المستخدم</label>
                    <input type="text" id="username" class="form-control" placeholder="أدخل اسم المستخدم" required>
                </div>
                
                <div class="form-group">
                    <label for="password">كلمة المرور</label>
                    <input type="password" id="password" class="form-control" placeholder="أدخل كلمة المرور" required>
                </div>
                
                <button type="submit" class="btn">دخول إلى النظام</button>
                <p style="text-align: center; margin-top: 15px; color: #777;">
                    كلمة المرور الافتراضية: <strong>farzad1234</strong>
                </p>
            </form>
        </div>
    </div>
    
    <!-- النظام الرئيسي -->
    <div class="main-system" id="mainSystem">
        <!-- الهيدر -->
        <header class="header">
            <div class="header-logo">
                <div class="logo">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="header-info">
                    <h1>نظام إدارة بيع الإلكترونيات</h1>
                </div>
            </div>
            
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="user-info">
                <div class="user-avatar">م</div>
                <div>
                    <div style="font-weight: 700;">مدير النظام</div>
                    <div style="font-size: 13px; color: #777;">مدير</div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </header>
        
        <!-- القائمة الجانبية -->
        <nav class="sidebar" id="sidebar">
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</a></li>
                <li><a href="#" data-section="sales"><i class="fas fa-cash-register"></i> نقطة البيع</a></li>
                <li><a href="#" data-section="inventory"><i class="fas fa-boxes"></i> إدارة المخزون</a></li>
                <li><a href="#" data-section="purchases"><i class="fas fa-shopping-cart"></i> المشتريات</a></li>
                <li><a href="#" data-section="customers"><i class="fas fa-users"></i> العملاء والموردين</a></li>
                <li><a href="#" data-section="payments"><i class="fas fa-money-bill-wave"></i> الدفعات والمصروفات</a></li>
                <li><a href="#" data-section="invoices"><i class="fas fa-file-invoice"></i> الفواتير</a></li>
                <li><a href="#" data-section="reports"><i class="fas fa-chart-bar"></i> التقارير</a></li>
                <li><a href="#" data-section="users"><i class="fas fa-user-shield"></i> المستخدمين والصلاحيات</a></li>
                <li><a href="#" data-section="settings"><i class="fas fa-cog"></i> الإعدادات</a></li>
                <li><a href="#" data-section="backup"><i class="fas fa-database"></i> النسخ الاحتياطي</a></li>
            </ul>
        </nav>
        
        <!-- المحتوى الرئيسي -->
        <main class="content">
            <!-- لوحة التحكم -->
            <section class="section active" id="dashboard">
                <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</h2>
                
                <div class="stats-cards">
                    <!-- إحصائيات الشهر -->
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">إجمالي المبيعات (شهري)</div>
                            <div class="stat-value"><span id="monthlySales">0</span> <span style="font-size: 16px;">د.ع</span></div>
                            <div class="stat-change positive"><i class="fas fa-arrow-up"></i> <span id="monthlySalesChange">0</span>% عن الشهر الماضي</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-cart-arrow-down"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">إجمالي المشتريات (شهري)</div>
                            <div class="stat-value"><span id="monthlyPurchases">0</span> <span style="font-size: 16px;">د.ع</span></div>
                            <div class="stat-change positive"><i class="fas fa-arrow-up"></i> <span id="monthlyPurchasesChange">0</span>% عن الشهر الماضي</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">الفرق (المبيعات - المشتريات)</div>
                            <div class="stat-value"><span id="monthlyProfit">0</span> <span style="font-size: 16px;">د.ع</span></div>
                            <div class="stat-change positive"><i class="fas fa-arrow-up"></i> <span id="monthlyProfitChange">0</span>% عن الشهر الماضي</div>
                        </div>
                    </div>
                    
                    <!-- إحصائيات اليوم -->
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">إجمالي المبيعات (اليوم)</div>
                            <div class="stat-value"><span id="dailySales">0</span> <span style="font-size: 16px;">د.ع</span></div>
                            <div class="stat-change positive"><i class="fas fa-arrow-up"></i> <span id="dailySalesChange">0</span>% عن الأمس</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-cart-arrow-down"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">إجمالي المشتريات (اليوم)</div>
                            <div class="stat-value"><span id="dailyPurchases">0</span> <span style="font-size: 16px;">د.ع</span></div>
                            <div class="stat-change negative"><i class="fas fa-arrow-down"></i> <span id="dailyPurchasesChange">0</span>% عن الأمس</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">الفرق (المبيعات - المشتريات)</div>
                            <div class="stat-value"><span id="dailyProfit">0</span> <span style="font-size: 16px;">د.ع</span></div>
                            <div class="stat-change positive"><i class="fas fa-arrow-up"></i> <span id="dailyProfitChange">0</span>% عن الأمس</div>
                        </div>
                    </div>
                    
                    <!-- إحصائيات إضافية -->
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">إجمالي المنتجات في المخزون</div>
                            <div class="stat-value"><span id="totalProducts">0</span></div>
                            <div class="stat-change positive"><i class="fas fa-arrow-up"></i> <span id="newProducts">0</span> منتج جديد</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">إجمالي العملاء</div>
                            <div class="stat-value"><span id="totalCustomers">0</span></div>
                            <div class="stat-change positive"><i class="fas fa-arrow-up"></i> <span id="newCustomers">0</span> عميل جديد</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-title">إجمالي الديون على العملاء</div>
                            <div class="stat-value"><span id="totalDebts">0</span> <span style="font-size: 16px;">د.ع</span></div>
                            <div class="stat-change negative"><i class="fas fa-arrow-up"></i> <span id="debtIncrease">0</span> د.ع زيادة</div>
                        </div>
                    </div>
                </div>
                
                <!-- أحدث الفواتير -->
                <div class="table-container">
                    <h3 style="padding: 20px; margin: 0; border-bottom: 1px solid #eee;">أحدث الفواتير</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>العميل</th>
                                <th>إجمالي الفاتورة</th>
                                <th>طريقة الدفع</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="recentInvoices">
                            <!-- سيتم ملء أحدث الفواتير ديناميكيا -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- نقطة البيع -->
            <section class="section" id="sales">
                <h2 class="section-title"><i class="fas fa-cash-register"></i> نقطة البيع</h2>
                
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="productSearch" class="search-input" placeholder="ابحث عن المنتج بالاسم أو الباركود..." onkeyup="searchProducts()">
                        <button class="btn" onclick="scanBarcode()"><i class="fas fa-barcode"></i> مسح باركود</button>
                        <button class="btn btn-success" onclick="clearCart()"><i class="fas fa-trash"></i> تفريغ السلة</button>
                    </div>
                </div>
                
                <div class="products-grid" id="productsGrid">
                    <!-- سيتم ملء المنتجات ديناميكيا -->
                </div>
                
                <div class="table-container">
                    <h3 style="padding: 20px; margin: 0; border-bottom: 1px solid #eee;">سلة المشتريات</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المنتج</th>
                                <th>السعر</th>
                                <th>الكمية</th>
                                <th>الإجمالي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="cartItems">
                            <!-- سيتم ملء عناصر السلة ديناميكيا -->
                        </tbody>
                    </table>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 30px; flex-wrap: wrap; gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 15px; flex: 1; min-width: 300px;">
                        <h3 style="margin-bottom: 15px;">معلومات العميل</h3>
                        <div class="search-box">
                            <input type="text" id="customerSearch" class="search-input" placeholder="ابحث عن العميل..." onkeyup="searchCustomers()">
                            <div id="customerSuggestions" style="display: none; background: white; border: 1px solid #ddd; border-radius: 10px; max-height: 200px; overflow-y: auto; position: absolute; width: calc(100% - 15px); z-index: 100; margin-top: 5px;"></div>
                        </div>
                        <div id="selectedCustomerInfo" style="margin-top: 15px; display: none;">
                            <div style="padding: 10px; background: #f9f9f9; border-radius: 10px;">
                                <strong>العميل المحدد:</strong> <span id="selectedCustomerName"></span><br>
                                <strong>الديون السابقة:</strong> <span id="customerPreviousDebt">0</span> د.ع
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="radio" name="paymentType" value="cash" checked> نقداً
                            </label>
                            <label style="display: block;">
                                <input type="radio" name="paymentType" value="credit"> بالدين
                            </label>
                        </div>
                        <div id="creditSection" style="display: none; margin-top: 15px;">
                            <input type="number" id="creditAmount" class="form-control" placeholder="مبلغ الدين" style="margin-bottom: 10px;">
                            <input type="date" id="creditDueDate" class="form-control">
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 15px; flex: 2; min-width: 300px;">
                        <h3 style="margin-bottom: 15px;">ملخص الفاتورة</h3>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>إجمالي المنتجات:</span>
                            <span style="font-weight: 700;" id="subtotal">0 د.ع</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>الخصم:</span>
                            <span style="font-weight: 700;" id="discount">0 د.ع</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>الضريبة:</span>
                            <span style="font-weight: 700;" id="tax">0 د.ع</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding-top: 15px; border-top: 2px solid #eee;">
                            <span style="font-size: 18px; font-weight: 700;">الإجمالي النهائي:</span>
                            <span style="font-size: 24px; font-weight: 800; color: var(--primary);" id="totalAmount">0 د.ع</span>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <input type="number" id="discountInput" class="form-control" placeholder="مبلغ الخصم" style="margin-bottom: 10px;" onchange="updateDiscount()">
                            <button class="btn btn-warning" onclick="applyDiscount(10)" style="width: auto; margin-right: 5px;">خصم 10%</button>
                            <button class="btn btn-warning" onclick="applyDiscount(20)" style="width: auto;">خصم 20%</button>
                        </div>
                        
                        <!-- خيارات الطباعة -->
                        <div class="print-options">
                            <div class="print-option" id="printSmall">
                                <div class="print-icon">
                                    <i class="fas fa-print"></i>
                                </div>
                                <h4>طباعة إيصال صغير</h4>
                                <p>مناسب للطابعات المحمولة</p>
                            </div>
                            
                            <div class="print-option" id="printA4">
                                <div class="print-icon">
                                    <i class="fas fa-file-invoice"></i>
                                </div>
                                <h4>طباعة فاتورة A4</h4>
                                <p>فاتورة كاملة في صفحة واحدة</p>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" style="margin-top: 20px;" onclick="completeSale()">
                            <i class="fas fa-check-circle"></i> إتمام البيع
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- إدارة المخزون -->
            <section class="section" id="inventory">
                <h2 class="section-title"><i class="fas fa-boxes"></i> إدارة المخزون</h2>
                
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="inventorySearch" class="search-input" placeholder="ابحث عن المنتج..." onkeyup="searchInventory()">
                        <button class="btn"><i class="fas fa-search"></i> بحث</button>
                        <button class="btn btn-success" onclick="openAddProductModal()"><i class="fas fa-plus"></i> إضافة منتج جديد</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المنتج</th>
                                <th>الصورة</th>
                                <th>الكمية المتاحة</th>
                                <th>سعر الشراء</th>
                                <th>سعر البيع</th>
                                <th>النوع</th>
                                <th>اللون</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- سيتم ملء بيانات المخزون ديناميكيا -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- المشتريات -->
            <section class="section" id="purchases">
                <h2 class="section-title"><i class="fas fa-shopping-cart"></i> المشتريات</h2>
                
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="purchaseSearch" class="search-input" placeholder="ابحث عن فاتورة شراء..." onkeyup="searchPurchases()">
                        <button class="btn"><i class="fas fa-search"></i> بحث</button>
                        <button class="btn btn-success" onclick="openAddPurchaseModal()"><i class="fas fa-plus"></i> عملية شراء جديدة</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="purchasesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>المورد</th>
                                <th>إجمالي الفاتورة</th>
                                <th>طريقة الدفع</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- سيتم ملء بيانات المشتريات ديناميكيا -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- العملاء والموردين -->
            <section class="section" id="customers">
                <h2 class="section-title"><i class="fas fa-users"></i> العملاء والموردين</h2>
                
                <div class="tabs">
                    <div class="tab active" data-tab="customers">العملاء</div>
                    <div class="tab" data-tab="suppliers">الموردين</div>
                </div>
                
                <!-- تبويب العملاء -->
                <div class="tab-content active" id="customersTab">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" id="customerListSearch" class="search-input" placeholder="ابحث عن عميل..." onkeyup="searchCustomerList()">
                            <button class="btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-success" onclick="openAddCustomerModal()"><i class="fas fa-user-plus"></i> إضافة عميل جديد</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="customersTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>الاسم</th>
                                    <th>رقم الهاتف</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>إجمالي المشتريات</th>
                                    <th>الديون الحالية</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملء بيانات العملاء ديناميكيا -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- تبويب الموردين -->
                <div class="tab-content" id="suppliersTab">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" id="supplierSearch" class="search-input" placeholder="ابحث عن مورد..." onkeyup="searchSuppliers()">
                            <button class="btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-success" onclick="openAddSupplierModal()"><i class="fas fa-user-plus"></i> إضافة مورد جديد</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="suppliersTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>الاسم</th>
                                    <th>رقم الهاتف</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>إجمالي المشتريات</th>
                                    <th>الديون الحالية</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملء بيانات الموردين ديناميكيا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- الدفعات والمصروفات -->
            <section class="section" id="payments">
                <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> الدفعات والمصروفات</h2>
                
                <div class="tabs">
                    <div class="tab active" data-tab="customerPayments">دفعات العملاء</div>
                    <div class="tab" data-tab="supplierPayments">دفعات الموردين</div>
                    <div class="tab" data-tab="expenses">المصروفات</div>
                </div>
                
                <!-- تبويب دفعات العملاء -->
                <div class="tab-content active" id="customerPaymentsTab">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" id="customerPaymentSearch" class="search-input" placeholder="ابحث عن دفعة عميل..." onkeyup="searchCustomerPayments()">
                            <button class="btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-success" onclick="openAddCustomerPaymentModal()"><i class="fas fa-money-bill"></i> إضافة دفعة عميل</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="customerPaymentsTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>العميل</th>
                                    <th>المبلغ</th>
                                    <th>التاريخ</th>
                                    <th>الطريقة</th>
                                    <th>ملاحظات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملء بيانات دفعات العملاء دیناميكيا -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- تبويب دفعات الموردين -->
                <div class="tab-content" id="supplierPaymentsTab">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" id="supplierPaymentSearch" class="search-input" placeholder="ابحث عن دفعة مورد..." onkeyup="searchSupplierPayments()">
                            <button class="btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-success" onclick="openAddSupplierPaymentModal()"><i class="fas fa-money-bill"></i> إضافة دفعة مورد</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="supplierPaymentsTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>المورد</th>
                                    <th>المبلغ</th>
                                    <th>التاريخ</th>
                                    <th>الطريقة</th>
                                    <th>ملاحظات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملء بيانات دفعات الموردين ديناميكيا -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- تبويب المصروفات -->
                <div class="tab-content" id="expensesTab">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" id="expenseSearch" class="search-input" placeholder="ابحث عن مصروف..." onkeyup="searchExpenses()">
                            <button class="btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-success" onclick="openAddExpenseModal()"><i class="fas fa-money-bill"></i> إضافة مصروف</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="expensesTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>النوع</th>
                                    <th>المبلغ</th>
                                    <th>التاريخ</th>
                                    <th>المستلم</th>
                                    <th>ملاحظات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملء بيانات المصروفات ديناميكيا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- الفواتير -->
            <section class="section" id="invoices">
                <h2 class="section-title"><i class="fas fa-file-invoice"></i> الفواتير</h2>
                
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="invoiceSearch" class="search-input" placeholder="ابحث برقم الفاتورة أو اسم العميل..." onkeyup="searchInvoices()">
                        <button class="btn"><i class="fas fa-search"></i> بحث</button>
                        <button class="btn btn-info" onclick="exportInvoices()"><i class="fas fa-file-export"></i> تصدير</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="invoicesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>العميل</th>
                                <th>إجمالي الفاتورة</th>
                                <th>طريقة الدفع</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- سيتم ملء بيانات الفواتير ديناميكيا -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- التقارير -->
            <section class="section" id="reports">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> التقارير والإحصائيات</h2>
                
                <div class="search-container">
                    <div class="search-box">
                        <select id="reportType" class="search-input" style="flex: 1;">
                            <option value="daily">تقرير يومي</option>
                            <option value="weekly">تقرير أسبوعي</option>
                            <option value="monthly">تقرير شهري</option>
                            <option value="yearly">تقرير سنوي</option>
                        </select>
                        <input type="date" id="reportDate" class="search-input" style="width: 200px;">
                        <button class="btn" onclick="generateReport()"><i class="fas fa-chart-line"></i> توليد التقرير</button>
                        <button class="btn btn-info" onclick="printReport()"><i class="fas fa-print"></i> طباعة التقرير</button>
                    </div>
                </div>
                
                <div id="reportResults">
                    <!-- سيتم عرض نتائج التقرير هنا -->
                </div>
            </section>
            
            <!-- المستخدمين والصلاحيات -->
            <section class="section" id="users">
                <h2 class="section-title"><i class="fas fa-user-shield"></i> المستخدمين والصلاحيات</h2>
                
                <div class="tabs">
                    <div class="tab active" data-tab="users">المستخدمين</div>
                    <div class="tab" data-tab="roles">الصلاحيات</div>
                </div>
                
                <!-- تبويب المستخدمين -->
                <div class="tab-content active" id="usersTab">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" id="userSearch" class="search-input" placeholder="ابحث عن مستخدم..." onkeyup="searchUsers()">
                            <button class="btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-success" onclick="openAddUserModal()"><i class="fas fa-user-plus"></i> إضافة مستخدم جديد</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم المستخدم</th>
                                    <th>الاسم الكامل</th>
                                    <th>الدور</th>
                                    <th>تاريخ الإنشاء</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملء بيانات المستخدمين ديناميكيا -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- تبويب الصلاحيات -->
                <div class="tab-content" id="rolesTab">
                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" id="roleSearch" class="search-input" placeholder="ابحث عن صلاحية..." onkeyup="searchRoles()">
                            <button class="btn"><i class="fas fa-search"></i> بحث</button>
                            <button class="btn btn-success" onclick="openAddRoleModal()"><i class="fas fa-plus"></i> إضافة صلاحية جديدة</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="rolesTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>اسم الصلاحية</th>
                                    <th>عدد المستخدمين</th>
                                    <th>الوصف</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- سيتم ملء بيانات الصلاحيات ديناميكيا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- الإعدادات -->
            <section class="section" id="settings">
                <h2 class="section-title"><i class="fas fa-cog"></i> الإعدادات</h2>
                
                <div class="tabs">
                    <div class="tab active" data-tab="general">عام</div>
                    <div class="tab" data-tab="printing">الطباعة</div>
                    <div class="tab" data-tab="products">المنتجات</div>
                    <div class="tab" data-tab="company">الشركة</div>
                </div>
                
                <!-- تبويب الإعدادات العامة -->
                <div class="tab-content active" id="generalTab">
                    <div class="search-container">
                        <div class="search-box" style="flex-direction: column; align-items: flex-start; gap: 25px;">
                            <div style="width: 100%;">
                                <h3 style="margin-bottom: 15px;">تغيير كلمة المرور</h3>
                                <div class="form-group">
                                    <label>كلمة المرور الحالية</label>
                                    <input type="password" id="currentPassword" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>كلمة المرور الجديدة</label>
                                    <input type="password" id="newPassword" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>تأكيد كلمة المرور الجديدة</label>
                                    <input type="password" id="confirmPassword" class="form-control">
                                </div>
                                <button class="btn btn-success" style="width: auto; padding: 12px 40px;" onclick="changePassword()">
                                    <i class="fas fa-save"></i> تغيير كلمة المرور
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- تبويب إعدادات الطباعة -->
                <div class="tab-content" id="printingTab">
                    <div class="search-container">
                        <div class="search-box" style="flex-direction: column; align-items: flex-start; gap: 25px;">
                            <div style="width: 100%;">
                                <h3 style="margin-bottom: 15px;">إعدادات الطباعة</h3>
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="autoPrint" checked> الطباعة التلقائية بعد البيع
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="showPrintOptions" checked> عرض خيارات الطباعة
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="showBarcodeInInvoice"> إظهار الباركود في الفاتورة
                                    </label>
                                </div>
                            </div>
                            
                            <div style="width: 100%;">
                                <h3 style="margin-bottom: 15px;">إعدادات الفواتير</h3>
                                <div class="form-group">
                                    <label>تذييل الفاتورة</label>
                                    <textarea id="invoiceFooter" class="form-control" rows="3" placeholder="النص الذي يظهر في أسفل الفاتورة..."></textarea>
                                </div>
                            </div>
                            
                            <button class="btn" style="width: auto; padding: 12px 40px;" onclick="savePrintSettings()">
                                <i class="fas fa-save"></i> حفظ الإعدادات
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- تبويب إعدادات المنتجات -->
                <div class="tab-content" id="productsTab">
                    <div class="search-container">
                        <div class="search-box" style="flex-direction: column; align-items: flex-start; gap: 25px;">
                            <div style="width: 100%;">
                                <h3 style="margin-bottom: 15px;">إعدادات المنتجات</h3>
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="autoGenerateBarcode" checked> توليد الباركود تلقائياً
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="autoSuggestColors" checked> اقتراح الألوان تلقائياً
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="lowStockAlert"> تنبيه عند انخفاض الكمية
                                    </label>
                                </div>
                            </div>
                            
                            <div style="width: 100%;">
                                <h3 style="margin-bottom: 15px;">كمية التنبيه</h3>
                                <div class="form-group">
                                    <input type="number" id="lowStockThreshold" class="form-control" placeholder="الحد الأدنى للتنبيه" value="10">
                                </div>
                            </div>
                            
                            <button class="btn" style="width: auto; padding: 12px 40px;" onclick="saveProductSettings()">
                                <i class="fas fa-save"></i> حفظ الإعدادات
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- تبويب إعدادات الشركة -->
                <div class="tab-content" id="companyTab">
                    <div class="search-container">
                        <div class="search-box" style="flex-direction: column; align-items: flex-start; gap: 25px;">
                            <div style="width: 100%;">
                                <h3 style="margin-bottom: 15px;">معلومات الشركة</h3>
                                <div class="form-group">
                                    <label>اسم الشركة</label>
                                    <input type="text" id="companyName" class="form-control" placeholder="اسم الشركة">
                                </div>
                                <div class="form-group">
                                    <label>الشعار</label>
                                    <input type="file" id="companyLogo" class="form-control" accept="image/*">
                                    <div id="logoPreview" style="margin-top: 10px;"></div>
                                </div>
                                <div class="form-group">
                                    <label>العنوان</label>
                                    <textarea id="companyAddress" class="form-control" rows="3" placeholder="عنوان الشركة..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label>رقم الهاتف</label>
                                    <input type="text" id="companyPhone" class="form-control" placeholder="رقم هاتف الشركة">
                                </div>
                            </div>
                            
                            <button class="btn" style="width: auto; padding: 12px 40px;" onclick="saveCompanySettings()">
                                <i class="fas fa-save"></i> حفظ معلومات الشركة
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- النسخ الاحتياطي -->
            <section class="section" id="backup">
                <h2 class="section-title"><i class="fas fa-database"></i> النسخ الاحتياطي</h2>
                
                <div class="search-container">
                    <div class="search-box" style="flex-direction: column; align-items: flex-start; gap: 25px;">
                        <div style="width: 100%;">
                            <h3 style="margin-bottom: 15px;">إنشاء نسخة احتياطية</h3>
                            <p style="margin-bottom: 15px; color: #777;">
                                قم بإنشاء نسخة احتياطية من جميع بيانات النظام لحفظها واستعادتها عند الحاجة.
                            </p>
                            <button class="btn btn-success" onclick="createBackup()">
                                <i class="fas fa-download"></i> إنشاء نسخة احتياطية
                            </button>
                        </div>
                        
                        <div style="width: 100%;">
                            <h3 style="margin-bottom: 15px;">استعادة نسخة احتياطية</h3>
                            <div class="form-group">
                                <label>اختر ملف النسخة الاحتياطية</label>
                                <input type="file" id="backupFile" class="form-control" accept=".json">
                            </div>
                            <button class="btn btn-warning" onclick="restoreBackup()">
                                <i class="fas fa-upload"></i> استعادة النسخة الاحتياطية
                            </button>
                        </div>
                        
                        <div style="width: 100%;">
                            <h3 style="margin-bottom: 15px;">النسخ الاحتياطية السابقة</h3>
                            <div class="table-container">
                                <table id="backupsTable">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>اسم الملف</th>
                                            <th>التاريخ</th>
                                            <th>الحجم</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- سيتم ملء النسخ الاحتياطية ديناميكيا -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- النوافذ المنبثقة -->
    
    <!-- نافذة إضافة منتج -->
    <div class="modal" id="addProductModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> إضافة منتج جديد</h3>
                <button class="close-modal" onclick="closeModal('addProductModal')">&times;</button>
            </div>
            <form id="addProductForm">
                <div class="form-group">
                    <label>اسم المنتج *</label>
                    <input type="text" id="productName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>سعر الشراء *</label>
                    <input type="number" id="purchasePrice" class="form-control" required min="0">
                </div>
                
                <div class="form-group">
                    <label>سعر البيع *</label>
                    <input type="number" id="salePrice" class="form-control" required min="0">
                </div>
                
                <div class="form-group">
                    <label>الكمية *</label>
                    <input type="number" id="productQuantity" class="form-control" required min="0">
                </div>
                
                <div class="form-group">
                    <label>النوع</label>
                    <select id="productType" class="form-control">
                        <option value="هواتف">هواتف</option>
                        <option value="أجهزة كمبيوتر">أجهزة كمبيوتر</option>
                        <option value="سماعات">سماعات</option>
                        <option value="ساعات ذكية">ساعات ذكية</option>
                        <option value="كاميرات">كاميرات</option>
                        <option value="تابلت">تابلت</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>اللون</label>
                    <div class="color-suggestions" id="colorSuggestions">
                        <!-- سيتم ملء اقتراحات الألوان ديناميكيا -->
                    </div>
                    <input type="text" id="productColor" class="form-control" placeholder="#000000 (كود HEX)">
                </div>
                
                <div class="form-group">
                    <label>باركود</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="productBarcode" class="form-control" placeholder="باركود المنتج">
                        <button type="button" class="btn btn-info" onclick="generateBarcode()">توليد باركود</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>صورة المنتج (اختياري)</label>
                    <input type="file" id="productImage" class="form-control" accept="image/*">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">إضافة المنتج</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('addProductModal')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة إضافة عميل -->
    <div class="modal" id="addCustomerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> إضافة عميل جديد</h3>
                <button class="close-modal" onclick="closeModal('addCustomerModal')">&times;</button>
            </div>
            <form id="addCustomerForm">
                <div class="form-group">
                    <label>اسم العميل *</label>
                    <input type="text" id="customerName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>رقم الهاتف *</label>
                    <input type="text" id="customerPhone" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>البريد الإلكتروني</label>
                    <input type="email" id="customerEmail" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>العنوان</label>
                    <textarea id="customerAddress" class="form-control" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">إضافة العميل</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('addCustomerModal')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة إضافة مورد -->
    <div class="modal" id="addSupplierModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-truck"></i> إضافة مورد جديد</h3>
                <button class="close-modal" onclick="closeModal('addSupplierModal')">&times;</button>
            </div>
            <form id="addSupplierForm">
                <div class="form-group">
                    <label>اسم المورد *</label>
                    <input type="text" id="supplierName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>رقم الهاتف *</label>
                    <input type="text" id="supplierPhone" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>البريد الإلكتروني</label>
                    <input type="email" id="supplierEmail" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>العنوان</label>
                    <textarea id="supplierAddress" class="form-control" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">إضافة المورد</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('addSupplierModal')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة إضافة عملية شراء -->
    <div class="modal" id="addPurchaseModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-shopping-cart"></i> عملية شراء جديدة</h3>
                <button class="close-modal" onclick="closeModal('addPurchaseModal')">&times;</button>
            </div>
            <form id="addPurchaseForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>المورد *</label>
                        <select id="purchaseSupplier" class="form-control" required>
                            <option value="">اختر مورداً</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>التاريخ *</label>
                        <input type="date" id="purchaseDate" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>طريقة الدفع *</label>
                    <div style="display: flex; gap: 20px;">
                        <label><input type="radio" name="purchasePaymentType" value="cash" checked> نقداً</label>
                        <label><input type="radio" name="purchasePaymentType" value="credit"> بالدين</label>
                    </div>
                </div>
                
                <div class="search-container" style="margin-top: 20px;">
                    <h4>إضافة منتجات للشراء</h4>
                    <div class="search-box">
                        <input type="text" id="purchaseProductSearch" class="search-input" placeholder="ابحث عن منتج..." onkeyup="searchPurchaseProducts()">
                        <button type="button" class="btn" onclick="addProductToPurchase()"><i class="fas fa-plus"></i> إضافة</button>
                    </div>
                </div>
                
                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                    <table id="purchaseItemsTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>المنتج</th>
                                <th>الكمية</th>
                                <th>سعر الشراء</th>
                                <th>الإجمالي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="purchaseItems">
                            <!-- سيتم ملء عناصر الشراء هنا -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 18px; font-weight: bold;">المجموع:</span>
                        <span style="font-size: 20px; font-weight: bold;" id="purchaseTotal">0 د.ع</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ملاحظات</label>
                    <textarea id="purchaseNotes" class="form-control" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">حفظ عملية الشراء</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('addPurchaseModal')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة إضافة دفعة عميل -->
    <div class="modal" id="addCustomerPaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill"></i> إضافة دفعة عميل</h3>
                <button class="close-modal" onclick="closeModal('addCustomerPaymentModal')">&times;</button>
            </div>
            <form id="addCustomerPaymentForm">
                <div class="form-group">
                    <label>العميل *</label>
                    <select id="paymentCustomer" class="form-control" required>
                        <option value="">اختر عميلاً</option>
                    </select>
                    <div id="customerDebtInfo" style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px; display: none;">
                        <span>الديون الحالية: <span id="customerCurrentDebt">0</span> د.ع</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>المبلغ *</label>
                    <input type="number" id="paymentAmount" class="form-control" required min="1">
                </div>
                
                <div class="form-group">
                    <label>التاريخ *</label>
                    <input type="date" id="paymentDate" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>طريقة الدفع</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="نقدي">نقدي</option>
                        <option value="تحويل بنكي">تحويل بنكي</option>
                        <option value="بطاقة ائتمان">بطاقة ائتمان</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ملاحظات</label>
                    <textarea id="paymentNotes" class="form-control" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">حفظ الدفعة</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('addCustomerPaymentModal')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة إضافة مصروف -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> إضافة مصروف</h3>
                <button class="close-modal" onclick="closeModal('addExpenseModal')">&times;</button>
            </div>
            <form id="addExpenseForm">
                <div class="form-group">
                    <label>نوع المصروف *</label>
                    <select id="expenseType" class="form-control" required>
                        <option value="">اختر نوع المصروف</option>
                        <option value="إيجار">إيجار</option>
                        <option value="مرتبات">مرتبات</option>
                        <option value="كهرباء">كهرباء</option>
                        <option value="ماء">ماء</option>
                        <option value="اتصالات">اتصالات</option>
                        <option value="نقل">نقل</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>المبلغ *</label>
                    <input type="number" id="expenseAmount" class="form-control" required min="1">
                </div>
                
                <div class="form-group">
                    <label>التاريخ *</label>
                    <input type="date" id="expenseDate" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>المستلم</label>
                    <input type="text" id="expenseRecipient" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>ملاحظات</label>
                    <textarea id="expenseNotes" class="form-control" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">حفظ المصروف</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('addExpenseModal')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة إضافة مستخدم -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> إضافة مستخدم جديد</h3>
                <button class="close-modal" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label>اسم المستخدم *</label>
                    <input type="text" id="newUsername" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>الاسم الكامل *</label>
                    <input type="text" id="newFullName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>كلمة المرور *</label>
                    <input type="password" id="newUserPassword" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>تأكيد كلمة المرور *</label>
                    <input type="password" id="confirmUserPassword" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>الدور *</label>
                    <select id="userRole" class="form-control" required>
                        <option value="">اختر دوراً</option>
                        <option value="مدير">مدير</option>
                        <option value="موظف">موظف</option>
                        <option value="مشرف">مشرف</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">إضافة المستخدم</button>
                    <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeModal('addUserModal')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة طباعة الفاتورة A4 -->
    <div class="modal" id="printA4Modal">
        <div class="modal-content" style="max-width: 210mm;">
            <div class="modal-header">
                <h3><i class="fas fa-print"></i> طباعة فاتورة A4</h3>
                <button class="close-modal" onclick="closeModal('printA4Modal')">&times;</button>
            </div>
            <div class="invoice-a4" id="a4InvoiceContent">
                <!-- سيتم ملء محتوى الفاتورة ديناميكيا -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="printA4Invoice()"><i class="fas fa-print"></i> طباعة</button>
                <button class="btn btn-danger" onclick="closeModal('printA4Modal')">إغلاق</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة طباعة الباركود -->
    <div class="modal" id="printBarcodeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-barcode"></i> طباعة باركود</h3>
                <button class="close-modal" onclick="closeModal('printBarcodeModal')">&times;</button>
            </div>
            <div class="barcode-container" id="barcodePrintContent">
                <!-- سيتم ملء محتوى الباركود ديناميكيا -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="printBarcodeOnly()"><i class="fas fa-print"></i> طباعة الباركود</button>
                <button class="btn btn-danger" onclick="closeModal('printBarcodeModal')">إغلاق</button>
            </div>
        </div>
    </div>
    
    <!-- نافذة تفاصيل العميل -->
    <div class="modal" id="customerDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> تفاصيل العميل</h3>
                <button class="close-modal" onclick="closeModal('customerDetailsModal')">&times;</button>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="customerInfo">معلومات العميل</div>
                <div class="tab" data-tab="customerInvoices">فواتير العميل</div>
                <div class="tab" data-tab="customerPayments">دفعات العميل</div>
                <div class="tab" data-tab="customerReport">تقرير العميل</div>
            </div>
            
            <div class="tab-content active" id="customerInfoTab">
                <!-- سيتم ملء معلومات العميل ديناميكيا -->
            </div>
            
            <div class="tab-content" id="customerInvoicesTab">
                <!-- سيتم ملء فواتير العميل ديناميكيا -->
            </div>
            
            <div class="tab-content" id="customerPaymentsTab">
                <!-- سيتم ملء دفعات العميل ديناميكيا -->
            </div>
            
            <div class="tab-content" id="customerReportTab">
                <!-- سيتم ملء تقرير العميل ديناميكيا -->
            </div>
        </div>
    </div>
    
    <!-- نافذة تفاصيل المورد -->
    <div class="modal" id="supplierDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-truck"></i> تفاصيل المورد</h3>
                <button class="close-modal" onclick="closeModal('supplierDetailsModal')">&times;</button>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="supplierInfo">معلومات المورد</div>
                <div class="tab" data-tab="supplierPurchases">مشتريات من المورد</div>
                <div class="tab" data-tab="supplierPayments">دفعات للمورد</div>
                <div class="tab" data-tab="supplierReport">تقرير المورد</div>
            </div>
            
            <div class="tab-content active" id="supplierInfoTab">
                <!-- سيتم ملء معلومات المورد ديناميكيا -->
            </div>
            
            <div class="tab-content" id="supplierPurchasesTab">
                <!-- سيتم ملء مشتريات المورد ديناميكيا -->
            </div>
            
            <div class="tab-content" id="supplierPaymentsTab">
                <!-- سيتم ملء دفعات المورد ديناميكيا -->
            </div>
            
            <div class="tab-content" id="supplierReportTab">
                <!-- سيتم ملء تقرير المورد ديناميكيا -->
            </div>
        </div>
    </div>
    
    <!-- نافذة تأكيد الحذف -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content confirmation-modal">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> تأكيد الحذف</h3>
                <button class="close-modal" onclick="closeModal('confirmationModal')">&times;</button>
            </div>
            <div>
                <p id="confirmationMessage">هل أنت متأكد من حذف هذا العنصر؟</p>
                <div class="confirmation-buttons">
                    <button class="btn btn-danger" id="confirmDeleteButton">نعم، احذف</button>
                    <button class="btn btn-secondary" onclick="closeModal('confirmationModal')">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // بيانات النظام
        let systemData = {
            users: [
                { id: 1, username: "admin", password: "farzad1234", fullName: "مدير النظام", role: "مدير", createdAt: "2023-01-01", active: true }
            ],
            products: [
                { id: 1, name: "هاتف سامسونج جالاكسي S23", purchasePrice: 1000000, salePrice: 1250000, quantity: 50, type: "هواتف", color: "#000000", barcode: "123456789012", image: "mobile" },
                { id: 2, name: "لاب توب ديل XPS 13", purchasePrice: 1500000, salePrice: 1850000, quantity: 30, type: "أجهزة كمبيوتر", color: "#808080", barcode: "123456789013", image: "laptop" },
                { id: 3, name: "سماعات سوني WH-1000XM5", purchasePrice: 350000, salePrice: 450000, quantity: 100, type: "سماعات", color: "#000000", barcode: "123456789014", image: "headphones" },
                { id: 4, name: "ساعة أبل ووتش سيريز 8", purchasePrice: 600000, salePrice: 750000, quantity: 40, type: "ساعات ذكية", color: "#FFFFFF", barcode: "123456789015", image: "smartwatch" },
                { id: 5, name: "كاميرا كانون EOS R6", purchasePrice: 2500000, salePrice: 3200000, quantity: 20, type: "كاميرات", color: "#000000", barcode: "123456789016", image: "camera" },
                { id: 6, name: "تابلت سامسونج تاب S8", purchasePrice: 750000, salePrice: 950000, quantity: 60, type: "تابلت", color: "#808080", barcode: "123456789017", image: "tablet" }
            ],
            customers: [
                { id: 1, name: "أحمد محمد", phone: "07701234567", email: "ahmed@example.com", address: "بغداد", totalPurchases: 1250000, debt: 150000, previousDebt: 0, createdAt: "2023-01-15" },
                { id: 2, name: "سارة علي", phone: "07702345678", email: "sara@example.com", address: "البصرة", totalPurchases: 850000, debt: 0, previousDebt: 0, createdAt: "2023-02-20" },
                { id: 3, name: "عمر خالد", phone: "07703456789", email: "omar@example.com", address: "الموصل", totalPurchases: 2100000, debt: 300000, previousDebt: 50000, createdAt: "2023-03-10" }
            ],
            suppliers: [
                { id: 1, name: "شركة الإلكترونيات المتقدمة", phone: "07704567890", email: "info@advanced.com", address: "بغداد", totalPurchases: 5000000, debt: 250000, previousDebt: 0, createdAt: "2023-01-01" },
                { id: 2, name: "مورد الأجهزة الذكية", phone: "07705678901", email: "contact@smartdevices.com", address: "أربيل", totalPurchases: 3200000, debt: 0, previousDebt: 0, createdAt: "2023-02-15" }
            ],
            invoices: [],
            purchases: [],
            customerPayments: [],
            supplierPayments: [],
            expenses: [],
            settings: {
                companyName: "متجر الإلكترونيات",
                companyAddress: "بغداد - المنصور",
                companyPhone: "07700000000",
                autoPrint: true,
                showPrintOptions: true,
                autoGenerateBarcode: true,
                autoSuggestColors: true,
                lowStockAlert: false,
                lowStockThreshold: 10,
                invoiceFooter: "شكراً لتعاملكم معنا"
            },
            colorSuggestions: [
                '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
                '#FFA500', '#800080', '#008080', '#FFC0CB', '#A52A2A', '#808080'
            ]
        };

        // العناصر الرئيسية في DOM
        const loginPage = document.getElementById('loginPage');
        const mainSystem = document.getElementById('mainSystem');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const sections = document.querySelectorAll('.section');
        const cartItems = document.getElementById('cartItems');
        const productsGrid = document.getElementById('productsGrid');
        const printSmall = document.getElementById('printSmall');
        const printA4 = document.getElementById('printA4');
        
        // سلة المشتريات
        let cart = [];
        let currentCustomerId = null;
        let invoiceCounter = 1;
        let purchaseItems = [];
        let currentEditItem = null;
        let deleteCallback = null;

        // تسجيل الدخول
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // التحقق من بيانات الدخول
            const user = systemData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                // إخفاء صفحة تسجيل الدخول وإظهار النظام الرئيسي
                loginPage.style.display = 'none';
                mainSystem.style.display = 'block';
                
                // تحميل بيانات النظام
                loadSystemData();
                showNotification('تم تسجيل الدخول بنجاح!', 'success');
            } else {
                showNotification('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
            }
        });
        
        // تسجيل الخروج
        logoutBtn.addEventListener('click', function() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                mainSystem.style.display = 'none';
                loginPage.style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                cart = [];
                currentCustomerId = null;
                showNotification('تم تسجيل الخروج بنجاح', 'success');
            }
        });
        
        // تبديل القائمة الجانبية على الأجهزة الصغيرة
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
        });
        
        // تبديل بين الأقسام
        sidebarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // إزالة النشاط من جميع الروابط
                sidebarLinks.forEach(l => l.classList.remove('active'));
                
                // إضافة النشاط للرابط المختار
                this.classList.add('active');
                
                // إخفاء جميع الأقسام
                sections.forEach(section => section.classList.remove('active'));
                
                // إظهار القسم المختار
                const sectionId = this.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
                
                // تحديث البيانات عند التبديل بين الأقسام
                if (sectionId === 'dashboard') {
                    updateDashboardStats();
                }
                
                // إغلاق القائمة الجانبية على الأجهزة الصغيرة
                if (window.innerWidth <= 992) {
                    sidebar.classList.remove('active');
                }
            });
        });
        
        // تحميل بيانات النظام
        function loadSystemData() {
            // تحميل المنتجات في قسم المبيعات
            loadProducts();
            
            // تحميل بيانات المخزون
            loadInventory();
            
            // تحميل بيانات العملاء
            loadCustomers();
            
            // تحميل بيانات الموردين
            loadSuppliers();
            
            // تحميل الفواتير
            loadInvoices();
            
            // تحميل المشتريات
            loadPurchases();
            
            // تحميل الدفعات
            loadCustomerPayments();
            
            // تحميل المصروفات
            loadExpenses();
            
            // تحميل المستخدمين
            loadUsers();
            
            // تحميل الصلاحيات
            loadRoles();
            
            // تحميل النسخ الاحتياطية
            loadBackups();
            
            // تحديث إحصائيات لوحة التحكم
            updateDashboardStats();
            
            // إضافة أحداث للتبويبات
            setupTabs();
            
            // إضافة أحداث لخيارات الدفع
            setupPaymentEvents();
            
            // إضافة أحداث للطباعة
            setupPrintEvents();
            
            // إعداد تواريخ افتراضية
            setupDefaultDates();
            
            // تحميل اقتراحات الألوان
            loadColorSuggestions();
            
            // تحميل إعدادات الطباعة
            loadPrintSettings();
        }
        
        // تحميل المنتجات
        function loadProducts() {
            productsGrid.innerHTML = '';
            systemData.products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-img">
                        <i class="fas fa-${product.image}"></i>
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-type" style="font-size: 14px; color: #777; margin-bottom: 10px;">${product.type}</div>
                        <div class="product-price">${product.salePrice.toLocaleString()} د.ع</div>
                        <div style="font-size: 12px; color: #777; margin-bottom: 10px;">المخزون: ${product.quantity}</div>
                        <button class="btn" style="padding: 8px 15px; font-size: 14px;" onclick="addToCart(${product.id})">
                            <i class="fas fa-cart-plus"></i> إضافة للسلة
                        </button>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
        }
        
        // تحميل المخزون
        function loadInventory() {
            const inventoryTable = document.querySelector('#inventoryTable tbody');
            inventoryTable.innerHTML = '';
            systemData.products.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${product.name}</td>
                    <td><i class="fas fa-${product.image}" style="font-size: 24px;"></i></td>
                    <td>${product.quantity}</td>
                    <td>${product.purchasePrice.toLocaleString()} د.ع</td>
                    <td>${product.salePrice.toLocaleString()} د.ع</td>
                    <td>${product.type}</td>
                    <td><div style="width: 20px; height: 20px; background: ${product.color}; border-radius: 50%;"></div></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-edit" onclick="editProduct(${product.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn-small btn-delete" onclick="confirmDelete('product', ${product.id})"><i class="fas fa-trash"></i></button>
                            <button class="btn-small btn-print" onclick="openPrintBarcodeModal(${product.id})"><i class="fas fa-barcode"></i></button>
                        </div>
                    </td>
                `;
                inventoryTable.appendChild(row);
            });
        }
        
        // تحميل العملاء
        function loadCustomers() {
            const customersTable = document.querySelector('#customersTable tbody');
            if (customersTable) {
                customersTable.innerHTML = '';
                systemData.customers.forEach((customer, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.totalPurchases.toLocaleString()} د.ع</td>
                        <td>${customer.debt.toLocaleString()} د.ع</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" onclick="editCustomer(${customer.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn-small btn-delete" onclick="confirmDelete('customer', ${customer.id})"><i class="fas fa-trash"></i></button>
                                <button class="btn-small btn-view" onclick="openCustomerDetailsModal(${customer.id})"><i class="fas fa-eye"></i></button>
                            </div>
                        </td>
                    `;
                    customersTable.appendChild(row);
                });
            }
            
            // تحديث إحصائيات العملاء
            document.getElementById('totalCustomers').textContent = systemData.customers.length;
        }
        
        // تحميل الموردين
        function loadSuppliers() {
            const suppliersTable = document.querySelector('#suppliersTable tbody');
            if (suppliersTable) {
                suppliersTable.innerHTML = '';
                systemData.suppliers.forEach((supplier, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${supplier.name}</td>
                        <td>${supplier.phone}</td>
                        <td>${supplier.email || '-'}</td>
                        <td>${supplier.totalPurchases.toLocaleString()} د.ع</td>
                        <td>${supplier.debt.toLocaleString()} د.ع</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" onclick="editSupplier(${supplier.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn-small btn-delete" onclick="confirmDelete('supplier', ${supplier.id})"><i class="fas fa-trash"></i></button>
                                <button class="btn-small btn-view" onclick="openSupplierDetailsModal(${supplier.id})"><i class="fas fa-eye"></i></button>
                            </div>
                        </td>
                    `;
                    suppliersTable.appendChild(row);
                });
            }
        }
        
        // تحميل الفواتير
        function loadInvoices() {
            const invoicesTable = document.querySelector('#invoicesTable tbody');
            const recentInvoices = document.getElementById('recentInvoices');
            
            if (invoicesTable) {
                invoicesTable.innerHTML = '';
                systemData.invoices.forEach((invoice, index) => {
                    const customer = systemData.customers.find(c => c.id === invoice.customerId) || { name: "زائر" };
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invoice.id}</td>
                        <td>${invoice.date}</td>
                        <td>${customer.name}</td>
                        <td>${invoice.total.toLocaleString()} د.ع</td>
                        <td>${invoice.paymentType === 'cash' ? 'نقداً' : 'بالدين'}</td>
                        <td><span style="padding: 5px 10px; border-radius: 20px; background: #4CAF50; color: white;">مكتمل</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-view" onclick="viewInvoice('${invoice.id}')"><i class="fas fa-eye"></i></button>
                                <button class="btn-small btn-print" onclick="printInvoice('${invoice.id}')"><i class="fas fa-print"></i></button>
                                <button class="btn-small btn-delete" onclick="confirmDelete('invoice', '${invoice.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    invoicesTable.appendChild(row);
                });
            }
            
            // تحديث أحدث الفواتير
            if (recentInvoices) {
                recentInvoices.innerHTML = '';
                const recent = systemData.invoices.slice(-5).reverse();
                recent.forEach(invoice => {
                    const customer = systemData.customers.find(c => c.id === invoice.customerId) || { name: "زائر" };
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invoice.id}</td>
                        <td>${invoice.date}</td>
                        <td>${customer.name}</td>
                        <td>${invoice.total.toLocaleString()} د.ع</td>
                        <td>${invoice.paymentType === 'cash' ? 'نقداً' : 'بالدين'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-view" onclick="viewInvoice('${invoice.id}')"><i class="fas fa-eye"></i></button>
                                <button class="btn-small btn-print" onclick="printInvoice('${invoice.id}')"><i class="fas fa-print"></i></button>
                            </div>
                        </td>
                    `;
                    recentInvoices.appendChild(row);
                });
            }
        }
        
        // تحميل المشتريات
        function loadPurchases() {
            const purchasesTable = document.querySelector('#purchasesTable tbody');
            if (purchasesTable) {
                purchasesTable.innerHTML = '';
                systemData.purchases.forEach((purchase, index) => {
                    const supplier = systemData.suppliers.find(s => s.id === purchase.supplierId) || { name: "غير محدد" };
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${purchase.id}</td>
                        <td>${purchase.date}</td>
                        <td>${supplier.name}</td>
                        <td>${purchase.total.toLocaleString()} د.ع</td>
                        <td>${purchase.paymentType === 'cash' ? 'نقداً' : 'بالدين'}</td>
                        <td><span style="padding: 5px 10px; border-radius: 20px; background: #4CAF50; color: white;">مكتمل</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-view" onclick="viewPurchase('${purchase.id}')"><i class="fas fa-eye"></i></button>
                                <button class="btn-small btn-print" onclick="printPurchase('${purchase.id}')"><i class="fas fa-print"></i></button>
                                <button class="btn-small btn-delete" onclick="confirmDelete('purchase', '${purchase.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    purchasesTable.appendChild(row);
                });
            }
        }
        
        // تحميل دفعات العملاء
        function loadCustomerPayments() {
            const customerPaymentsTable = document.querySelector('#customerPaymentsTable tbody');
            if (customerPaymentsTable) {
                customerPaymentsTable.innerHTML = '';
                systemData.customerPayments.forEach((payment, index) => {
                    const customer = systemData.customers.find(c => c.id === payment.customerId) || { name: "غير معروف" };
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${customer.name}</td>
                        <td>${payment.amount.toLocaleString()} د.ع</td>
                        <td>${payment.date}</td>
                        <td>${payment.method}</td>
                        <td>${payment.notes || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" onclick="editCustomerPayment(${payment.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn-small btn-delete" onclick="confirmDelete('customerPayment', ${payment.id})"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    customerPaymentsTable.appendChild(row);
                });
            }
        }
        
        // تحميل المصروفات
        function loadExpenses() {
            const expensesTable = document.querySelector('#expensesTable tbody');
            if (expensesTable) {
                expensesTable.innerHTML = '';
                systemData.expenses.forEach((expense, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${expense.type}</td>
                        <td>${expense.amount.toLocaleString()} د.ع</td>
                        <td>${expense.date}</td>
                        <td>${expense.recipient || '-'}</td>
                        <td>${expense.notes || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" onclick="editExpense(${expense.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn-small btn-delete" onclick="confirmDelete('expense', ${expense.id})"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    expensesTable.appendChild(row);
                });
            }
        }
        
        // تحميل المستخدمين
        function loadUsers() {
            const usersTable = document.querySelector('#usersTable tbody');
            if (usersTable) {
                usersTable.innerHTML = '';
                systemData.users.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.username}</td>
                        <td>${user.fullName}</td>
                        <td>${user.role}</td>
                        <td>${user.createdAt}</td>
                        <td>${user.active ? '<span style="color: green;">نشط</span>' : '<span style="color: red;">غير نشط</span>'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" onclick="editUser(${user.id})"><i class="fas fa-edit"></i></button>
                                <button class="btn-small btn-delete" onclick="confirmDelete('user', ${user.id})"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    usersTable.appendChild(row);
                });
            }
        }
        
        // تحميل الصلاحيات
        function loadRoles() {
            const rolesTable = document.querySelector('#rolesTable tbody');
            if (rolesTable) {
                rolesTable.innerHTML = '';
                const roles = ['مدير', 'موظف', 'مشرف'];
                roles.forEach((role, index) => {
                    const userCount = systemData.users.filter(u => u.role === role).length;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${role}</td>
                        <td>${userCount}</td>
                        <td>${getRoleDescription(role)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-small btn-edit" onclick="editRole('${role}')"><i class="fas fa-edit"></i></button>
                            </div>
                        </td>
                    `;
                    rolesTable.appendChild(row);
                });
            }
        }
        
        // تحميل النسخ الاحتياطية
        function loadBackups() {
            const backupsTable = document.querySelector('#backupsTable tbody');
            if (backupsTable) {
                backupsTable.innerHTML = '';
                // يمكن إضافة منطق لتحميل النسخ الاحتياطية الفعلية هنا
            }
        }
        
        // تحميل إعدادات الطباعة
        function loadPrintSettings() {
            document.getElementById('autoPrint').checked = systemData.settings.autoPrint;
            document.getElementById('showPrintOptions').checked = systemData.settings.showPrintOptions;
            document.getElementById('autoGenerateBarcode').checked = systemData.settings.autoGenerateBarcode;
            document.getElementById('autoSuggestColors').checked = systemData.settings.autoSuggestColors;
            document.getElementById('lowStockAlert').checked = systemData.settings.lowStockAlert;
            document.getElementById('lowStockThreshold').value = systemData.settings.lowStockThreshold;
            document.getElementById('invoiceFooter').value = systemData.settings.invoiceFooter;
            document.getElementById('companyName').value = systemData.settings.companyName;
            document.getElementById('companyAddress').value = systemData.settings.companyAddress;
            document.getElementById('companyPhone').value = systemData.settings.companyPhone;
        }
        
        // تحميل اقتراحات الألوان
        function loadColorSuggestions() {
            const colorContainer = document.getElementById('colorSuggestions');
            if (colorContainer) {
                colorContainer.innerHTML = '';
                systemData.colorSuggestions.forEach(color => {
                    const colorOption = document.createElement('div');
                    colorOption.className = 'color-option';
                    colorOption.style.backgroundColor = color;
                    colorOption.title = color;
                    colorOption.onclick = function() {
                        document.getElementById('productColor').value = color;
                    };
                    colorContainer.appendChild(colorOption);
                });
            }
        }
        
        // إعداد التبويبات
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    const parent = this.closest('.section') || this.closest('.modal-content');
                    
                    // إزالة النشاط من جميع التبويبات
                    parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    
                    // إضافة النشاط للتبويب المختار
                    this.classList.add('active');
                    
                    // إخفاء جميع محتويات التبويبات
                    parent.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // إظهار محتوى التبويب المختار
                    parent.querySelector(`#${tabId}Tab`).classList.add('active');
                });
            });
        }
        
        // إعداد أحداث الدفع
        function setupPaymentEvents() {
            const paymentRadios = document.querySelectorAll('input[name="paymentType"]');
            paymentRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const creditSection = document.getElementById('creditSection');
                    if (this.value === 'credit') {
                        creditSection.style.display = 'block';
                    } else {
                        creditSection.style.display = 'none';
                    }
                });
            });
        }
        
        // إعداد أحداث الطباعة
        function setupPrintEvents() {
            printSmall.addEventListener('click', function() {
                printSmallInvoice();
            });
            
            printA4.addEventListener('click', function() {
                openPrintA4Modal();
            });
        }
        
        // إعداد التواريخ الافتراضية
        function setupDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('creditDueDate').value = today;
            document.getElementById('reportDate').value = today;
            document.getElementById('purchaseDate').value = today;
            document.getElementById('paymentDate').value = today;
            document.getElementById('expenseDate').value = today;
        }
        
        // البحث عن المنتجات
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const products = document.querySelectorAll('.product-card');
            
            products.forEach(product => {
                const productName = product.querySelector('.product-name').textContent.toLowerCase();
                const productType = product.querySelector('.product-type').textContent.toLowerCase();
                
                if (productName.includes(searchTerm) || productType.includes(searchTerm)) {
                    product.style.display = 'block';
                } else {
                    product.style.display = 'none';
                }
            });
        }
        
        // البحث عن العملاء
        function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const suggestions = document.getElementById('customerSuggestions');
            
            if (searchTerm.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            const filteredCustomers = systemData.customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) || 
                customer.phone.includes(searchTerm)
            );
            
            suggestions.innerHTML = '';
            if (filteredCustomers.length === 0) {
                const suggestion = document.createElement('div');
                suggestion.style.padding = '10px';
                suggestion.style.color = '#777';
                suggestion.innerHTML = 'لا توجد نتائج';
                suggestions.appendChild(suggestion);
            } else {
                filteredCustomers.forEach(customer => {
                    const suggestion = document.createElement('div');
                    suggestion.style.padding = '10px';
                    suggestion.style.cursor = 'pointer';
                    suggestion.style.borderBottom = '1px solid #eee';
                    suggestion.innerHTML = `${customer.name} - ${customer.phone}`;
                    suggestion.onclick = function() {
                        selectCustomer(customer.id);
                        suggestions.style.display = 'none';
                    };
                    suggestions.appendChild(suggestion);
                });
            }
            
            suggestions.style.display = 'block';
        }
        
        // اختيار عميل
        function selectCustomer(customerId) {
            currentCustomerId = customerId;
            const customer = systemData.customers.find(c => c.id === customerId);
            
            if (customer) {
                document.getElementById('customerSearch').value = customer.name;
                document.getElementById('selectedCustomerName').textContent = customer.name;
                document.getElementById('customerPreviousDebt').textContent = customer.debt.toLocaleString();
                document.getElementById('selectedCustomerInfo').style.display = 'block';
            }
        }
        
        // إضافة منتج للسلة
        window.addToCart = function(productId) {
            const product = systemData.products.find(p => p.id === productId);
            if (!product) {
                showNotification('المنتج غير موجود', 'error');
                return;
            }
            
            // التحقق من توفر المنتج
            if (product.quantity <= 0) {
                showNotification('المنتج غير متوفر في المخزون', 'error');
                return;
            }
            
            // التحقق إذا كان المنتج موجود بالفعل في السلة
            const existingItem = cart.find(item => item.productId === productId);
            
            if (existingItem) {
                // التحقق من توفر الكمية
                if (existingItem.quantity + 1 > product.quantity) {
                    showNotification(`الكمية المتاحة: ${product.quantity}`, 'error');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                // إضافة منتج جديد للسلة
                cart.push({
                    productId: productId,
                    name: product.name,
                    price: product.salePrice,
                    quantity: 1,
                    type: product.type
                });
            }
            
            updateCartDisplay();
            updateInvoiceSummary();
            showNotification('تمت إضافة المنتج إلى السلة', 'success');
        };
        
        // تحديث عرض السلة
        function updateCartDisplay() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 30px; color: #777;">
                        السلة فارغة
                    </td>
                `;
                cartItems.appendChild(row);
                return;
            }
            
            cart.forEach((item, index) => {
                const product = systemData.products.find(p => p.id === item.productId);
                const row = document.createElement('tr');
                row.setAttribute('data-product-id', item.productId);
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.price.toLocaleString()} د.ع</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="btn-small" onclick="updateCartQuantity(${item.productId}, -1)" style="padding: 2px 8px;">-</button>
                            <span>${item.quantity}</span>
                            <button class="btn-small" onclick="updateCartQuantity(${item.productId}, 1)" style="padding: 2px 8px;">+</button>
                        </div>
                    </td>
                    <td>${(item.price * item.quantity).toLocaleString()} د.ع</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-edit" onclick="editCartItem(${item.productId})"><i class="fas fa-edit"></i></button>
                            <button class="btn-small btn-delete" onclick="removeFromCart(${item.productId})"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                cartItems.appendChild(row);
            });
        }
        
        // تحديث كمية المنتج في السلة
        window.updateCartQuantity = function(productId, change) {
            const item = cart.find(item => item.productId === productId);
            if (!item) return;
            
            const product = systemData.products.find(p => p.id === productId);
            
            if (item.quantity + change <= 0) {
                removeFromCart(productId);
            } else if (item.quantity + change > product.quantity) {
                showNotification(`الكمية المتاحة في المخزون: ${product.quantity}`, 'error');
            } else {
                item.quantity += change;
                updateCartDisplay();
                updateInvoiceSummary();
            }
        };
        
        // تعديل عنصر في السلة
        window.editCartItem = function(productId) {
            const item = cart.find(item => item.productId === productId);
            if (!item) return;
            
            const newQuantity = prompt('أدخل الكمية الجديدة:', item.quantity);
            
            if (newQuantity && !isNaN(newQuantity) && newQuantity > 0) {
                const product = systemData.products.find(p => p.id === productId);
                
                if (parseInt(newQuantity) > product.quantity) {
                    showNotification(`الكمية المتاحة في المخزون: ${product.quantity}`, 'error');
                } else {
                    item.quantity = parseInt(newQuantity);
                    updateCartDisplay();
                    updateInvoiceSummary();
                }
            }
        };
        
        // إزالة منتج من السلة
        window.removeFromCart = function(productId) {
            cart = cart.filter(item => item.productId !== productId);
            updateCartDisplay();
            updateInvoiceSummary();
            showNotification('تمت إزالة المنتج من السلة', 'success');
        };
        
        // تفريغ السلة
        window.clearCart = function() {
            if (cart.length === 0) {
                showNotification('السلة فارغة بالفعل', 'warning');
                return;
            }
            
            if (confirm('هل أنت متأكد من تفريغ السلة؟')) {
                cart = [];
                updateCartDisplay();
                updateInvoiceSummary();
                currentCustomerId = null;
                document.getElementById('customerSearch').value = '';
                document.getElementById('selectedCustomerInfo').style.display = 'none';
                document.getElementById('discountInput').value = '';
                showNotification('تم تفريغ السلة بنجاح', 'success');
            }
        };
        
        // تحديث ملخص الفاتورة
        function updateInvoiceSummary() {
            let subtotal = 0;
            
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            
            const discount = parseFloat(document.getElementById('discountInput').value) || 0;
            const tax = subtotal * 0.05; // 5% ضريبة
            
            const total = subtotal - discount + tax;
            
            document.getElementById('subtotal').textContent = subtotal.toLocaleString() + ' د.ع';
            document.getElementById('discount').textContent = discount.toLocaleString() + ' د.ع';
            document.getElementById('tax').textContent = tax.toLocaleString() + ' د.ع';
            document.getElementById('totalAmount').textContent = total.toLocaleString() + ' د.ع';
        }
        
        // تطبيق خصم
        window.applyDiscount = function(percentage) {
            if (cart.length === 0) {
                showNotification('السلة فارغة', 'error');
                return;
            }
            
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            
            const discount = subtotal * (percentage / 100);
            document.getElementById('discountInput').value = Math.round(discount);
            updateInvoiceSummary();
        };
        
        // تحديث الخصم
        window.updateDiscount = function() {
            updateInvoiceSummary();
        };
        
        // إتمام عملية البيع
        window.completeSale = function() {
            if (cart.length === 0) {
                showNotification('السلة فارغة. الرجاء إضافة منتجات قبل إتمام البيع.', 'error');
                return;
            }
            
            const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
            const discount = parseFloat(document.getElementById('discountInput').value) || 0;
            
            // حساب الإجمالي
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            
            const tax = subtotal * 0.05;
            const total = subtotal - discount + tax;
            
            // التحقق من توفر الكميات
            for (const item of cart) {
                const product = systemData.products.find(p => p.id === item.productId);
                if (!product || product.quantity < item.quantity) {
                    showNotification(`الكمية غير متوفرة للمنتج: ${item.name}`, 'error');
                    return;
                }
            }
            
            // إنشاء فاتورة
            const invoiceId = `INV-${Date.now()}`;
            const invoice = {
                id: invoiceId,
                date: new Date().toLocaleDateString('ar-EG'),
                time: new Date().toLocaleTimeString('ar-EG'),
                customerId: currentCustomerId,
                items: [...cart.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                }))],
                subtotal: subtotal,
                discount: discount,
                tax: tax,
                total: total,
                paymentType: paymentType,
                status: 'مكتمل'
            };
            
            // تحديث المخزون
            cart.forEach(item => {
                const product = systemData.products.find(p => p.id === item.productId);
                if (product) {
                    product.quantity -= item.quantity;
                }
            });
            
            // تحديث بيانات العميل إذا كان هناك دين
            if (paymentType === 'credit' && currentCustomerId) {
                const customer = systemData.customers.find(c => c.id === currentCustomerId);
                if (customer) {
                    customer.debt += total;
                    customer.totalPurchases += total;
                }
            } else if (currentCustomerId) {
                // تحديث إجمالي المشتريات للعميل
                const customer = systemData.customers.find(c => c.id === currentCustomerId);
                if (customer) {
                    customer.totalPurchases += total;
                }
            }
            
            // إضافة الفاتورة إلى النظام
            systemData.invoices.push(invoice);
            
            // حفظ البيانات
            saveSystemData();
            
            // طباعة الفاتورة إذا كان الإعداد مفعلاً
            if (systemData.settings.autoPrint) {
                printSmallInvoice();
            } else if (systemData.settings.showPrintOptions) {
                showNotification('تم إتمام البيع بنجاح. الرجاء اختيار خيار الطباعة.', 'success');
            } else {
                showNotification('تم إتمام البيع بنجاح!', 'success');
            }
            
            // إعادة تعيين السلة
            cart = [];
            updateCartDisplay();
            updateInvoiceSummary();
            currentCustomerId = null;
            document.getElementById('customerSearch').value = '';
            document.getElementById('selectedCustomerInfo').style.display = 'none';
            document.getElementById('discountInput').value = '';
            
            // تحديث العرض
            loadInventory();
            loadCustomers();
            loadInvoices();
            updateDashboardStats();
        };
        
        // طباعة فاتورة صغيرة
        function printSmallInvoice() {
            if (cart.length === 0) {
                showNotification('لا توجد فاتورة للطباعة', 'error');
                return;
            }
            
            // حساب الإجمالي
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity;
            });
            
            const discount = parseFloat(document.getElementById('discountInput').value) || 0;
            const tax = subtotal * 0.05;
            const total = subtotal - discount + tax;
            
            const customer = currentCustomerId ? systemData.customers.find(c => c.id === currentCustomerId) : null;
            
            const printContent = `
                <div class="small-invoice">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3>${systemData.settings.companyName}</h3>
                        <p>${systemData.settings.companyAddress}</p>
                        <p>${systemData.settings.companyPhone}</p>
                        <hr style="margin: 10px 0;">
                    </div>
                    
                    <div style="border-bottom: 1px dashed #000; margin-bottom: 15px; padding-bottom: 10px;">
                        <p><strong>رقم الفاتورة:</strong> INV-${Date.now()}</p>
                        <p><strong>التاريخ:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
                        <p><strong>الوقت:</strong> ${new Date().toLocaleTimeString('ar-EG')}</p>
                    </div>
                    
                    <table style="width: 100%; margin-bottom: 15px; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="text-align: right; border-bottom: 1px solid #000; padding: 5px;">المنتج</th>
                                <th style="text-align: center; border-bottom: 1px solid #000; padding: 5px;">الكمية</th>
                                <th style="text-align: left; border-bottom: 1px solid #000; padding: 5px;">السعر</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cart.map(item => `
                                <tr>
                                    <td style="text-align: right; padding: 5px;">${item.name}</td>
                                    <td style="text-align: center; padding: 5px;">${item.quantity}</td>
                                    <td style="text-align: left; padding: 5px;">${item.price.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="border-top: 1px dashed #000; padding-top: 10px; margin-bottom: 15px; font-size: 12px;">
                        ${customer ? `<p><strong>العميل:</strong> ${customer.name}</p>` : ''}
                        <p><strong>الإجمالي:</strong> ${total.toLocaleString()} د.ع</p>
                        <p><strong>طريقة الدفع:</strong> ${document.querySelector('input[name="paymentType"]:checked').value === 'cash' ? 'نقداً' : 'بالدين'}</p>
                    </div>
                    
                    <div style="text-align: center; font-size: 11px; color: #777;">
                        <p>${systemData.settings.invoiceFooter}</p>
                        <p>شكراً لتعاملكم معنا</p>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>طباعة الفاتورة</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                direction: rtl; 
                                margin: 0;
                                padding: 10px;
                            }
                            @media print {
                                body { margin: 0; padding: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // فتح نافذة طباعة A4
        function openPrintA4Modal() {
            if (cart.length === 0) {
                showNotification('لا توجد فاتورة للطباعة', 'error');
                return;
            }
            
            const customer = currentCustomerId ? systemData.customers.find(c => c.id === currentCustomerId) : null;
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discount = parseFloat(document.getElementById('discountInput').value) || 0;
            const tax = subtotal * 0.05;
            const total = subtotal - discount + tax;
            const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
            
            const invoiceContent = document.getElementById('a4InvoiceContent');
            invoiceContent.innerHTML = `
                <div class="invoice-header">
                    <div>
                        <h2>${systemData.settings.companyName}</h2>
                        <p>${systemData.settings.companyAddress}</p>
                        <p>${systemData.settings.companyPhone}</p>
                    </div>
                    <div class="invoice-logo">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                    <div>
                        <h3>فاتورة بيع</h3>
                        <p><strong>رقم الفاتورة:</strong> INV-${Date.now()}</p>
                        <p><strong>التاريخ:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
                        <p><strong>الوقت:</strong> ${new Date().toLocaleTimeString('ar-EG')}</p>
                    </div>
                    <div>
                        ${customer ? `
                            <h3>معلومات العميل</h3>
                            <p><strong>الاسم:</strong> ${customer.name}</p>
                            <p><strong>الهاتف:</strong> ${customer.phone}</p>
                            ${customer.email ? `<p><strong>البريد:</strong> ${customer.email}</p>` : ''}
                            <p><strong>الديون السابقة:</strong> ${customer.debt.toLocaleString()} د.ع</p>
                        ` : '<h3>زبون نقدي</h3>'}
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">#</th>
                            <th style="padding: 10px; text-align: right; border: 1px solid #ddd;">المنتج</th>
                            <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">الكمية</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">السعر</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cart.map((item, index) => `
                            <tr>
                                <td style="padding: 10px; border: 1px solid #ddd;">${index + 1}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${item.name}</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">${item.quantity}</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${item.price.toLocaleString()} د.ع</td>
                                <td style="padding: 10px; border: 1px solid #ddd;">${(item.price * item.quantity).toLocaleString()} د.ع</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
                    <div style="flex: 1;"></div>
                    <div style="flex: 1;">
                        <div style="background: #f9f9f9; padding: 20px; border-radius: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>إجمالي المنتجات:</span>
                                <span>${subtotal.toLocaleString()} د.ع</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>الخصم:</span>
                                <span>${discount.toLocaleString()} د.ع</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>الضريبة (5%):</span>
                                <span>${tax.toLocaleString()} د.ع</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-top: 10px; border-top: 2px solid #ddd; font-size: 18px; font-weight: bold;">
                                <span>الإجمالي النهائي:</span>
                                <span>${total.toLocaleString()} د.ع</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="border-top: 2px solid #eee; padding-top: 20px; margin-top: 40px;">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <p><strong>طريقة الدفع:</strong> ${paymentType === 'cash' ? 'نقداً' : 'بالدين'}</p>
                            ${customer && paymentType === 'credit' ? `
                                <p><strong>الديون الجديدة:</strong> ${total.toLocaleString()} د.ع</p>
                                <p><strong>إجمالي الديون:</strong> ${(customer.debt + total).toLocaleString()} د.ع</p>
                            ` : ''}
                        </div>
                        <div style="text-align: left;">
                            <p>التوقيع: ________________</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; color: #777; font-size: 14px;">
                        <p>${systemData.settings.invoiceFooter}</p>
                        <p>شكراً لتعاملكم معنا</p>
                    </div>
                </div>
            `;
            
            openModal('printA4Modal');
        }
        
        // طباعة فاتورة A4
        function printA4Invoice() {
            const printContent = document.getElementById('a4InvoiceContent').innerHTML;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>طباعة فاتورة A4</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                direction: rtl; 
                                margin: 0;
                                padding: 0;
                            }
                            @page {
                                size: A4;
                                margin: 20mm;
                            }
                            @media print {
                                body { margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // فتح نافذة إضافة منتج
        window.openAddProductModal = function() {
            document.getElementById('addProductForm').reset();
            document.getElementById('productColor').value = '#000000';
            currentEditItem = null;
            
            // توليد باركود تلقائياً إذا كان الإعداد مفعلاً
            if (systemData.settings.autoGenerateBarcode) {
                generateBarcode();
            }
            
            // تغيير النص على الزر
            const submitBtn = document.querySelector('#addProductForm button[type="submit"]');
            submitBtn.textContent = 'إضافة المنتج';
            submitBtn.onclick = null;
            
            openModal('addProductModal');
        };
        
        // توليد باركود
        window.generateBarcode = function() {
            const barcode = Math.floor(100000000000 + Math.random() * 900000000000).toString();
            document.getElementById('productBarcode').value = barcode;
        };
        
        // إضافة منتج جديد
        document.getElementById('addProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productName = document.getElementById('productName').value.trim();
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            const salePrice = parseFloat(document.getElementById('salePrice').value);
            const quantity = parseInt(document.getElementById('productQuantity').value);
            const type = document.getElementById('productType').value;
            const color = document.getElementById('productColor').value || '#000000';
            const barcode = document.getElementById('productBarcode').value.trim();
            
            // التحقق من صحة البيانات
            if (!productName || purchasePrice <= 0 || salePrice <= 0 || quantity < 0) {
                showNotification('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح', 'error');
                return;
            }
            
            if (salePrice < purchasePrice) {
                showNotification('سعر البيع يجب أن يكون أكبر من أو يساوي سعر الشراء', 'error');
                return;
            }
            
            if (currentEditItem) {
                // تحديث المنتج الموجود
                const productIndex = systemData.products.findIndex(p => p.id === currentEditItem);
                if (productIndex !== -1) {
                    systemData.products[productIndex] = {
                        ...systemData.products[productIndex],
                        name: productName,
                        purchasePrice: purchasePrice,
                        salePrice: salePrice,
                        quantity: quantity,
                        type: type,
                        color: color,
                        barcode: barcode || systemData.products[productIndex].barcode
                    };
                    showNotification('تم تحديث المنتج بنجاح!', 'success');
                }
            } else {
                // إضافة منتج جديد
                const newProduct = {
                    id: systemData.products.length > 0 ? Math.max(...systemData.products.map(p => p.id)) + 1 : 1,
                    name: productName,
                    purchasePrice: purchasePrice,
                    salePrice: salePrice,
                    quantity: quantity,
                    type: type,
                    color: color,
                    barcode: barcode || Math.floor(100000000000 + Math.random() * 900000000000).toString(),
                    image: 'box'
                };
                
                // إضافة اللون الجديد إلى الاقتراحات إذا لم يكن موجوداً
                if (color && !systemData.colorSuggestions.includes(color)) {
                    systemData.colorSuggestions.push(color);
                }
                
                systemData.products.push(newProduct);
                showNotification('تم إضافة المنتج بنجاح!', 'success');
            }
            
            saveSystemData();
            
            // تحديث العرض
            loadProducts();
            loadInventory();
            loadColorSuggestions();
            updateDashboardStats();
            
            closeModal('addProductModal');
        });
        
        // تعديل منتج
        window.editProduct = function(productId) {
            const product = systemData.products.find(p => p.id === productId);
            if (!product) {
                showNotification('المنتج غير موجود', 'error');
                return;
            }
            
            currentEditItem = productId;
            
            // تعبئة البيانات في النموذج
            document.getElementById('productName').value = product.name;
            document.getElementById('purchasePrice').value = product.purchasePrice;
            document.getElementById('salePrice').value = product.salePrice;
            document.getElementById('productQuantity').value = product.quantity;
            document.getElementById('productType').value = product.type;
            document.getElementById('productColor').value = product.color;
            document.getElementById('productBarcode').value = product.barcode;
            
            // تغيير النص على الزر
            const submitBtn = document.querySelector('#addProductForm button[type="submit"]');
            submitBtn.textContent = 'تحديث المنتج';
            
            openModal('addProductModal');
        };
        
        // حذف منتج
        function deleteProduct(productId) {
            const productIndex = systemData.products.findIndex(p => p.id === productId);
            if (productIndex === -1) return;
            
            systemData.products.splice(productIndex, 1);
            saveSystemData();
            
            loadProducts();
            loadInventory();
            updateDashboardStats();
            showNotification('تم حذف المنتج بنجاح!', 'success');
        };
        
        // فتح نافذة طباعة الباركود
        window.openPrintBarcodeModal = function(productId) {
            const product = systemData.products.find(p => p.id === productId);
            if (!product) {
                showNotification('المنتج غير موجود', 'error');
                return;
            }
            
            const barcodeContent = document.getElementById('barcodePrintContent');
            barcodeContent.innerHTML = `
                <h3>${product.name}</h3>
                <p>النوع: ${product.type}</p>
                <p>السعر: ${product.salePrice.toLocaleString()} د.ع</p>
                <div class="barcode">
                    ${product.barcode}
                </div>
                <p>باركود: ${product.barcode}</p>
            `;
            
            openModal('printBarcodeModal');
        };
        
        // طباعة الباركود فقط
        function printBarcodeOnly() {
            const printContent = document.getElementById('barcodePrintContent').innerHTML;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>طباعة الباركود</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                direction: rtl; 
                                text-align: center;
                                margin: 0;
                                padding: 20px;
                            }
                            .barcode {
                                font-family: monospace;
                                font-size: 24px;
                                letter-spacing: 2px;
                                padding: 20px;
                                border: 1px solid #000;
                                margin: 20px auto;
                                width: 300px;
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        };
        
        // فتح نافذة إضافة عميل
        window.openAddCustomerModal = function() {
            document.getElementById('addCustomerForm').reset();
            currentEditItem = null;
            
            // تغيير النص على الزر
            const submitBtn = document.querySelector('#addCustomerForm button[type="submit"]');
            submitBtn.textContent = 'إضافة العميل';
            submitBtn.onclick = null;
            
            openModal('addCustomerModal');
        };
        
        // إضافة عميل جديد
        document.getElementById('addCustomerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            const customerAddress = document.getElementById('customerAddress').value.trim();
            
            // التحقق من صحة البيانات
            if (!customerName || !customerPhone) {
                showNotification('الرجاء إدخال الاسم ورقم الهاتف', 'error');
                return;
            }
            
            // التحقق من عدم تكرار رقم الهاتف
            const existingCustomer = systemData.customers.find(c => c.phone === customerPhone);
            if (existingCustomer && !currentEditItem) {
                showNotification('رقم الهاتف مسجل مسبقاً', 'error');
                return;
            }
            
            if (currentEditItem) {
                // تحديث العميل الموجود
                const customerIndex = systemData.customers.findIndex(c => c.id === currentEditItem);
                if (customerIndex !== -1) {
                    systemData.customers[customerIndex] = {
                        ...systemData.customers[customerIndex],
                        name: customerName,
                        phone: customerPhone,
                        email: customerEmail || systemData.customers[customerIndex].email,
                        address: customerAddress || systemData.customers[customerIndex].address
                    };
                    showNotification('تم تحديث بيانات العميل بنجاح!', 'success');
                }
            } else {
                // إضافة عميل جديد
                const newCustomer = {
                    id: systemData.customers.length > 0 ? Math.max(...systemData.customers.map(c => c.id)) + 1 : 1,
                    name: customerName,
                    phone: customerPhone,
                    email: customerEmail || '',
                    address: customerAddress || '',
                    totalPurchases: 0,
                    debt: 0,
                    previousDebt: 0,
                    createdAt: new Date().toISOString().split('T')[0]
                };
                
                systemData.customers.push(newCustomer);
                showNotification('تم إضافة العميل بنجاح!', 'success');
            }
            
            saveSystemData();
            
            // تحديث العرض
            loadCustomers();
            updateDashboardStats();
            
            closeModal('addCustomerModal');
        });
        
        // تعديل عميل
        window.editCustomer = function(customerId) {
            const customer = systemData.customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('العميل غير موجود', 'error');
                return;
            }
            
            currentEditItem = customerId;
            
            // تعبئة البيانات في النموذج
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerAddress').value = customer.address || '';
            
            // تغيير النص على الزر
            const submitBtn = document.querySelector('#addCustomerForm button[type="submit"]');
            submitBtn.textContent = 'تحديث بيانات العميل';
            
            openModal('addCustomerModal');
        };
        
        // حذف عميل
        function deleteCustomer(customerId) {
            const customerIndex = systemData.customers.findIndex(c => c.id === customerId);
            if (customerIndex === -1) return;
            
            // التحقق من وجود ديون
            const customer = systemData.customers[customerIndex];
            if (customer.debt > 0) {
                showNotification('لا يمكن حذف عميل لديه ديون', 'error');
                return;
            }
            
            systemData.customers.splice(customerIndex, 1);
            saveSystemData();
            
            loadCustomers();
            updateDashboardStats();
            showNotification('تم حذف العميل بنجاح!', 'success');
        };
        
        // فتح نافذة إضافة مورد
        window.openAddSupplierModal = function() {
            document.getElementById('addSupplierForm').reset();
            currentEditItem = null;
            
            // تغيير النص على الزر
            const submitBtn = document.querySelector('#addSupplierForm button[type="submit"]');
            submitBtn.textContent = 'إضافة المورد';
            submitBtn.onclick = null;
            
            openModal('addSupplierModal');
        };
        
        // إضافة مورد جديد
        document.getElementById('addSupplierForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const supplierName = document.getElementById('supplierName').value.trim();
            const supplierPhone = document.getElementById('supplierPhone').value.trim();
            const supplierEmail = document.getElementById('supplierEmail').value.trim();
            const supplierAddress = document.getElementById('supplierAddress').value.trim();
            
            // التحقق من صحة البيانات
            if (!supplierName || !supplierPhone) {
                showNotification('الرجاء إدخال الاسم ورقم الهاتف', 'error');
                return;
            }
            
            // التحقق من عدم تكرار رقم الهاتف
            const existingSupplier = systemData.suppliers.find(s => s.phone === supplierPhone);
            if (existingSupplier && !currentEditItem) {
                showNotification('رقم الهاتف مسجل مسبقاً', 'error');
                return;
            }
            
            if (currentEditItem) {
                // تحديث المورد الموجود
                const supplierIndex = systemData.suppliers.findIndex(s => s.id === currentEditItem);
                if (supplierIndex !== -1) {
                    systemData.suppliers[supplierIndex] = {
                        ...systemData.suppliers[supplierIndex],
                        name: supplierName,
                        phone: supplierPhone,
                        email: supplierEmail || systemData.suppliers[supplierIndex].email,
                        address: supplierAddress || systemData.suppliers[supplierIndex].address
                    };
                    showNotification('تم تحديث بيانات المورد بنجاح!', 'success');
                }
            } else {
                // إضافة مورد جديد
                const newSupplier = {
                    id: systemData.suppliers.length > 0 ? Math.max(...systemData.suppliers.map(s => s.id)) + 1 : 1,
                    name: supplierName,
                    phone: supplierPhone,
                    email: supplierEmail || '',
                    address: supplierAddress || '',
                    totalPurchases: 0,
                    debt: 0,
                    previousDebt: 0,
                    createdAt: new Date().toISOString().split('T')[0]
                };
                
                systemData.suppliers.push(newSupplier);
                showNotification('تم إضافة المورد بنجاح!', 'success');
            }
            
            saveSystemData();
            
            // تحديث العرض
            loadSuppliers();
            
            closeModal('addSupplierModal');
        };
        
        // تعديل مورد
        window.editSupplier = function(supplierId) {
            const supplier = systemData.suppliers.find(s => s.id === supplierId);
            if (!supplier) {
                showNotification('المورد غير موجود', 'error');
                return;
            }
            
            currentEditItem = supplierId;
            
            // تعبئة البيانات في النموذج
            document.getElementById('supplierName').value = supplier.name;
            document.getElementById('supplierPhone').value = supplier.phone;
            document.getElementById('supplierEmail').value = supplier.email || '';
            document.getElementById('supplierAddress').value = supplier.address || '';
            
            // تغيير النص على الزر
            const submitBtn = document.querySelector('#addSupplierForm button[type="submit"]');
            submitBtn.textContent = 'تحديث بيانات المورد';
            
            openModal('addSupplierModal');
        };
        
        // حذف مورد
        function deleteSupplier(supplierId) {
            const supplierIndex = systemData.suppliers.findIndex(s => s.id === supplierId);
            if (supplierIndex === -1) return;
            
            // التحقق من وجود ديون
            const supplier = systemData.suppliers[supplierIndex];
            if (supplier.debt > 0) {
                showNotification('لا يمكن حذف مورد لديه ديون', 'error');
                return;
            }
            
            systemData.suppliers.splice(supplierIndex, 1);
            saveSystemData();
            
            loadSuppliers();
            showNotification('تم حذف المورد بنجاح!', 'success');
        };
        
        // فتح نافذة إضافة عملية شراء
        window.openAddPurchaseModal = function() {
            document.getElementById('addPurchaseForm').reset();
            purchaseItems = [];
            currentEditItem = null;
            
            // تعبئة قائمة الموردين
            const supplierSelect = document.getElementById('purchaseSupplier');
            supplierSelect.innerHTML = '<option value="">اختر مورداً</option>';
            systemData.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                supplierSelect.appendChild(option);
            });
            
            // تحديث قائمة العناصر
            updatePurchaseItemsDisplay();
            
            // إعداد تاريخ اليوم
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            
            openModal('addPurchaseModal');
        };
        
        // البحث عن منتجات للشراء
        function searchPurchaseProducts() {
            const searchTerm = document.getElementById('purchaseProductSearch').value.toLowerCase();
            const suggestions = document.getElementById('purchaseProductSuggestions');
            
            // يمكن تطوير هذه الوظيفة لتعرض قائمة منسدلة
            console.log('بحث عن منتج:', searchTerm);
        };
        
        // إضافة منتج لعملية الشراء
        function addProductToPurchase() {
            const searchTerm = document.getElementById('purchaseProductSearch').value.trim();
            if (!searchTerm) {
                showNotification('الرجاء إدخال اسم المنتج', 'error');
                return;
            }
            
            // البحث عن المنتج
            const product = systemData.products.find(p => 
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                p.barcode === searchTerm
            );
            
            if (!product) {
                showNotification('المنتج غير موجود', 'error');
                return;
            }
            
            // التحقق إذا كان المنتج موجود بالفعل في قائمة الشراء
            const existingItem = purchaseItems.find(item => item.productId === product.id);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                purchaseItems.push({
                    productId: product.id,
                    name: product.name,
                    purchasePrice: product.purchasePrice,
                    quantity: 1
                });
            }
            
            updatePurchaseItemsDisplay();
            document.getElementById('purchaseProductSearch').value = '';
            showNotification('تمت إضافة المنتج', 'success');
        };
        
        // تحديث عرض عناصر الشراء
        function updatePurchaseItemsDisplay() {
            const purchaseItemsBody = document.getElementById('purchaseItems');
            purchaseItemsBody.innerHTML = '';
            
            if (purchaseItems.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 20px; color: #777;">
                        لا توجد منتجات مضافة
                    </td>
                `;
                purchaseItemsBody.appendChild(row);
                updatePurchaseTotal();
                return;
            }
            
            purchaseItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>
                        <input type="number" value="${item.quantity}" min="1" 
                               style="width: 60px; padding: 5px; text-align: center;"
                               onchange="updatePurchaseItemQuantity(${index}, this.value)">
                    </td>
                    <td>
                        <input type="number" value="${item.purchasePrice}" min="1" 
                               style="width: 100px; padding: 5px; text-align: center;"
                               onchange="updatePurchaseItemPrice(${index}, this.value)">
                    </td>
                    <td>${(item.purchasePrice * item.quantity).toLocaleString()} د.ع</td>
                    <td>
                        <button class="btn-small btn-delete" onclick="removePurchaseItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                purchaseItemsBody.appendChild(row);
            });
            
            updatePurchaseTotal();
        };
        
        // تحديث كمية عنصر الشراء
        window.updatePurchaseItemQuantity = function(index, quantity) {
            const qty = parseInt(quantity);
            if (qty > 0) {
                purchaseItems[index].quantity = qty;
                updatePurchaseItemsDisplay();
            }
        };
        
        // تحديث سعر عنصر الشراء
        window.updatePurchaseItemPrice = function(index, price) {
            const prc = parseFloat(price);
            if (prc > 0) {
                purchaseItems[index].purchasePrice = prc;
                updatePurchaseItemsDisplay();
            }
        };
        
        // إزالة عنصر من الشراء
        window.removePurchaseItem = function(index) {
            purchaseItems.splice(index, 1);
            updatePurchaseItemsDisplay();
            showNotification('تمت إزالة المنتج', 'success');
        };
        
        // تحديث إجمالي عملية الشراء
        function updatePurchaseTotal() {
            let total = 0;
            purchaseItems.forEach(item => {
                total += item.purchasePrice * item.quantity;
            });
            
            document.getElementById('purchaseTotal').textContent = total.toLocaleString() + ' د.ع';
        };
        
        // حفظ عملية الشراء
        document.getElementById('addPurchaseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const supplierId = parseInt(document.getElementById('purchaseSupplier').value);
            const purchaseDate = document.getElementById('purchaseDate').value;
            const paymentType = document.querySelector('input[name="purchasePaymentType"]:checked').value;
            const notes = document.getElementById('purchaseNotes').value;
            
            // التحقق من صحة البيانات
            if (!supplierId) {
                showNotification('الرجاء اختيار مورد', 'error');
                return;
            }
            
            if (purchaseItems.length === 0) {
                showNotification('الرجاء إضافة منتجات للشراء', 'error');
                return;
            }
            
            if (!purchaseDate) {
                showNotification('الرجاء إدخال تاريخ الشراء', 'error');
                return;
            }
            
            // حساب الإجمالي
            let total = 0;
            purchaseItems.forEach(item => {
                total += item.purchasePrice * item.quantity;
            });
            
            // إنشاء عملية شراء
            const purchaseId = `PUR-${Date.now()}`;
            const purchase = {
                id: purchaseId,
                supplierId: supplierId,
                date: purchaseDate,
                items: purchaseItems.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    purchasePrice: item.purchasePrice,
                    quantity: item.quantity
                })),
                total: total,
                paymentType: paymentType,
                notes: notes,
                status: 'مكتمل'
            };
            
            // تحديث المخزون
            purchaseItems.forEach(item => {
                const product = systemData.products.find(p => p.id === item.productId);
                if (product) {
                    product.quantity += item.quantity;
                }
            });
            
            // تحديث بيانات المورد إذا كان هناك دين
            if (paymentType === 'credit') {
                const supplier = systemData.suppliers.find(s => s.id === supplierId);
                if (supplier) {
                    supplier.debt += total;
                    supplier.totalPurchases += total;
                }
            } else {
                // تحديث إجمالي المشتريات من المورد
                const supplier = systemData.suppliers.find(s => s.id === supplierId);
                if (supplier) {
                    supplier.totalPurchases += total;
                }
            }
            
            // إضافة عملية الشراء إلى النظام
            systemData.purchases.push(purchase);
            
            saveSystemData();
            
            showNotification('تم حفظ عملية الشراء بنجاح!', 'success');
            
            // إغلاق النافذة وإعادة التحميل
            closeModal('addPurchaseModal');
            loadPurchases();
            loadInventory();
            loadSuppliers();
            updateDashboardStats();
        };
        
        // فتح نافذة إضافة دفعة عميل
        window.openAddCustomerPaymentModal = function() {
            document.getElementById('addCustomerPaymentForm').reset();
            currentEditItem = null;
            
            // تعبئة قائمة العملاء
            const customerSelect = document.getElementById('paymentCustomer');
            customerSelect.innerHTML = '<option value="">اختر عميلاً</option>';
            systemData.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} - ${customer.debt.toLocaleString()} د.ع`;
                customerSelect.appendChild(option);
            });
            
            // إعداد تاريخ اليوم
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            
            // إضافة حدث لتحديث معلومات الديون عند اختيار عميل
            customerSelect.addEventListener('change', function() {
                const customerId = parseInt(this.value);
                const customer = systemData.customers.find(c => c.id === customerId);
                const debtInfo = document.getElementById('customerDebtInfo');
                
                if (customer && customer.debt > 0) {
                    document.getElementById('customerCurrentDebt').textContent = customer.debt.toLocaleString();
                    debtInfo.style.display = 'block';
                } else {
                    debtInfo.style.display = 'none';
                }
            });
            
            openModal('addCustomerPaymentModal');
        };
        
        // إضافة دفعة عميل
        document.getElementById('addCustomerPaymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const customerId = parseInt(document.getElementById('paymentCustomer').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const method = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('paymentNotes').value;
            
            // التحقق من صحة البيانات
            if (!customerId) {
                showNotification('الرجاء اختيار عميل', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('الرجاء إدخال مبلغ صحيح', 'error');
                return;
            }
            
            if (!paymentDate) {
                showNotification('الرجاء إدخال تاريخ الدفعة', 'error');
                return;
            }
            
            // التحقق من عدم تجاوز المبلغ للديون
            const customer = systemData.customers.find(c => c.id === customerId);
            if (customer && amount > customer.debt) {
                showNotification(`المبلغ يتجاوز الديون الحالية (${customer.debt.toLocaleString()} د.ع)`, 'error');
                return;
            }
            
            // إنشاء دفعة
            const payment = {
                id: systemData.customerPayments.length > 0 ? 
                    Math.max(...systemData.customerPayments.map(p => p.id)) + 1 : 1,
                customerId: customerId,
                amount: amount,
                date: paymentDate,
                method: method,
                notes: notes
            };
            
            // تحديث ديون العميل
            if (customer) {
                customer.debt -= amount;
                customer.previousDebt = customer.debt + amount;
            }
            
            // إضافة الدفعة إلى النظام
            systemData.customerPayments.push(payment);
            
            saveSystemData();
            
            showNotification('تم حفظ الدفعة بنجاح!', 'success');
            
            // إغلاق النافذة وإعادة التحميل
            closeModal('addCustomerPaymentModal');
            loadCustomerPayments();
            loadCustomers();
            updateDashboardStats();
        };
        
        // فتح نافذة إضافة مصروف
        window.openAddExpenseModal = function() {
            document.getElementById('addExpenseForm').reset();
            currentEditItem = null;
            
            // إعداد تاريخ اليوم
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            
            openModal('addExpenseModal');
        };
        
        // إضافة مصروف
        document.getElementById('addExpenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('expenseType').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const expenseDate = document.getElementById('expenseDate').value;
            const recipient = document.getElementById('expenseRecipient').value.trim();
            const notes = document.getElementById('expenseNotes').value;
            
            // التحقق من صحة البيانات
            if (!type) {
                showNotification('الرجاء اختيار نوع المصروف', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('الرجاء إدخال مبلغ صحيح', 'error');
                return;
            }
            
            if (!expenseDate) {
                showNotification('الرجاء إدخال تاريخ المصروف', 'error');
                return;
            }
            
            // إنشاء مصروف
            const expense = {
                id: systemData.expenses.length > 0 ? 
                    Math.max(...systemData.expenses.map(e => e.id)) + 1 : 1,
                type: type,
                amount: amount,
                date: expenseDate,
                recipient: recipient || '',
                notes: notes || ''
            };
            
            // إضافة المصروف إلى النظام
            systemData.expenses.push(expense);
            
            saveSystemData();
            
            showNotification('تم حفظ المصروف بنجاح!', 'success');
            
            // إغلاق النافذة وإعادة التحميل
            closeModal('addExpenseModal');
            loadExpenses();
        };
        
        // فتح نافذة إضافة مستخدم
        window.openAddUserModal = function() {
            document.getElementById('addUserForm').reset();
            currentEditItem = null;
            
            // تغيير النص على الزر
            const submitBtn = document.querySelector('#addUserForm button[type="submit"]');
            submitBtn.textContent = 'إضافة المستخدم';
            submitBtn.onclick = null;
            
            openModal('addUserModal');
        };
        
        // إضافة مستخدم جديد
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim();
            const fullName = document.getElementById('newFullName').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const confirmPassword = document.getElementById('confirmUserPassword').value;
            const role = document.getElementById('userRole').value;
            
            // التحقق من صحة البيانات
            if (!username || !fullName || !password || !role) {
                showNotification('الرجاء ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('كلمات المرور غير متطابقة', 'error');
                return;
            }
            
            if (password.length < 6) {
                showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return;
            }
            
            // التحقق من عدم تكرار اسم المستخدم
            const existingUser = systemData.users.find(u => u.username === username);
            if (existingUser && !currentEditItem) {
                showNotification('اسم المستخدم مسجل مسبقاً', 'error');
                return;
            }
            
            if (currentEditItem) {
                // تحديث المستخدم الموجود
                const userIndex = systemData.users.findIndex(u => u.id === currentEditItem);
                if (userIndex !== -1) {
                    systemData.users[userIndex] = {
                        ...systemData.users[userIndex],
                        username: username,
                        fullName: fullName,
                        password: password,
                        role: role
                    };
                    showNotification('تم تحديث بيانات المستخدم بنجاح!', 'success');
                }
            } else {
                // إضافة مستخدم جديد
                const newUser = {
                    id: systemData.users.length > 0 ? Math.max(...systemData.users.map(u => u.id)) + 1 : 1,
                    username: username,
                    password: password,
                    fullName: fullName,
                    role: role,
                    createdAt: new Date().toISOString().split('T')[0],
                    active: true
                };
                
                systemData.users.push(newUser);
                showNotification('تم إضافة المستخدم بنجاح!', 'success');
            }
            
            saveSystemData();
            
            // تحديث العرض
            loadUsers();
            loadRoles();
            
            closeModal('addUserModal');
        };
        
        // تعديل مستخدم
        window.editUser = function(userId) {
            const user = systemData.users.find(u => u.id === userId);
            if (!user) {
                showNotification('المستخدم غير موجود', 'error');
                return;
            }
            
            currentEditItem = userId;
            
            // تعبئة البيانات في النموذج
            document.getElementById('newUsername').value = user.username;
            document.getElementById('newFullName').value = user.fullName;
            document.getElementById('userRole').value = user.role;
            
            // إخفاء حقول كلمة المرور
            document.getElementById('newUserPassword').value = '********';
            document.getElementById('confirmUserPassword').value = '********';
            
            // تغيير النص على الزر
            const submitBtn = document.querySelector('#addUserForm button[type="submit"]');
            submitBtn.textContent = 'تحديث بيانات المستخدم';
            
            openModal('addUserModal');
        };
        
        // حذف مستخدم
        function deleteUser(userId) {
            // التحقق من عدم حذف المستخدم الرئيسي
            if (userId === 1) {
                showNotification('لا يمكن حذف المستخدم الرئيسي', 'error');
                return;
            }
            
            const userIndex = systemData.users.findIndex(u => u.id === userId);
            if (userIndex === -1) return;
            
            systemData.users.splice(userIndex, 1);
            saveSystemData();
            
            loadUsers();
            loadRoles();
            showNotification('تم حذف المستخدم بنجاح!', 'success');
        };
        
        // تعديل صلاحية
        window.editRole = function(role) {
            showNotification(`تعديل صلاحية ${role} - هذه الوظيفة تحت التطوير`, 'info');
        };
        
        // فتح نافذة تفاصيل العميل
        window.openCustomerDetailsModal = function(customerId) {
            const customer = systemData.customers.find(c => c.id === customerId);
            if (!customer) {
                showNotification('العميل غير موجود', 'error');
                return;
            }
            
            // تحميل معلومات العميل
            document.getElementById('customerInfoTab').innerHTML = `
                <div style="padding: 20px;">
                    <h4>معلومات العميل</h4>
                    <div class="form-group">
                        <label>الاسم الكامل</label>
                        <input type="text" class="form-control" value="${customer.name}" readonly>
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="text" class="form-control" value="${customer.phone}" readonly>
                    </div>
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" class="form-control" value="${customer.email || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>العنوان</label>
                        <textarea class="form-control" readonly>${customer.address || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>إجمالي المشتريات</label>
                        <input type="text" class="form-control" value="${customer.totalPurchases.toLocaleString()} د.ع" readonly>
                    </div>
                    <div class="form-group">
                        <label>الديون الحالية</label>
                        <input type="text" class="form-control" value="${customer.debt.toLocaleString()} د.ع" readonly>
                    </div>
                    <div class="form-group">
                        <label>تاريخ التسجيل</label>
                        <input type="text" class="form-control" value="${customer.createdAt}" readonly>
                    </div>
                </div>
            `;
            
            // تحميل فواتير العميل
            const customerInvoices = systemData.invoices.filter(inv => inv.customerId === customerId);
            document.getElementById('customerInvoicesTab').innerHTML = `
                <div style="padding: 20px;">
                    <h4>فواتير العميل (${customerInvoices.length})</h4>
                    ${customerInvoices.length > 0 ? `
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 10px; border: 1px solid #ddd;">رقم الفاتورة</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">التاريخ</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">الإجمالي</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">طريقة الدفع</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${customerInvoices.map(invoice => `
                                        <tr>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${invoice.id}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${invoice.date}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${invoice.total.toLocaleString()} د.ع</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${invoice.paymentType === 'cash' ? 'نقداً' : 'بالدين'}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">
                                                <button class="btn-small btn-view" onclick="viewInvoice('${invoice.id}')"><i class="fas fa-eye"></i></button>
                                                <button class="btn-small btn-print" onclick="printInvoice('${invoice.id}')"><i class="fas fa-print"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p style="text-align: center; color: #777;">لا توجد فواتير لهذا العميل</p>'}
                </div>
            `;
            
            // تحميل دفعات العميل
            const customerPayments = systemData.customerPayments.filter(p => p.customerId === customerId);
            document.getElementById('customerPaymentsTab').innerHTML = `
                <div style="padding: 20px;">
                    <h4>دفعات العميل (${customerPayments.length})</h4>
                    ${customerPayments.length > 0 ? `
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 10px; border: 1px solid #ddd;">المبلغ</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">التاريخ</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">الطريقة</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${customerPayments.map(payment => `
                                        <tr>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${payment.amount.toLocaleString()} د.ع</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${payment.date}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${payment.method}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${payment.notes || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p style="text-align: center; color: #777;">لا توجد دفعات لهذا العميل</p>'}
                </div>
            `;
            
            // تحميل تقرير العميل
            document.getElementById('customerReportTab').innerHTML = `
                <div style="padding: 20px;">
                    <h4>تقرير العميل</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 12px; color: #777;">عدد الفواتير</div>
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary);">${customerInvoices.length}</div>
                        </div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 12px; color: #777;">إجمالي المشتريات</div>
                            <div style="font-size: 24px; font-weight: bold; color: var(--success);">${customer.totalPurchases.toLocaleString()} د.ع</div>
                        </div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 12px; color: #777;">الديون الحالية</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${customer.debt > 0 ? 'var(--danger)' : 'var(--success)'};">${customer.debt.toLocaleString()} د.ع</div>
                        </div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 12px; color: #777;">متوسط قيمة الفاتورة</div>
                            <div style="font-size: 24px; font-weight: bold; color: var(--info);">${customerInvoices.length > 0 ? (customer.totalPurchases / customerInvoices.length).toLocaleString() : '0'} د.ع</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h5>آخر 5 فواتير</h5>
                        ${customerInvoices.slice(-5).reverse().map(invoice => `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 5px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${invoice.id}</span>
                                    <span>${invoice.date}</span>
                                    <span>${invoice.total.toLocaleString()} د.ع</span>
                                    <span>${invoice.paymentType === 'cash' ? 'نقداً' : 'بالدين'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            openModal('customerDetailsModal');
        };
        
        // فتح نافذة تفاصيل المورد
        window.openSupplierDetailsModal = function(supplierId) {
            const supplier = systemData.suppliers.find(s => s.id === supplierId);
            if (!supplier) {
                showNotification('المورد غير موجود', 'error');
                return;
            }
            
            // تحميل معلومات المورد
            document.getElementById('supplierInfoTab').innerHTML = `
                <div style="padding: 20px;">
                    <h4>معلومات المورد</h4>
                    <div class="form-group">
                        <label>اسم المورد</label>
                        <input type="text" class="form-control" value="${supplier.name}" readonly>
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="text" class="form-control" value="${supplier.phone}" readonly>
                    </div>
                    <div class="form-group">
                        <label>البريد الإلكتروني</label>
                        <input type="email" class="form-control" value="${supplier.email || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>العنوان</label>
                        <textarea class="form-control" readonly>${supplier.address || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>إجمالي المشتريات</label>
                        <input type="text" class="form-control" value="${supplier.totalPurchases.toLocaleString()} د.ع" readonly>
                    </div>
                    <div class="form-group">
                        <label>الديون الحالية</label>
                        <input type="text" class="form-control" value="${supplier.debt.toLocaleString()} د.ع" readonly>
                    </div>
                    <div class="form-group">
                        <label>تاريخ التسجيل</label>
                        <input type="text" class="form-control" value="${supplier.createdAt}" readonly>
                    </div>
                </div>
            `;
            
            // تحميل مشتريات المورد
            const supplierPurchases = systemData.purchases.filter(p => p.supplierId === supplierId);
            document.getElementById('supplierPurchasesTab').innerHTML = `
                <div style="padding: 20px;">
                    <h4>مشتريات من المورد (${supplierPurchases.length})</h4>
                    ${supplierPurchases.length > 0 ? `
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 10px; border: 1px solid #ddd;">رقم الفاتورة</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">التاريخ</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">الإجمالي</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">طريقة الدفع</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${supplierPurchases.map(purchase => `
                                        <tr>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${purchase.id}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${purchase.date}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${purchase.total.toLocaleString()} د.ع</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${purchase.paymentType === 'cash' ? 'نقداً' : 'بالدين'}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">
                                                <button class="btn-small btn-view" onclick="viewPurchase('${purchase.id}')"><i class="fas fa-eye"></i></button>
                                                <button class="btn-small btn-print" onclick="printPurchase('${purchase.id}')"><i class="fas fa-print"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : '<p style="text-align: center; color: #777;">لا توجد مشتريات من هذا المورد</p>'}
                </div>
            `;
            
            openModal('supplierDetailsModal');
        };
        
        // تأكيد الحذف
        window.confirmDelete = function(type, id) {
            let message = '';
            let itemName = '';
            
            switch(type) {
                case 'product':
                    const product = systemData.products.find(p => p.id === id);
                    if (!product) return;
                    message = `هل أنت متأكد من حذف المنتج "${product.name}"؟`;
                    itemName = product.name;
                    break;
                case 'customer':
                    const customer = systemData.customers.find(c => c.id === id);
                    if (!customer) return;
                    message = `هل أنت متأكد من حذف العميل "${customer.name}"؟`;
                    itemName = customer.name;
                    break;
                case 'supplier':
                    const supplier = systemData.suppliers.find(s => s.id === id);
                    if (!supplier) return;
                    message = `هل أنت متأكد من حذف المورد "${supplier.name}"؟`;
                    itemName = supplier.name;
                    break;
                case 'invoice':
                    const invoice = systemData.invoices.find(inv => inv.id === id);
                    if (!invoice) return;
                    message = `هل أنت متأكد من حذف الفاتورة "${id}"؟`;
                    itemName = id;
                    break;
                case 'purchase':
                    const purchase = systemData.purchases.find(p => p.id === id);
                    if (!purchase) return;
                    message = `هل أنت متأكد من حذف فاتورة الشراء "${id}"؟`;
                    itemName = id;
                    break;
                case 'customerPayment':
                    const payment = systemData.customerPayments.find(p => p.id === id);
                    if (!payment) return;
                    message = `هل أنت متأكد من حذف هذه الدفعة؟`;
                    break;
                case 'expense':
                    const expense = systemData.expenses.find(e => e.id === id);
                    if (!expense) return;
                    message = `هل أنت متأكد من حذف هذا المصروف؟`;
                    break;
                case 'user':
                    const user = systemData.users.find(u => u.id === id);
                    if (!user) return;
                    message = `هل أنت متأكد من حذف المستخدم "${user.username}"؟`;
                    itemName = user.username;
                    break;
                default:
                    return;
            }
            
            document.getElementById('confirmationMessage').textContent = message;
            
            // إعداد دالة الحذف
            deleteCallback = function() {
                switch(type) {
                    case 'product': deleteProduct(id); break;
                    case 'customer': deleteCustomer(id); break;
                    case 'supplier': deleteSupplier(id); break;
                    case 'invoice': deleteInvoice(id); break;
                    case 'purchase': deletePurchase(id); break;
                    case 'customerPayment': deleteCustomerPayment(id); break;
                    case 'expense': deleteExpense(id); break;
                    case 'user': deleteUser(id); break;
                }
            };
            
            openModal('confirmationModal');
        };
        
        // إعداد حدث زر التأكيد
        document.getElementById('confirmDeleteButton').onclick = function() {
            if (deleteCallback) {
                deleteCallback();
                closeModal('confirmationModal');
                deleteCallback = null;
            }
        };
        
        // حذف فاتورة
        function deleteInvoice(invoiceId) {
            const invoiceIndex = systemData.invoices.findIndex(inv => inv.id === invoiceId);
            if (invoiceIndex === -1) return;
            
            // استعادة الكميات إلى المخزون
            const invoice = systemData.invoices[invoiceIndex];
            invoice.items.forEach(item => {
                const product = systemData.products.find(p => p.id === item.productId);
                if (product) {
                    product.quantity += item.quantity;
                }
            });
            
            // تحديث بيانات العميل إذا كانت الفاتورة بالدين
            if (invoice.paymentType === 'credit' && invoice.customerId) {
                const customer = systemData.customers.find(c => c.id === invoice.customerId);
                if (customer) {
                    customer.debt -= invoice.total;
                    customer.totalPurchases -= invoice.total;
                }
            } else if (invoice.customerId) {
                // تحديث إجمالي المشتريات للعميل
                const customer = systemData.customers.find(c => c.id === invoice.customerId);
                if (customer) {
                    customer.totalPurchases -= invoice.total;
                }
            }
            
            systemData.invoices.splice(invoiceIndex, 1);
            saveSystemData();
            
            loadInvoices();
            loadInventory();
            loadCustomers();
            updateDashboardStats();
            showNotification('تم حذف الفاتورة بنجاح!', 'success');
        };
        
        // حذف عملية شراء
        function deletePurchase(purchaseId) {
            const purchaseIndex = systemData.purchases.findIndex(p => p.id === purchaseId);
            if (purchaseIndex === -1) return;
            
            // خصم الكميات من المخزون
            const purchase = systemData.purchases[purchaseIndex];
            purchase.items.forEach(item => {
                const product = systemData.products.find(p => p.id === item.productId);
                if (product) {
                    product.quantity -= item.quantity;
                }
            });
            
            // تحديث بيانات المورد إذا كانت العملية بالدين
            if (purchase.paymentType === 'credit' && purchase.supplierId) {
                const supplier = systemData.suppliers.find(s => s.id === purchase.supplierId);
                if (supplier) {
                    supplier.debt -= purchase.total;
                    supplier.totalPurchases -= purchase.total;
                }
            } else if (purchase.supplierId) {
                // تحديث إجمالي المشتريات من المورد
                const supplier = systemData.suppliers.find(s => s.id === purchase.supplierId);
                if (supplier) {
                    supplier.totalPurchases -= purchase.total;
                }
            }
            
            systemData.purchases.splice(purchaseIndex, 1);
            saveSystemData();
            
            loadPurchases();
            loadInventory();
            loadSuppliers();
            updateDashboardStats();
            showNotification('تم حذف فاتورة الشراء بنجاح!', 'success');
        };
        
        // حذف دفعة عميل
        function deleteCustomerPayment(paymentId) {
            const paymentIndex = systemData.customerPayments.findIndex(p => p.id === paymentId);
            if (paymentIndex === -1) return;
            
            // استعادة الديون للعميل
            const payment = systemData.customerPayments[paymentIndex];
            const customer = systemData.customers.find(c => c.id === payment.customerId);
            if (customer) {
                customer.debt += payment.amount;
            }
            
            systemData.customerPayments.splice(paymentIndex, 1);
            saveSystemData();
            
            loadCustomerPayments();
            loadCustomers();
            updateDashboardStats();
            showNotification('تم حذف الدفعة بنجاح!', 'success');
        };
        
        // حذف مصروف
        function deleteExpense(expenseId) {
            const expenseIndex = systemData.expenses.findIndex(e => e.id === expenseId);
            if (expenseIndex === -1) return;
            
            systemData.expenses.splice(expenseIndex, 1);
            saveSystemData();
            
            loadExpenses();
            showNotification('تم حذف المصروف بنجاح!', 'success');
        };
        
        // عرض الفاتورة
        window.viewInvoice = function(invoiceId) {
            const invoice = systemData.invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                showNotification('الفاتورة غير موجودة', 'error');
                return;
            }
            
            const customer = invoice.customerId ? systemData.customers.find(c => c.id === invoice.customerId) : null;
            
            let details = `تفاصيل الفاتورة: ${invoiceId}\n`;
            details += `التاريخ: ${invoice.date} ${invoice.time}\n`;
            if (customer) details += `العميل: ${customer.name}\n`;
            details += `طريقة الدفع: ${invoice.paymentType === 'cash' ? 'نقداً' : 'بالدين'}\n\n`;
            details += 'المنتجات:\n';
            
            invoice.items.forEach((item, index) => {
                details += `${index + 1}. ${item.name} - ${item.quantity} × ${item.price.toLocaleString()} = ${(item.quantity * item.price).toLocaleString()} د.ع\n`;
            });
            
            details += `\nالإجمالي: ${invoice.total.toLocaleString()} د.ع`;
            details += `\nالخصم: ${invoice.discount.toLocaleString()} د.ع`;
            details += `\nالضريبة: ${invoice.tax.toLocaleString()} د.ع`;
            
            alert(details);
        };
        
        // طباعة الفاتورة
        window.printInvoice = function(invoiceId) {
            const invoice = systemData.invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                showNotification('الفاتورة غير موجودة', 'error');
                return;
            }
            
            const customer = invoice.customerId ? systemData.customers.find(c => c.id === invoice.customerId) : null;
            
            const printContent = `
                <div class="small-invoice">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3>${systemData.settings.companyName}</h3>
                        <p>${systemData.settings.companyAddress}</p>
                        <p>${systemData.settings.companyPhone}</p>
                        <hr style="margin: 10px 0;">
                    </div>
                    
                    <div style="border-bottom: 1px dashed #000; margin-bottom: 15px; padding-bottom: 10px;">
                        <p><strong>رقم الفاتورة:</strong> ${invoice.id}</p>
                        <p><strong>التاريخ:</strong> ${invoice.date}</p>
                        <p><strong>الوقت:</strong> ${invoice.time}</p>
                    </div>
                    
                    <table style="width: 100%; margin-bottom: 15px; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="text-align: right; border-bottom: 1px solid #000; padding: 5px;">المنتج</th>
                                <th style="text-align: center; border-bottom: 1px solid #000; padding: 5px;">الكمية</th>
                                <th style="text-align: left; border-bottom: 1px solid #000; padding: 5px;">السعر</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td style="text-align: right; padding: 5px;">${item.name}</td>
                                    <td style="text-align: center; padding: 5px;">${item.quantity}</td>
                                    <td style="text-align: left; padding: 5px;">${item.price.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="border-top: 1px dashed #000; padding-top: 10px; margin-bottom: 15px; font-size: 12px;">
                        ${customer ? `<p><strong>العميل:</strong> ${customer.name}</p>` : ''}
                        <p><strong>الإجمالي:</strong> ${invoice.total.toLocaleString()} د.ع</p>
                        <p><strong>طريقة الدفع:</strong> ${invoice.paymentType === 'cash' ? 'نقداً' : 'بالدين'}</p>
                    </div>
                    
                    <div style="text-align: center; font-size: 11px; color: #777;">
                        <p>${systemData.settings.invoiceFooter}</p>
                        <p>شكراً لتعاملكم معنا</p>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>طباعة الفاتورة ${invoiceId}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                direction: rtl; 
                                margin: 0;
                                padding: 10px;
                            }
                            @media print {
                                body { margin: 0; padding: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        };
        
        // عرض عملية الشراء
        window.viewPurchase = function(purchaseId) {
            const purchase = systemData.purchases.find(p => p.id === purchaseId);
            if (!purchase) {
                showNotification('فاتورة الشراء غير موجودة', 'error');
                return;
            }
            
            const supplier = systemData.suppliers.find(s => s.id === purchase.supplierId);
            
            let details = `تفاصيل فاتورة الشراء: ${purchaseId}\n`;
            details += `التاريخ: ${purchase.date}\n`;
            if (supplier) details += `المورد: ${supplier.name}\n`;
            details += `طريقة الدفع: ${purchase.paymentType === 'cash' ? 'نقداً' : 'بالدين'}\n\n`;
            details += 'المنتجات:\n';
            
            purchase.items.forEach((item, index) => {
                details += `${index + 1}. ${item.name} - ${item.quantity} × ${item.purchasePrice.toLocaleString()} = ${(item.quantity * item.purchasePrice).toLocaleString()} د.ع\n`;
            });
            
            details += `\nالإجمالي: ${purchase.total.toLocaleString()} د.ع`;
            if (purchase.notes) details += `\nملاحظات: ${purchase.notes}`;
            
            alert(details);
        };
        
        // طباعة فاتورة الشراء
        window.printPurchase = function(purchaseId) {
            const purchase = systemData.purchases.find(p => p.id === purchaseId);
            if (!purchase) {
                showNotification('فاتورة الشراء غير موجودة', 'error');
                return;
            }
            
            const supplier = systemData.suppliers.find(s => s.id === purchase.supplierId);
            
            const printContent = `
                <div class="small-invoice">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h3>${systemData.settings.companyName}</h3>
                        <p>${systemData.settings.companyAddress}</p>
                        <p>${systemData.settings.companyPhone}</p>
                        <hr style="margin: 10px 0;">
                    </div>
                    
                    <div style="border-bottom: 1px dashed #000; margin-bottom: 15px; padding-bottom: 10px;">
                        <p><strong>رقم الفاتورة:</strong> ${purchase.id}</p>
                        <p><strong>التاريخ:</strong> ${purchase.date}</p>
                        <p><strong>نوع الفاتورة:</strong> شراء</p>
                    </div>
                    
                    ${supplier ? `
                        <div style="margin-bottom: 15px;">
                            <p><strong>المورد:</strong> ${supplier.name}</p>
                            <p><strong>الهاتف:</strong> ${supplier.phone}</p>
                        </div>
                    ` : ''}
                    
                    <table style="width: 100%; margin-bottom: 15px; font-size: 12px;">
                        <thead>
                            <tr>
                                <th style="text-align: right; border-bottom: 1px solid #000; padding: 5px;">المنتج</th>
                                <th style="text-align: center; border-bottom: 1px solid #000; padding: 5px;">الكمية</th>
                                <th style="text-align: left; border-bottom: 1px solid #000; padding: 5px;">السعر</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${purchase.items.map(item => `
                                <tr>
                                    <td style="text-align: right; padding: 5px;">${item.name}</td>
                                    <td style="text-align: center; padding: 5px;">${item.quantity}</td>
                                    <td style="text-align: left; padding: 5px;">${item.purchasePrice.toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="border-top: 1px dashed #000; padding-top: 10px; margin-bottom: 15px; font-size: 12px;">
                        <p><strong>الإجمالي:</strong> ${purchase.total.toLocaleString()} د.ع</p>
                        <p><strong>طريقة الدفع:</strong> ${purchase.paymentType === 'cash' ? 'نقداً' : 'بالدين'}</p>
                        ${purchase.notes ? `<p><strong>ملاحظات:</strong> ${purchase.notes}</p>` : ''}
                    </div>
                    
                    <div style="text-align: center; font-size: 11px; color: #777;">
                        <p>فاتورة شراء</p>
                        <p>${systemData.settings.companyName}</p>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>طباعة فاتورة الشراء ${purchaseId}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                direction: rtl; 
                                margin: 0;
                                padding: 10px;
                            }
                            @media print {
                                body { margin: 0; padding: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        };
        
        // تعديل دفعة عميل
        window.editCustomerPayment = function(paymentId) {
            showNotification('تعديل الدفعة - هذه الوظيفة تحت التطوير', 'info');
        };
        
        // تعديل مصروف
        window.editExpense = function(expenseId) {
            showNotification('تعديل المصروف - هذه الوظيفة تحت التطوير', 'info');
        };
        
        // البحث في المخزون
        window.searchInventory = function() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const rows = document.querySelectorAll('#inventoryTable tbody tr');
            
            rows.forEach(row => {
                const productName = row.cells[1].textContent.toLowerCase();
                const productType = row.cells[6].textContent.toLowerCase();
                
                if (productName.includes(searchTerm) || productType.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // البحث في المشتريات
        window.searchPurchases = function() {
            const searchTerm = document.getElementById('purchaseSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#purchasesTable tbody tr');
            
            rows.forEach(row => {
                const invoiceId = row.cells[0].textContent.toLowerCase();
                const supplierName = row.cells[2].textContent.toLowerCase();
                
                if (invoiceId.includes(searchTerm) || supplierName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // البحث في قائمة العملاء
        window.searchCustomerList = function() {
            const searchTerm = document.getElementById('customerListSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#customersTable tbody tr');
            
            rows.forEach(row => {
                const customerName = row.cells[1].textContent.toLowerCase();
                const customerPhone = row.cells[2].textContent.toLowerCase();
                
                if (customerName.includes(searchTerm) || customerPhone.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // البحث في الموردين
        window.searchSuppliers = function() {
            const searchTerm = document.getElementById('supplierSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#suppliersTable tbody tr');
            
            rows.forEach(row => {
                const supplierName = row.cells[1].textContent.toLowerCase();
                const supplierPhone = row.cells[2].textContent.toLowerCase();
                
                if (supplierName.includes(searchTerm) || supplierPhone.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // البحث في دفعات العملاء
        window.searchCustomerPayments = function() {
            const searchTerm = document.getElementById('customerPaymentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#customerPaymentsTable tbody tr');
            
            rows.forEach(row => {
                const customerName = row.cells[1].textContent.toLowerCase();
                const amount = row.cells[2].textContent.toLowerCase();
                
                if (customerName.includes(searchTerm) || amount.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // البحث في دفعات الموردين
        window.searchSupplierPayments = function() {
            const searchTerm = document.getElementById('supplierPaymentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#supplierPaymentsTable tbody tr');
            
            rows.forEach(row => {
                const supplierName = row.cells[1].textContent.toLowerCase();
                const amount = row.cells[2].textContent.toLowerCase();
                
                if (supplierName.includes(searchTerm) || amount.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // البحث في المصروفات
        window.searchExpenses = function() {
            const searchTerm = document.getElementById('expenseSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#expensesTable tbody tr');
            
            rows.forEach(row => {
                const expenseType = row.cells[1].textContent.toLowerCase();
                const amount = row.cells[2].textContent.toLowerCase();
                
                if (expenseType.includes(searchTerm) || amount.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // البحث في الفواتير
        window.searchInvoices = function() {
            const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#invoicesTable tbody tr');
            
            rows.forEach(row => {
                const invoiceId = row.cells[0].textContent.toLowerCase();
                const customerName = row.cells[2].textContent.toLowerCase();
                
                if (invoiceId.includes(searchTerm) || customerName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // البحث في المستخدمين
        window.searchUsers = function() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersTable tbody tr');
            
            rows.forEach(row => {
                const username = row.cells[1].textContent.toLowerCase();
                const fullName = row.cells[2].textContent.toLowerCase();
                
                if (username.includes(searchTerm) || fullName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // البحث في الصلاحيات
        window.searchRoles = function() {
            const searchTerm = document.getElementById('roleSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#rolesTable tbody tr');
            
            rows.forEach(row => {
                const roleName = row.cells[1].textContent.toLowerCase();
                
                if (roleName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        // مسح الباركود
        window.scanBarcode = function() {
            showNotification('للاستخدام الفعلي، سيتم فتح كاميرا الجهاز لمسح الباركود', 'info');
        };
        
        // تحديث إحصائيات لوحة التحكم
        function updateDashboardStats() {
            // إحصائيات المنتجات
            document.getElementById('totalProducts').textContent = systemData.products.length;
            document.getElementById('newProducts').textContent = systemData.products.filter(p => {
                // يمكن إضافة منطق للتحقق من المنتجات الجديدة
                return true;
            }).length;
            
            // إحصائيات العملاء
            document.getElementById('totalCustomers').textContent = systemData.customers.length;
            
            // إحصائيات الديون
            const totalDebts = systemData.customers.reduce((sum, customer) => sum + customer.debt, 0);
            document.getElementById('totalDebts').textContent = totalDebts.toLocaleString();
            document.getElementById('debtIncrease').textContent = '0'; // يمكن تطوير هذا
            
            // إحصائيات المبيعات والمشتريات (يومية وشهرية)
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            // حساب المبيعات اليومية
            const dailySales = systemData.invoices
                .filter(inv => inv.date === today)
                .reduce((sum, inv) => sum + inv.total, 0);
            document.getElementById('dailySales').textContent = dailySales.toLocaleString();
            
            // حساب المشتريات اليومية
            const dailyPurchases = systemData.purchases
                .filter(p => p.date === today)
                .reduce((sum, p) => sum + p.total, 0);
            document.getElementById('dailyPurchases').textContent = dailyPurchases.toLocaleString();
            
            // حساب الأرباح اليومية
            const dailyProfit = dailySales - dailyPurchases;
            document.getElementById('dailyProfit').textContent = dailyProfit.toLocaleString();
            
            // حساب المبيعات الشهرية
            const monthlySales = systemData.invoices
                .filter(inv => {
                    const invoiceDate = new Date(inv.date);
                    return invoiceDate.getMonth() + 1 === currentMonth && 
                           invoiceDate.getFullYear() === currentYear;
                })
                .reduce((sum, inv) => sum + inv.total, 0);
            document.getElementById('monthlySales').textContent = monthlySales.toLocaleString();
            
            // حساب المشتريات الشهرية
            const monthlyPurchases = systemData.purchases
                .filter(p => {
                    const purchaseDate = new Date(p.date);
                    return purchaseDate.getMonth() + 1 === currentMonth && 
                           purchaseDate.getFullYear() === currentYear;
                })
                .reduce((sum, p) => sum + p.total, 0);
            document.getElementById('monthlyPurchases').textContent = monthlyPurchases.toLocaleString();
            
            // حساب الأرباح الشهرية
            const monthlyProfit = monthlySales - monthlyPurchases;
            document.getElementById('monthlyProfit').textContent = monthlyProfit.toLocaleString();
            
            // تحديث النسب المئوية
            document.getElementById('dailySalesChange').textContent = '0';
            document.getElementById('dailyPurchasesChange').textContent = '0';
            document.getElementById('dailyProfitChange').textContent = '0';
            document.getElementById('monthlySalesChange').textContent = '0';
            document.getElementById('monthlyPurchasesChange').textContent = '0';
            document.getElementById('monthlyProfitChange').textContent = '0';
        };
        
        // توليد تقرير
        window.generateReport = function() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            
            if (!reportDate) {
                showNotification('الرجاء اختيار تاريخ', 'error');
                return;
            }
            
            let reportContent = '';
            
            switch(reportType) {
                case 'daily':
                    reportContent = generateDailyReport(reportDate);
                    break;
                case 'weekly':
                    reportContent = generateWeeklyReport(reportDate);
                    break;
                case 'monthly':
                    reportContent = generateMonthlyReport(reportDate);
                    break;
                case 'yearly':
                    reportContent = generateYearlyReport(reportDate);
                    break;
            }
            
            document.getElementById('reportResults').innerHTML = reportContent;
        };
        
        // توليد تقرير يومي
        function generateDailyReport(date) {
            const dailyInvoices = systemData.invoices.filter(inv => inv.date === date);
            const dailyPurchases = systemData.purchases.filter(p => p.date === date);
            const dailyExpenses = systemData.expenses.filter(e => e.date === date);
            
            const totalSales = dailyInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalPurchases = dailyPurchases.reduce((sum, p) => sum + p.total, 0);
            const totalExpenses = dailyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = totalSales - totalPurchases - totalExpenses;
            
            return `
                <div class="table-container">
                    <h3 style="padding: 20px; margin: 0;">تقرير المبيعات اليومي - ${date}</h3>
                    
                    <div class="stats-cards" style="margin: 20px;">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-title">إجمالي المبيعات</div>
                                <div class="stat-value">${totalSales.toLocaleString()} <span style="font-size: 16px;">د.ع</span></div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-cart-arrow-down"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-title">إجمالي المشتريات</div>
                                <div class="stat-value">${totalPurchases.toLocaleString()} <span style="font-size: 16px;">د.ع</span></div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-title">إجمالي المصروفات</div>
                                <div class="stat-value">${totalExpenses.toLocaleString()} <span style="font-size: 16px;">د.ع</span></div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-title">صافي الربح</div>
                                <div class="stat-value">${netProfit.toLocaleString()} <span style="font-size: 16px;">د.ع</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;">
                        <div>
                            <h4>الفواتير اليومية (${dailyInvoices.length})</h4>
                            ${dailyInvoices.length > 0 ? `
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f5f5f5;">
                                                <th style="padding: 10px; border: 1px solid #ddd;">رقم الفاتورة</th>
                                                <th style="padding: 10px; border: 1px solid #ddd;">المبلغ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dailyInvoices.map(invoice => `
                                                <tr>
                                                    <td style="padding: 10px; border: 1px solid #ddd;">${invoice.id}</td>
                                                    <td style="padding: 10px; border: 1px solid #ddd;">${invoice.total.toLocaleString()} د.ع</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p style="text-align: center; color: #777;">لا توجد فواتير لهذا اليوم</p>'}
                        </div>
                        
                        <div>
                            <h4>المشتريات اليومية (${dailyPurchases.length})</h4>
                            ${dailyPurchases.length > 0 ? `
                                <div style="max-height: 300px; overflow-y: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f5f5f5;">
                                                <th style="padding: 10px; border: 1px solid #ddd;">رقم الفاتورة</th>
                                                <th style="padding: 10px; border: 1px solid #ddd;">المبلغ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${dailyPurchases.map(purchase => `
                                                <tr>
                                                    <td style="padding: 10px; border: 1px solid #ddd;">${purchase.id}</td>
                                                    <td style="padding: 10px; border: 1px solid #ddd;">${purchase.total.toLocaleString()} د.ع</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p style="text-align: center; color: #777;">لا توجد مشتريات لهذا اليوم</p>'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // توليد تقرير أسبوعي
        function generateWeeklyReport(date) {
            // يمكن تطوير هذه الوظيفة لتوليد تقارير أسبوعية
            return '<p style="text-align: center; color: #777; padding: 40px;">تقرير أسبوعي - هذه الوظيفة تحت التطوير</p>';
        }
        
        // توليد تقرير شهري
        function generateMonthlyReport(date) {
            const dateObj = new Date(date);
            const month = dateObj.getMonth() + 1;
            const year = dateObj.getFullYear();
            
            const monthlyInvoices = systemData.invoices.filter(inv => {
                const invoiceDate = new Date(inv.date);
                return invoiceDate.getMonth() + 1 === month && 
                       invoiceDate.getFullYear() === year;
            });
            
            const monthlyPurchases = systemData.purchases.filter(p => {
                const purchaseDate = new Date(p.date);
                return purchaseDate.getMonth() + 1 === month && 
                       purchaseDate.getFullYear() === year;
            });
            
            const monthlyExpenses = systemData.expenses.filter(e => {
                const expenseDate = new Date(e.date);
                return expenseDate.getMonth() + 1 === month && 
                       expenseDate.getFullYear() === year;
            });
            
            const totalSales = monthlyInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalPurchases = monthlyPurchases.reduce((sum, p) => sum + p.total, 0);
            const totalExpenses = monthlyExpenses.reduce((sum, e) => sum + e.amount, 0);
            const netProfit = totalSales - totalPurchases - totalExpenses;
            
            const monthNames = [
                'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
            ];
            
            return `
                <div class="table-container">
                    <h3 style="padding: 20px; margin: 0;">تقرير المبيعات الشهري - ${monthNames[month-1]} ${year}</h3>
                    
                    <div class="stats-cards" style="margin: 20px;">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-title">إجمالي المبيعات</div>
                                <div class="stat-value">${totalSales.toLocaleString()} <span style="font-size: 16px;">د.ع</span></div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-cart-arrow-down"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-title">إجمالي المشتريات</div>
                                <div class="stat-value">${totalPurchases.toLocaleString()} <span style="font-size: 16px;">د.ع</span></div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-title">إجمالي المصروفات</div>
                                <div class="stat-value">${totalExpenses.toLocaleString()} <span style="font-size: 16px;">د.ع</span></div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-title">صافي الربح</div>
                                <div class="stat-value">${netProfit.toLocaleString()} <span style="font-size: 16px;">د.ع</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="padding: 20px;">
                        <h4>ملخص الأداء الشهري</h4>
                        <p>عدد الفواتير: ${monthlyInvoices.length}</p>
                        <p>عدد عمليات الشراء: ${monthlyPurchases.length}</p>
                        <p>عدد المصروفات: ${monthlyExpenses.length}</p>
                        <p>متوسط المبيعات اليومية: ${(totalSales / 30).toLocaleString()} د.ع</p>
                    </div>
                </div>
            `;
        }
        
        // توليد تقرير سنوي
        function generateYearlyReport(date) {
            // يمكن تطوير هذه الوظيفة لتوليد تقارير سنوية
            return '<p style="text-align: center; color: #777; padding: 40px;">تقرير سنوي - هذه الوظيفة تحت التطوير</p>';
        }
        
        // طباعة التقرير
        window.printReport = function() {
            const reportContent = document.getElementById('reportResults').innerHTML;
            
            if (!reportContent) {
                showNotification('الرجاء توليد التقرير أولاً', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>طباعة التقرير</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                direction: rtl; 
                                padding: 20px;
                            }
                        </style>
                    </head>
                    <body>
                        ${reportContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        };
        
        // تصدير الفواتير
        window.exportInvoices = function() {
            const dataStr = JSON.stringify(systemData.invoices, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `invoices-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('تم تصدير بيانات الفواتير', 'success');
        };
        
        // تغيير كلمة المرور
        window.changePassword = function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (currentPassword !== systemData.users[0].password) {
                showNotification('كلمة المرور الحالية غير صحيحة', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('كلمة المرور الجديدة وتأكيدها غير متطابقتين', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return;
            }
            
            systemData.users[0].password = newPassword;
            saveSystemData();
            showNotification('تم تغيير كلمة المرور بنجاح!', 'success');
            
            // مسح الحقول
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        };
        
        // حفظ إعدادات الطباعة
        window.savePrintSettings = function() {
            systemData.settings.autoPrint = document.getElementById('autoPrint').checked;
            systemData.settings.showPrintOptions = document.getElementById('showPrintOptions').checked;
            systemData.settings.showBarcodeInInvoice = document.getElementById('showBarcodeInInvoice').checked;
            systemData.settings.invoiceFooter = document.getElementById('invoiceFooter').value;
            
            saveSystemData();
            showNotification('تم حفظ إعدادات الطباعة بنجاح!', 'success');
        };
        
        // حفظ إعدادات المنتجات
        window.saveProductSettings = function() {
            systemData.settings.autoGenerateBarcode = document.getElementById('autoGenerateBarcode').checked;
            systemData.settings.autoSuggestColors = document.getElementById('autoSuggestColors').checked;
            systemData.settings.lowStockAlert = document.getElementById('lowStockAlert').checked;
            systemData.settings.lowStockThreshold = parseInt(document.getElementById('lowStockThreshold').value) || 10;
            
            saveSystemData();
            showNotification('تم حفظ إعدادات المنتجات بنجاح!', 'success');
        };
        
        // حفظ إعدادات الشركة
        window.saveCompanySettings = function() {
            systemData.settings.companyName = document.getElementById('companyName').value.trim() || 'متجر الإلكترونيات';
            systemData.settings.companyAddress = document.getElementById('companyAddress').value.trim() || 'بغداد - المنصور';
            systemData.settings.companyPhone = document.getElementById('companyPhone').value.trim() || '07700000000';
            
            saveSystemData();
            showNotification('تم حفظ معلومات الشركة بنجاح!', 'success');
        };
        
        // إنشاء نسخة احتياطية
        window.createBackup = function() {
            const dataStr = JSON.stringify(systemData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `backup-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('تم إنشاء النسخة الاحتياطية بنجاح!', 'success');
        };
        
        // استعادة نسخة احتياطية
        window.restoreBackup = function() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('الرجاء اختيار ملف النسخة الاحتياطية', 'error');
                return;
            }
            
            if (!confirm('هل أنت متأكد من استعادة النسخة الاحتياطية؟ سيتم استبدال جميع البيانات الحالية.')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    systemData = restoredData;
                    saveSystemData();
                    loadSystemData();
                    showNotification('تم استعادة النسخة الاحتياطية بنجاح!', 'success');
                    fileInput.value = '';
                } catch (error) {
                    showNotification('خطأ في ملف النسخة الاحتياطية: ' + error.message, 'error');
                }
            };
            reader.onerror = function() {
                showNotification('خطأ في قراءة الملف', 'error');
            };
            reader.readAsText(file);
        };
        
        // حفظ البيانات
        function saveSystemData() {
            try {
                localStorage.setItem('electronicsSalesSystem', JSON.stringify(systemData));
            } catch (error) {
                showNotification('خطأ في حفظ البيانات: ' + error.message, 'error');
            }
        }
        
        // تحميل البيانات المحفوظة
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('electronicsSalesSystem');
                if (savedData) {
                    systemData = JSON.parse(savedData);
                }
            } catch (error) {
                console.log('لا توجد بيانات محفوظة أو هناك خطأ في التحميل');
            }
        }
        
        // الحصول على وصف الصلاحية
        function getRoleDescription(role) {
            switch(role) {
                case 'مدير':
                    return 'صلاحيات كاملة على النظام';
                case 'مشرف':
                    return 'إدارة المبيعات والمشتريات والتقارير';
                case 'موظف':
                    return 'إدارة المبيعات والمخزون فقط';
                default:
                    return 'صلاحيات محدودة';
            }
        }
        
        // إظهار الإشعارات
        function showNotification(message, type) {
            // إزالة الإشعارات السابقة
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // إزالة الإشعار بعد 3 ثوان
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        // فتح نافذة منبثقة
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        // إغلاق نافذة منبثقة
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // تحميل النظام عند فتح الصفحة
        window.addEventListener('load', function() {
            // تحميل البيانات المحفوظة
            loadSavedData();
            
            // إخفاء النظام الرئيسي وإظهار صفحة الدخول
            mainSystem.style.display = 'none';
            loginPage.style.display = 'flex';
            
            // أنيميشن للبطاقات
            setTimeout(() => {
                document.querySelectorAll('.stat-card').forEach((card, index) => {
                    card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                });
            }, 500);
        });
        
        // إغلاق النوافذ المنبثقة عند النقر خارجها
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>