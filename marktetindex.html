<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Rental System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-dark: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --gradient-light: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .sidebar {
            background-color: var(--secondary-color);
            color: white;
            min-height: calc(100vh - 56px);
            padding: 0;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
        }
        
        .dashboard-card {
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .table-responsive {
            border-radius: 5px;
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 5px 5px;
        }
        
        .nav-tabs .nav-link.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .system-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .copyright {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                background-color: white;
                font-size: 12px;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            .table {
                font-size: 11px;
            }
            .invoice-logo {
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #333;
                padding-bottom: 10px;
            }
            .signature-area {
                margin-top: 50px;
                border-top: 1px solid #000;
                padding-top: 10px;
            }
        }
        
        .vehicle-details, .customer-details {
            display: none;
            margin-top: 20px;
        }
        
        .suggestion-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .status-returned {
            background-color: #d4edda;
        }
        
        .status-not-returned {
            background-color: #f8d7da;
        }
        
        /* Updated Login Styles */
        .login-page {
            background: var(--gradient-dark);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .login-container {
            max-width: 400px;
            width: 100%;
            padding: 40px 30px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            animation: containerSlide 0.6s ease-out;
            z-index: 10;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: var(--gradient-dark);
            animation: rotate 20s linear infinite;
            z-index: -1;
        }
        
        .login-container::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: white;
            border-radius: 18px;
            z-index: -1;
        }
        
        @keyframes containerSlide {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .login-container .text-center {
            animation: fadeIn 0.8s ease-out 0.2s both;
        }
        
        .login-logo {
            position: relative;
            margin-bottom: 25px;
        }
        
        .login-logo-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        .login-logo-icon i {
            font-size: 36px;
            color: white;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .login-container h2 {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .login-container .text-muted {
            color: #7f8c8d !important;
            font-weight: 500;
        }
        
        #loginForm {
            animation: fadeIn 1s ease-out 0.4s both;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .form-floating {
            position: relative;
            margin-bottom: 20px;
        }
        
        .form-floating .form-control {
            height: 60px;
            padding: 20px 15px 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .form-floating .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.2);
            background: white;
            transform: translateY(-2px);
        }
        
        .form-floating label {
            padding: 20px 15px;
            color: #7f8c8d;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .form-floating .form-control:focus + label,
        .form-floating .form-control:not(:placeholder-shown) + label {
            transform: scale(0.85) translateY(-10px) translateX(10px);
            color: #3498db;
            font-weight: 600;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            z-index: 10;
            transition: color 0.3s ease;
        }
        
        .password-toggle:hover {
            color: #3498db;
        }
        
        .login-btn {
            width: 100%;
            height: 55px;
            background: var(--gradient-primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .login-btn:active {
            transform: translateY(-1px);
        }
        
        .login-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .login-btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(40, 40);
                opacity: 0;
            }
        }
        
        .login-footer {
            margin-top: 30px;
            text-align: center;
            animation: fadeIn 1s ease-out 0.6s both;
        }
        
        .login-footer small {
            display: block;
            margin-bottom: 5px;
            color: #7f8c8d;
            font-size: 12px;
        }
        
        .developer-text {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            color: #2c3e50 !important;
            font-weight: 600;
            font-size: 13px !important;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .developer-text span {
            color: #e74c3c;
            font-weight: 700;
        }
        
        .login-illustration {
            position: absolute;
            bottom: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            opacity: 0.1;
            z-index: 0;
        }
        
        .form-floating .form-control.error-field {
            border-color: #e74c3c;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        /* Floating particles in background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .particle {
            position: absolute;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1));
            border-radius: 50%;
            animation: float-particle 20s infinite linear;
        }
        
        @keyframes float-particle {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.7;
            }
            90% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .invoice-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .invoice-logo img {
            max-width: 200px;
            height: auto;
        }
        
        .custom-logo {
            max-height: 50px;
            margin-right: 10px;
        }
        
        .currency-badge {
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .user-only {
            display: none;
        }
        
        .system-logo-large {
            max-width: 200px;
            max-height: 80px;
            margin-bottom: 15px;
        }
        
        .signature-area {
            margin-top: 50px;
            border-top: 1px solid #000;
            padding-top: 10px;
        }
        
        .maintenance-status {
            background-color: #fff3cd;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .vehicle-image {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .customer-form-container {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        
        .form-section {
            margin-bottom: 20px;
        }
        
        .debt-summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .permission-item {
            margin-bottom: 10px;
        }
        
        .advanced-search {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .permission-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        /* دەستکاری نوێ: ڕەنگی هەڵە بۆ خانەکان */
        .error-field {
            border-color: #e74c3c !important;
            box-shadow: 0 0 0 0.25rem rgba(231, 76, 60, 0.25) !important;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="login-page">
    <!-- Floating Particles Background -->
    <div class="particles" id="particles"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="text-center mb-4">
            <div class="login-logo">
                <div class="login-logo-icon">
                    <i class="fas fa-car"></i>
                </div>
                <h2>Car Rental System</h2>
                <p class="text-muted">دروستکردنی کەسی بەهێز بۆ بەڕێوەبردنی کۆمپانیای کرێ</p>
            </div>
        </div>
        
        <form id="loginForm">
            <div class="form-floating">
                <input type="text" class="form-control" id="username" placeholder="Username" required>
                <label for="username"><i class="fas fa-user me-2"></i>ناوی بەکارهێنەر</label>
            </div>
            
            <div class="form-floating position-relative">
                <input type="password" class="form-control" id="password" placeholder="Password" required>
                <label for="password"><i class="fas fa-lock me-2"></i>پاسۆرد</label>
                <button type="button" class="password-toggle" id="togglePassword">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            
            <button type="submit" class="login-btn">
                <span class="login-text">چوونەژوورەوە</span>
                <i class="fas fa-sign-in-alt ms-2"></i>
            </button>
        </form>
        
        <div class="login-footer">
            <small class="text-muted">بۆ چوونەژوورەوە ناوی بەکارهێنەر و پاسۆرد داخڵ بکە</small>
            <small class="developer-text">
                <i class="fas fa-code me-2"></i>Developer System 
                <span>FARZAD WARTY</span>
            </small>
        </div>
        
        <!-- Decorative illustration -->
        <div class="login-illustration">
            <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <path fill="#3498db" d="M45.5,-56.7C57.5,-47.8,64.8,-31.9,67.2,-15.9C69.5,0.1,66.9,16.2,58.6,28.7C50.3,41.1,36.3,50,21.5,57.8C6.7,65.7,-8.9,72.5,-22.9,69.3C-36.9,66.2,-49.3,53,-58.3,37.8C-67.3,22.6,-72.8,5.4,-70.2,-10.3C-67.6,-26,-56.9,-40.3,-43.8,-49.3C-30.7,-58.3,-15.3,-62.1,0.7,-62.9C16.8,-63.8,33.5,-65.7,45.5,-56.7Z" transform="translate(100 100)" />
            </svg>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark no-print">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <img id="headerLogo" src="" class="custom-logo" style="display: none;">
                    <span id="headerSystemName">Car Rental System</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i> <span id="currentUser">Admin</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-key"></i> Change Password</a></li>
                                <li class="admin-only"><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#userManagementModal"><i class="fas fa-users"></i> User Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-2 sidebar d-none d-md-block no-print">
                    <div class="logo-container">
                        <img id="sidebarLogo" src="" class="system-logo-large" style="display: none;">
                        <span class="system-name" id="sidebarSystemName">RentalSys</span>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item dashboard-item">
                            <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item vehicles-item">
                            <a class="nav-link" href="#vehicles" data-bs-toggle="tab">
                                <i class="fas fa-car"></i> Vehicles
                            </a>
                        </li>
                        <li class="nav-item rentals-customers-item">
                            <a class="nav-link" href="#rentals-customers" data-bs-toggle="tab">
                                <i class="fas fa-users"></i> Rentals & Customers
                            </a>
                        </li>
                        <li class="nav-item returns-item">
                            <a class="nav-link" href="#returns" data-bs-toggle="tab">
                                <i class="fas fa-undo"></i> Vehicle Returns
                            </a>
                        </li>
                        <li class="nav-item maintenance-item">
                            <a class="nav-link" href="#maintenance" data-bs-toggle="tab">
                                <i class="fas fa-tools"></i> Vehicle Maintenance
                            </a>
                        </li>
                        <li class="nav-item payments-item">
                            <a class="nav-link" href="#payments" data-bs-toggle="tab">
                                <i class="fas fa-money-bill-wave"></i> Payments
                            </a>
                        </li>
                        <li class="nav-item fines-item">
                            <a class="nav-link" href="#fines" data-bs-toggle="tab">
                                <i class="fas fa-gavel"></i> Fines & Taxes
                            </a>
                        </li>
                        <li class="nav-item reports-item">
                            <a class="nav-link" href="#reports" data-bs-toggle="tab">
                                <i class="fas fa-chart-bar"></i> Reports
                            </a>
                        </li>
                        <li class="nav-item admin-only settings-item">
                            <a class="nav-link" href="#settings" data-bs-toggle="tab">
                                <i class="fas fa-cogs"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    <div class="copyright">
                        Created by Farzad Programmer<br>Not Editable
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-10 ms-sm-auto col-lg-10 px-4">
                    <div class="tab-content mt-4">
                        <!-- Dashboard Tab -->
                        <div class="tab-pane fade show active" id="dashboard">
                            <h2 class="mb-4">Dashboard</h2>
                            <div class="row" id="dashboardStats">
                                <!-- Dashboard statistics will be loaded here -->
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Recent Rentals
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Customer</th>
                                                            <th>Vehicle</th>
                                                            <th>Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="recentRentalsTable">
                                                        <!-- Recent rentals will be loaded here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Vehicle Status
                                        </div>
                                        <div class="card-body">
                                            <canvas id="vehicleStatusChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicles Tab -->
                        <div class="tab-pane fade" id="vehicles">
                            <h2 class="mb-4">Vehicle Management</h2>
                            
                            <ul class="nav nav-tabs mb-3">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#addVehicle">Add Vehicle</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#vehicleList">Vehicle List</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#vehicleHistory">Vehicle History</a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="addVehicle">
                                    <div class="card">
                                        <div class="card-header">
                                            Add New Vehicle
                                        </div>
                                        <div class="card-body">
                                            <form id="addVehicleForm">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleName" class="form-label">Vehicle Name</label>
                                                        <input type="text" class="form-control" id="vehicleName" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleOdometer" class="form-label">Odometer</label>
                                                        <input type="number" step="0.1" class="form-control" id="vehicleOdometer" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleVin" class="form-label">VIN #</label>
                                                        <input type="text" class="form-control" id="vehicleVin" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehiclePlate" class="form-label">Plate Number</label>
                                                        <input type="text" class="form-control" id="vehiclePlate" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleColor" class="form-label">Color</label>
                                                        <input type="text" class="form-control" id="vehicleColor" placeholder="Type color..." required>
                                                        <div class="suggestion-list" id="colorSuggestions"></div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleModel" class="form-label">Model</label>
                                                        <input type="text" class="form-control" id="vehicleModel" placeholder="Type model year..." required>
                                                        <div class="suggestion-list" id="modelSuggestions"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-4 mb-3">
                                                        <label for="vehicleRentalPriceDaily" class="form-label">Rental Price (per day)</label>
                                                        <div class="input-group">
                                                            <input type="number" step="0.01" class="form-control" id="vehicleRentalPriceDaily" required>
                                                            <span class="input-group-text">AED</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="vehicleRentalPriceWeekly" class="form-label">Rental Price (weekly)</label>
                                                        <div class="input-group">
                                                            <input type="number" step="0.01" class="form-control" id="vehicleRentalPriceWeekly" required>
                                                            <span class="input-group-text">AED</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4 mb-3">
                                                        <label for="vehicleRentalPriceMonthly" class="form-label">Rental Price (monthly)</label>
                                                        <div class="input-group">
                                                            <input type="number" step="0.01" class="form-control" id="vehicleRentalPriceMonthly" required>
                                                            <span class="input-group-text">AED</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12 mb-3">
                                                        <label for="vehicleImage" class="form-label">Vehicle Image</label>
                                                        <input type="file" class="form-control" id="vehicleImage" accept="image/*">
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Add Vehicle</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="vehicleList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle List</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="vehicleSearch" placeholder="Search vehicles...">
                                                <button class="btn btn-outline-secondary" type="button" id="vehicleSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Image</th>
                                                            <th>Name</th>
                                                            <th>Model</th>
                                                            <th>Color</th>
                                                            <th>Plate #</th>
                                                            <th>Odometer</th>
                                                            <th>Rental Prices</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="vehicleTableBody">
                                                        <!-- Vehicle data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Vehicle Details Section -->
                                    <div class="card vehicle-details" id="vehicleDetailsCard">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle Details</span>
                                            <button class="btn btn-sm btn-secondary" id="closeVehicleDetails">Close</button>
                                        </div>
                                        <div class="card-body" id="vehicleDetailsContent">
                                            <!-- Vehicle details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="vehicleHistory">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle Rental History</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="vehicleHistorySearch" placeholder="Search by vehicle name...">
                                                <button class="btn btn-outline-secondary" type="button" id="vehicleHistorySearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Vehicle</th>
                                                            <th>Customer</th>
                                                            <th>Rental Date</th>
                                                            <th>Return Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="vehicleHistoryTableBody">
                                                        <!-- Vehicle history will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rentals & Customers Tab -->
                        <div class="tab-pane fade" id="rentals-customers">
                            <h2 class="mb-4">Rentals & Customers Management</h2>
                            
                            <ul class="nav nav-tabs mb-3">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#rentalCar">Rent a Car</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#customerList">Customer List</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#rentalList">Rental List</a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="rentalCar">
                                    <div class="card">
                                        <div class="card-header">
                                            Rent a Car
                                        </div>
                                        <div class="card-body">
                                            <form id="createRentalForm">
                                                <div class="form-section">
                                                    <h5>Customer Information</h5>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalCustomer" class="form-label">Customer <span class="text-danger">*</span></label>
                                                            <input type="text" class="form-control" id="rentalCustomer" placeholder="Search customer or add new..." required>
                                                            <div class="suggestion-list" id="customerSuggestions"></div>
                                                            <div class="form-text">If customer doesn't exist, you can add them below</div>
                                                        </div>
                                                        <div class="col-md-6 mb-3 d-flex align-items-end">
                                                            <button type="button" class="btn btn-outline-primary" id="toggleCustomerForm">
                                                                <i class="fas fa-user-plus"></i> Add New Customer
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- New Customer Form (Initially Hidden) -->
                                                    <div class="customer-form-container" id="newCustomerForm">
                                                        <h6>Add New Customer <span class="text-danger">*Required fields</span></h6>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerFullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="customerFullName" required>
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerDateOfBirth" class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                                                <input type="date" class="form-control" id="customerDateOfBirth" max="2006-12-31" required>
                                                                <div class="form-text" id="customerAgeText"></div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerId" class="form-label">PS/ID <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="customerId" required>
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerNationality" class="form-label">Nationality <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="customerNationality" placeholder="Type country name..." required>
                                                                <div class="suggestion-list" id="nationalitySuggestions"></div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerContact" class="form-label">Contact Number <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="customerContact" required>
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerAddress" class="form-label">Address <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="customerAddress" required>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="guaranteeDoc" class="form-label">Guarantee / Document</label>
                                                            <input type="file" class="form-control" id="guaranteeDoc">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="form-section">
                                                    <h5>Vehicle Information</h5>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalVehicle" class="form-label">Vehicle <span class="text-danger">*</span></label>
                                                            <input type="text" class="form-control" id="rentalVehicle" placeholder="Search vehicle..." required>
                                                            <div class="suggestion-list" id="vehicleSuggestions"></div>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalPeriodType" class="form-label">Rental Period Type <span class="text-danger">*</span></label>
                                                            <select class="form-select" id="rentalPeriodType" required>
                                                                <option value="daily">Daily</option>
                                                                <option value="weekly">Weekly</option>
                                                                <option value="monthly">Monthly</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalAmount" class="form-label">Rental Amount <span class="text-danger">*</span></label>
                                                            <div class="input-group">
                                                                <input type="number" step="0.01" class="form-control" id="rentalAmount" required>
                                                                <span class="input-group-text">AED</span>
                                                            </div>
                                                            <div class="form-text">According to selected rental period type</div>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalDays" class="form-label">Rental Period <span class="text-danger">*</span></label>
                                                            <input type="number" class="form-control" id="rentalDays" required>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="invoiceCode" class="form-label">Invoice Code</label>
                                                            <input type="text" class="form-control" id="invoiceCode">
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalStartDate" class="form-label">Rental Start Date <span class="text-danger">*</span></label>
                                                            <input type="date" class="form-control" id="rentalStartDate" required>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalEndDate" class="form-label">Rental End Date <span class="text-danger">*</span></label>
                                                            <input type="date" class="form-control" id="rentalEndDate" required>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <label for="advancePayment" class="form-label">Advance Payment (Optional)</label>
                                                            <div class="input-group">
                                                                <input type="number" step="0.01" class="form-control" id="advancePayment" value="0">
                                                                <span class="input-group-text">AED</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <button type="submit" class="btn btn-primary">Create Rental</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="customerList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Customer List</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="customerSearch" placeholder="Search customers...">
                                                <button class="btn btn-outline-secondary" type="button" id="customerSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Full Name</th>
                                                            <th>Age</th>
                                                            <th>ID</th>
                                                            <th>Nationality</th>
                                                            <th>Contact</th>
                                                            <th>Total Debt</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="customerTableBody">
                                                        <!-- Customer data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Customer Details Section -->
                                    <div class="card customer-details" id="customerDetailsCard">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Customer Details</span>
                                            <button class="btn btn-sm btn-secondary" id="closeCustomerDetails">Close</button>
                                        </div>
                                        <div class="card-body" id="customerDetailsContent">
                                            <!-- Customer details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="rentalList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Rental History</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="rentalSearch" placeholder="Search by invoice code...">
                                                <button class="btn btn-outline-secondary" type="button" id="rentalSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Invoice Code</th>
                                                            <th>Customer</th>
                                                            <th>Vehicle</th>
                                                            <th>Start Date</th>
                                                            <th>End Date</th>
                                                            <th>Amount</th>
                                                            <th>Period Type</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="rentalTableBody">
                                                        <!-- Rental data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Invoice for Printing -->
                            <div id="invoicePrint" class="print-only" style="display: none;">
                                <div class="invoice-logo">
                                    <img id="printLogo" src="" style="max-width: 200px; display: none;">
                                    <h3 id="printSystemName">Car Rental System</h3>
                                </div>
                                <div class="card">
                                    <div class="card-header text-center">
                                        <h3>Car Rental Invoice</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Invoice Code:</strong> <span id="printInvoiceCode"></span>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Date:</strong> <span id="printInvoiceDate"></span>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-4">
                                            <div class="col-6">
                                                <h5>Customer Information</h5>
                                                <table class="table table-bordered">
                                                    <tr>
                                                        <td><strong>Name:</strong></td>
                                                        <td id="printCustomerName"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Age:</strong></td>
                                                        <td id="printCustomerAge"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Address:</strong></td>
                                                        <td id="printCustomerAddress"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>ID Number:</strong></td>
                                                        <td id="printCustomerId"></td>
                                                    </tr>
                                                </table>
                                            </div>
                                            <div class="col-6">
                                                <h5>Vehicle Information</h5>
                                                <table class="table table-bordered">
                                                    <tr>
                                                        <td><strong>Vehicle:</strong></td>
                                                        <td id="printVehicleName"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Model:</strong></td>
                                                        <td id="printVehicleModel"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Color:</strong></td>
                                                        <td id="printVehicleColor"></td>
                                                    </tr>
                                                </table>
                                                <div id="printVehicleImage" class="text-center mt-2">
                                                    <!-- Vehicle image will be inserted here -->
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <h5>Rental Details</h5>
                                                <table class="table table-bordered">
                                                    <thead>
                                                        <tr>
                                                            <th>Rental Date</th>
                                                            <th>Return Date</th>
                                                            <th>Rental Period</th>
                                                            <th>Period Type</th>
                                                            <th>Rate</th>
                                                            <th>Total Amount</th>
                                                            <th>Advance Payment</th>
                                                            <th>Remaining Balance</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="printRentalDetails">
                                                        <!-- Rental details will be inserted here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <h5>Payment Summary</h5>
                                                <table class="table table-bordered">
                                                    <tr>
                                                        <td><strong>Total Amount:</strong></td>
                                                        <td id="printTotalAmount"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Advance Payment:</strong></td>
                                                        <td id="printAdvancePayment"></td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Remaining Balance:</strong></td>
                                                        <td id="printRemainingBalance"></td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        <div class="row signature-area">
                                            <div class="col-6">
                                                <strong>Customer Signature:</strong>
                                                <div style="height: 50px; border-bottom: 1px solid #000; margin-top: 10px;"></div>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Company Signature:</strong>
                                                <div style="height: 50px; border-bottom: 1px solid #000; margin-top: 10px;"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-4">
                                            <div class="col-12 text-center">
                                                <small>Thank you for choosing our car rental service!</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicle Returns Tab -->
                        <div class="tab-pane fade" id="returns">
                            <h2 class="mb-4">Vehicle Returns</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Return Vehicle
                                </div>
                                <div class="card-body">
                                    <form id="returnVehicleForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="returnInvoiceCode" class="form-label">Invoice Code</label>
                                                <input type="text" class="form-control" id="returnInvoiceCode" placeholder="Enter invoice code...">
                                                <div class="suggestion-list" id="invoiceSuggestions"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="returnDate" class="form-label">Return Date</label>
                                                <input type="date" class="form-control" id="returnDate" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label for="returnNotes" class="form-label">Notes (Optional)</label>
                                                <textarea class="form-control" id="returnNotes" rows="3"></textarea>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Process Return</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Return History
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Invoice Code</th>
                                                    <th>Customer</th>
                                                    <th>Vehicle</th>
                                                    <th>Return Date</th>
                                                    <th>Notes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="returnHistoryTableBody">
                                                <!-- Return history will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicle Maintenance Tab -->
                        <div class="tab-pane fade" id="maintenance">
                            <h2 class="mb-4">Vehicle Maintenance</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Add Maintenance Record
                                </div>
                                <div class="card-body">
                                    <form id="maintenanceForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceVehicle" class="form-label">Vehicle</label>
                                                <input type="text" class="form-control" id="maintenanceVehicle" placeholder="Search vehicle...">
                                                <div class="suggestion-list" id="maintenanceVehicleSuggestions"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceType" class="form-label">Maintenance Type</label>
                                                <select class="form-select" id="maintenanceType" required>
                                                    <option value="">Select type...</option>
                                                    <option value="Oil Change">Oil Change</option>
                                                    <option value="Tire Replacement">Tire Replacement</option>
                                                    <option value="Brake Service">Brake Service</option>
                                                    <option value="Engine Repair">Engine Repair</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceDate" class="form-label">Maintenance Date</label>
                                                <input type="date" class="form-control" id="maintenanceDate" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceCost" class="form-label">Cost</label>
                                                <div class="input-group">
                                                    <input type="number" step="0.01" class="form-control" id="maintenanceCost" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label for="maintenanceDescription" class="form-label">Description</label>
                                                <textarea class="form-control" id="maintenanceDescription" rows="3" required></textarea>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Add Maintenance Record</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Maintenance History
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Vehicle</th>
                                                    <th>Type</th>
                                                    <th>Date</th>
                                                    <th>Cost</th>
                                                    <th>Description</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="maintenanceHistoryTableBody">
                                                <!-- Maintenance history will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payments Tab -->
                        <div class="tab-pane fade" id="payments">
                            <h2 class="mb-4">Payment Management</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Search Customer Payments
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="paymentCustomerSearch" class="form-label">Search Customer</label>
                                            <input type="text" class="form-control" id="paymentCustomerSearch" placeholder="Search customer name...">
                                            <div class="suggestion-list" id="paymentCustomerSuggestions"></div>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary" id="searchPaymentCustomer">Search</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4" id="customerPaymentDetails" style="display: none;">
                                <div class="card-header">
                                    Customer Payment Details
                                </div>
                                <div class="card-body">
                                    <div class="debt-summary">
                                        <h5>Debt Summary</h5>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <strong>Total Rental Debt:</strong> <span id="totalRentalDebt">0 AED</span>
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Total Fines & Taxes:</strong> <span id="totalFinesTaxes">0 AED</span>
                                            </div>
                                            <div class="col-md-4">
                                                <strong>Total Amount Paid:</strong> <span id="totalAmountPaid">0 AED</span>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-md-12">
                                                <strong>Remaining Balance:</strong> <span id="remainingBalance" class="badge bg-danger">0 AED</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="payment-history mt-4">
                                        <h5>Payment History</h5>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Amount</th>
                                                        <th>Type</th>
                                                        <th>Description</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="paymentHistoryTableBody">
                                                    <!-- Payment history will be populated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="add-payment mt-4">
                                        <h5>Add/Edit Payment</h5>
                                        <form id="addPaymentForm">
                                            <div class="row">
                                                <div class="col-md-3 mb-3">
                                                    <label for="paymentAmount" class="form-label">Amount</label>
                                                    <div class="input-group">
                                                        <input type="number" step="0.01" class="form-control" id="paymentAmount" required>
                                                        <span class="input-group-text">AED</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label for="paymentDate" class="form-label">Date</label>
                                                    <input type="date" class="form-control" id="paymentDate" required>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label for="paymentType" class="form-label">Type</label>
                                                    <select class="form-select" id="paymentType" required>
                                                        <option value="Rental">Rental</option>
                                                        <option value="Fine">Fine</option>
                                                        <option value="Tax">Tax</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3 mb-3">
                                                    <label for="paymentDescription" class="form-label">Description</label>
                                                    <input type="text" class="form-control" id="paymentDescription">
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-success">Add Payment</button>
                                            <button type="reset" class="btn btn-secondary">Cancel Edit</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fines & Taxes Tab -->
                        <div class="tab-pane fade" id="fines">
                            <h2 class="mb-4">Fines & Taxes Management</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Add Fine/Tax
                                </div>
                                <div class="card-body">
                                    <form id="addFineTaxForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="fineCustomer" class="form-label">Customer</label>
                                                <input type="text" class="form-control" id="fineCustomer" placeholder="Search customer...">
                                                <div class="suggestion-list" id="fineCustomerSuggestions"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="fineType" class="form-label">Type</label>
                                                <select class="form-select" id="fineType" required>
                                                    <option value="">Select type...</option>
                                                    <option value="Traffic Fine">Traffic Fine</option>
                                                    <option value="Late Return">Late Return</option>
                                                    <option value="Damage">Damage</option>
                                                    <option value="Tax">Tax</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="fineAmount" class="form-label">Amount</label>
                                                <div class="input-group">
                                                    <input type="number" step="0.01" class="form-control" id="fineAmount" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="fineDate" class="form-label">Date</label>
                                                <input type="date" class="form-control" id="fineDate" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label for="fineDescription" class="form-label">Description</label>
                                                <textarea class="form-control" id="fineDescription" rows="3" required></textarea>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Add Fine/Tax</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Fines & Taxes History
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Customer</th>
                                                    <th>Type</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                    <th>Description</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="finesTaxesTableBody">
                                                <!-- Fines and taxes will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reports Tab -->
                        <div class="tab-pane fade" id="reports">
                            <h2 class="mb-4">Customer Rental Report</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Generate Customer Rental Report
                                </div>
                                <div class="card-body">
                                    <form id="customerReportForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="reportCustomer" class="form-label">Customer</label>
                                                <input type="text" class="form-control" id="reportCustomer" placeholder="Search customer...">
                                                <div class="suggestion-list" id="reportCustomerSuggestions"></div>
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="reportStartDate" class="form-label">Start Date</label>
                                                <input type="date" class="form-control" id="reportStartDate">
                                            </div>
                                            <div class="col-md-3 mb-3">
                                                <label for="reportEndDate" class="form-label">End Date</label>
                                                <input type="date" class="form-control" id="reportEndDate">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Generate Report</button>
                                        <button type="button" class="btn btn-success" id="exportReportBtn">
                                            <i class="fas fa-file-excel"></i> Export to Excel
                                        </button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Customer Rental Report
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="customerRentalReportTable">
                                            <thead>
                                                <tr>
                                                    <th>Vehicle Name</th>
                                                    <th>Rental Date</th>
                                                    <th>Return Date</th>
                                                    <th>Rental Period</th>
                                                    <th>Period Type</th>
                                                    <th>Rental Amount</th>
                                                    <th>Total Amount</th>
                                                    <th>Advance Payment</th>
                                                    <th>Total Payment</th>
                                                    <th>Total Debt</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="customerRentalReportBody">
                                                <!-- Customer rental report will be populated here -->
                                            </tbody>
                                            <tfoot>
                                                <tr class="table-primary">
                                                    <td colspan="6" class="text-end"><strong>Totals:</strong></td>
                                                    <td><strong id="totalRentalAmount">0 AED</strong></td>
                                                    <td><strong id="totalAdvancePayment">0 AED</strong></td>
                                                    <td><strong id="totalPayment">0 AED</strong></td>
                                                    <td><strong id="totalDebt">0 AED</strong></td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Settings Tab -->
                        <div class="tab-pane fade" id="settings">
                            <h2 class="mb-4">System Settings</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    General Settings
                                </div>
                                <div class="card-body">
                                    <form id="generalSettingsForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="systemName" class="form-label">System Name</label>
                                                <input type="text" class="form-control" id="systemName" value="Car Rental System">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="systemLogo" class="form-label">System Logo</label>
                                                <input type="file" class="form-control" id="systemLogo" accept="image/*">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="currency" class="form-label">Currency</label>
                                                <select class="form-select" id="currency">
                                                    <option value="AED">AED (United Arab Emirates Dirham)</option>
                                                    <option value="USD">USD (US Dollar)</option>
                                                    <option value="EUR">EUR (Euro)</option>
                                                    <option value="GBP">GBP (British Pound)</option>
                                                    <option value="SAR">SAR (Saudi Riyal)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="dateFormat" class="form-label">Date Format</label>
                                                <select class="form-select" id="dateFormat">
                                                    <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                                                    <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                                    <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save Settings</button>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Backup & Restore Section -->
                            <div class="card mt-4 admin-only">
                                <div class="card-header">
                                    <h5 class="mb-0">باکەپ کردن و گەڕاندنەوە</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0">دروستکردنی باکەپ</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p class="card-text">هەموو داتاکانی سیستەمەکە کۆپی بکە بۆ فایلێک.</p>
                                                    <button type="button" class="btn btn-success w-100" id="backupBtn">
                                                        <i class="fas fa-download me-2"></i>دروستکردنی باکەپ
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header bg-warning text-dark">
                                                    <h6 class="mb-0">گەڕاندنەوەی باکەپ</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p class="card-text">داتاکانی پێشوو لە فایلێکەوە باربکەوە.</p>
                                                    <div class="mb-3">
                                                        <label for="backupFile" class="form-label">هەڵبژاردنی فایلی باکەپ</label>
                                                        <input class="form-control" type="file" id="backupFile" accept=".json">
                                                    </div>
                                                    <button type="button" class="btn btn-warning w-100" id="restoreBtn">
                                                        <i class="fas fa-upload me-2"></i>گەڕاندنەوەی باکەپ
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-4">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">باکەپەکانی پێشوو</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>ناوی فایل</th>
                                                            <th>قەبارە</th>
                                                            <th>کاتی دروستکردن</th>
                                                            <th>کردارەکان</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="backupHistoryTable">
                                                        <!-- مێژووی باکەپەکان لێرە نمایش دەبێت -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4 admin-only">
                                <div class="card-header">
                                    User Management
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Full Name</th>
                                                    <th>Role</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="userTableBody">
                                                <!-- User data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                        <i class="fas fa-user-plus"></i> Add User
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card mt-4 admin-only">
                                <div class="card-header">
                                    User Permissions
                                </div>
                                <div class="card-body">
                                    <div class="permission-section">
                                        <h5>Role Management</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="permissionRole" class="form-label">Select Role</label>
                                                <select class="form-select" id="permissionRole">
                                                    <option value="admin">Admin</option>
                                                    <option value="manager">Manager</option>
                                                    <option value="staff">Staff</option>
                                                    <option value="viewer">Viewer</option>
                                                    <option value="accountant">Accountant</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-primary" id="addNewRole">Add New Role</button>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-danger" id="deleteRole">Delete Role</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="permission-section">
                                        <h5>Module Permissions</h5>
                                        <div class="permission-item">
                                            <div class="form-check">
                                                <input class="form-check-input module-permission" type="checkbox" value="dashboard" id="permDashboard">
                                                <label class="form-check-label" for="permDashboard">
                                                    Dashboard Access
                                                </label>
                                            </div>
                                        </div>
                                        <div class="permission-item">
                                            <div class="form-check">
                                                <input class="form-check-input module-permission" type="checkbox" value="vehicles" id="permVehicles">
                                                <label class="form-check-label" for="permVehicles">
                                                    Vehicle Management
                                                </label>
                                            </div>
                                        </div>
                                        <div class="permission-item">
                                            <div class="form-check">
                                                <input class="form-check-input module-permission" type="checkbox" value="rentals" id="permRentals">
                                                <label class="form-check-label" for="permRentals">
                                                    Rentals & Customers
                                                </label>
                                            </div>
                                        </div>
                                        <div class="permission-item">
                                            <div class="form-check">
                                                <input class="form-check-input module-permission" type="checkbox" value="returns" id="permReturns">
                                                <label class="form-check-label" for="permReturns">
                                                    Vehicle Returns
                                                </label>
                                            </div>
                                        </div>
                                        <div class="permission-item">
                                            <div class="form-check">
                                                <input class="form-check-input module-permission" type="checkbox" value="maintenance" id="permMaintenance">
                                                <label class="form-check-label" for="permMaintenance">
                                                    Vehicle Maintenance
                                                </label>
                                            </div>
                                        </div>
                                        <div class="permission-item">
                                            <div class="form-check">
                                                <input class="form-check-input module-permission" type="checkbox" value="payments" id="permPayments">
                                                <label class="form-check-label" for="permPayments">
                                                    Payment Management
                                                </label>
                                            </div>
                                        </div>
                                        <div class="permission-item">
                                            <div class="form-check">
                                                <input class="form-check-input module-permission" type="checkbox" value="fines" id="permFines">
                                                <label class="form-check-label" for="permFines">
                                                    Fines & Taxes
                                                </label>
                                            </div>
                                        </div>
                                        <div class="permission-item">
                                            <div class="form-check">
                                                <input class="form-check-input module-permission" type="checkbox" value="reports" id="permReports">
                                                <label class="form-check-label" for="permReports">
                                                    Reports
                                                </label>
                                            </div>
                                        </div>
                                        <div class="permission-item">
                                            <div class="form-check">
                                                <input class="form-check-input module-permission" type="checkbox" value="settings" id="permSettings">
                                                <label class="form-check-label" for="permSettings">
                                                    System Settings
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary mt-3" id="savePermissions">Save Permissions</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="newFullName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="newFullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserRole" class="form-label">Role</label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                                <option value="viewer">Viewer</option>
                                <option value="accountant">Accountant</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newUserPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="newUserPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add User</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userManagementTableBody">
                                <!-- User management data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // System data and state
        const systemData = {
            users: [
                { username: "admin", password: "000000", fullName: "System Administrator", role: "admin", status: "active" },
                { username: "manager", password: "000000", fullName: "Branch Manager", role: "manager", status: "active" },
                { username: "staff", password: "000000", fullName: "Staff Member", role: "staff", status: "active" },
                { username: "accountant", password: "000000", fullName: "Accountant", role: "accountant", status: "active" }
            ],
            vehicles: [],
            customers: [],
            rentals: [],
            returns: [],
            maintenance: [],
            payments: [],
            finesTaxes: [],
            settings: {
                systemName: "Car Rental System",
                currency: "AED",
                dateFormat: "dd/mm/yyyy"
            },
            permissions: {
                admin: ["dashboard", "vehicles", "rentals", "returns", "maintenance", "payments", "fines", "reports", "settings"],
                manager: ["dashboard", "vehicles", "rentals", "returns", "maintenance", "payments", "fines", "reports"],
                staff: ["dashboard", "vehicles", "rentals", "returns", "maintenance", "payments", "fines"],
                viewer: ["dashboard", "vehicles", "rentals", "reports"],
                accountant: ["dashboard", "payments", "fines", "reports"]
            },
            roles: ["admin", "manager", "staff", "viewer", "accountant"]
        };

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from localStorage if available
            loadDataFromStorage();
            
            // Initialize the UI
            initializeUI();
            
            // Set up event listeners
            setupEventListeners();
            
            // Load dashboard data
            loadDashboardData();
        });

        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 100 + 20;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 20}s`;
                particle.style.animationDuration = `${Math.random() * 20 + 10}s`;
                
                particlesContainer.appendChild(particle);
            }
        }

        // Toggle password visibility
        function setupPasswordToggle() {
            const toggleBtn = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            
            if (toggleBtn && passwordInput) {
                toggleBtn.addEventListener('click', function() {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    
                    const icon = this.querySelector('i');
                    if (type === 'password') {
                        icon.className = 'fas fa-eye';
                    } else {
                        icon.className = 'fas fa-eye-slash';
                    }
                });
            }
        }

        // Load data from localStorage
        function loadDataFromStorage() {
            const savedData = localStorage.getItem('carRentalSystemData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                // Merge with default data, preserving existing data
                Object.keys(systemData).forEach(key => {
                    if (parsedData[key]) {
                        systemData[key] = parsedData[key];
                    }
                });
            }
        }

        // Save data to localStorage
        function saveDataToStorage() {
            localStorage.setItem('carRentalSystemData', JSON.stringify(systemData));
        }

        // Initialize the UI components
        function initializeUI() {
            // Create particles for login background
            createParticles();
            setupPasswordToggle();
            
            // Set current date for date inputs
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = [
                'returnDate', 'maintenanceDate', 'paymentDate', 'fineDate', 
                'rentalStartDate', 'rentalEndDate', 'reportStartDate', 'reportEndDate',
                'customerDateOfBirth'
            ];
            
            dateInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id === 'rentalEndDate') {
                        // Set end date to 7 days from now
                        const endDate = new Date();
                        endDate.setDate(endDate.getDate() + 7);
                        element.value = endDate.toISOString().split('T')[0];
                    } else if (id === 'customerDateOfBirth') {
                        // Set default date of birth to 25 years ago
                        const dob = new Date();
                        dob.setFullYear(dob.getFullYear() - 25);
                        element.value = dob.toISOString().split('T')[0];
                        // Calculate and display age
                        calculateAndDisplayAge(dob.toISOString().split('T')[0]);
                    } else {
                        element.value = today;
                    }
                }
            });
            
            // Apply system settings
            applySystemSettings();
            
            // Load initial data tables
            loadVehicleTable();
            loadCustomerTable();
            loadRentalTable();
            loadReturnHistoryTable();
            loadMaintenanceHistoryTable();
            loadFinesTaxesTable();
            loadUserTable();
            
            // Load backup history
            loadBackupHistory();
            
            // Add focus effects to form inputs
            const inputs = document.querySelectorAll('.form-control');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('focused');
                });
                
                input.addEventListener('blur', function() {
                    if (!this.value) {
                        this.parentElement.classList.remove('focused');
                    }
                });
            });
            
            // Add button animation on click
            const loginBtn = document.querySelector('.login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', function(e) {
                    if (!this.closest('form').checkValidity()) {
                        e.preventDefault();
                        this.classList.add('error');
                        setTimeout(() => this.classList.remove('error'), 1000);
                    }
                });
            }
        }

        // Calculate and display age from date of birth
        function calculateAndDisplayAge(dateOfBirth) {
            const ageText = document.getElementById('customerAgeText');
            if (ageText && dateOfBirth) {
                const age = calculateAge(dateOfBirth);
                ageText.textContent = `Age: ${age} years`;
                ageText.style.color = age < 18 ? 'red' : 'green';
            }
        }

        // Calculate age from date of birth
        function calculateAge(dateOfBirth) {
            const today = new Date();
            const birthDate = new Date(dateOfBirth);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Apply system settings to UI
        function applySystemSettings() {
            // Update settings form
            const systemNameInput = document.getElementById('systemName');
            const currencyInput = document.getElementById('currency');
            const dateFormatInput = document.getElementById('dateFormat');
            
            if (systemNameInput) systemNameInput.value = systemData.settings.systemName;
            if (currencyInput) currencyInput.value = systemData.settings.currency;
            if (dateFormatInput) dateFormatInput.value = systemData.settings.dateFormat;
            
            // Update header and sidebar
            document.getElementById('headerSystemName').textContent = systemData.settings.systemName;
            document.getElementById('sidebarSystemName').textContent = systemData.settings.systemName;
            document.getElementById('printSystemName').textContent = systemData.settings.systemName;
            
            // Update currency badges
            document.querySelectorAll('.currency-badge').forEach(badge => {
                badge.textContent = systemData.settings.currency;
            });
            
            // Apply logo if exists
            if (systemData.settings.logo) {
                document.getElementById('headerLogo').src = systemData.settings.logo;
                document.getElementById('headerLogo').style.display = 'inline';
                document.getElementById('sidebarLogo').src = systemData.settings.logo;
                document.getElementById('sidebarLogo').style.display = 'inline';
                document.getElementById('printLogo').src = systemData.settings.logo;
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Vehicle form
            document.getElementById('addVehicleForm').addEventListener('submit', handleAddVehicle);
            
            // Rental form
            document.getElementById('createRentalForm').addEventListener('submit', handleCreateRental);
            
            // Return form
            document.getElementById('returnVehicleForm').addEventListener('submit', handleReturnVehicle);
            
            // Maintenance form
            document.getElementById('maintenanceForm').addEventListener('submit', handleAddMaintenance);
            
            // Payment form
            document.getElementById('addPaymentForm').addEventListener('submit', handleAddPayment);
            
            // Fine/Tax form
            document.getElementById('addFineTaxForm').addEventListener('submit', handleAddFineTax);
            
            // Settings form
            document.getElementById('generalSettingsForm').addEventListener('submit', handleSaveSettings);
            
            // Change password form
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            
            // Add user form
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            
            // Date of birth change listener
            document.getElementById('customerDateOfBirth').addEventListener('change', function() {
                calculateAndDisplayAge(this.value);
            });
            
            // Rental period type change listener
            document.getElementById('rentalPeriodType').addEventListener('change', function() {
                updateRentalAmountByPeriodType();
            });
            
            // Vehicle selection change listener for rental
            document.getElementById('rentalVehicle').addEventListener('input', function() {
                updateRentalAmountByPeriodType();
            });
            
            // Search functionality
            document.getElementById('vehicleSearchBtn').addEventListener('click', searchVehicles);
            document.getElementById('customerSearchBtn').addEventListener('click', searchCustomers);
            document.getElementById('rentalSearchBtn').addEventListener('click', searchRentals);
            document.getElementById('searchPaymentCustomer').addEventListener('click', searchPaymentCustomer);
            
            // Toggle customer form
            document.getElementById('toggleCustomerForm').addEventListener('click', toggleCustomerForm);
            
            // Close details buttons
            document.getElementById('closeVehicleDetails').addEventListener('click', closeVehicleDetails);
            document.getElementById('closeCustomerDetails').addEventListener('click', closeCustomerDetails);
            
            // Generate report
            document.getElementById('exportReportBtn').addEventListener('click', exportCustomerRentalReport);
            
            // Customer Report Form
            document.getElementById('customerReportForm').addEventListener('submit', generateCustomerRentalReport);
            
            // User permissions
            document.getElementById('savePermissions').addEventListener('click', savePermissions);
            document.getElementById('addNewRole').addEventListener('click', addNewRole);
            document.getElementById('deleteRole').addEventListener('click', deleteRole);
            document.getElementById('permissionRole').addEventListener('change', loadRolePermissions);
            
            // Backup and Restore
            document.getElementById('backupBtn').addEventListener('click', createBackup);
            document.getElementById('restoreBtn').addEventListener('click', restoreBackup);
            
            // Auto-suggestions
            setupAutoSuggestions();
            
            // Add event listeners for delete buttons
            setupDeleteEventListeners();
            
            // Add event listeners for view and delete buttons
            setupViewDeleteEventListeners();
        }

        // Update rental amount based on selected period type
        function updateRentalAmountByPeriodType() {
            const vehicleName = document.getElementById('rentalVehicle').value;
            const periodType = document.getElementById('rentalPeriodType').value;
            const vehicle = systemData.vehicles.find(v => v.name === vehicleName);
            
            if (vehicle) {
                let rentalAmount = 0;
                switch(periodType) {
                    case 'daily':
                        rentalAmount = vehicle.rentalPriceDaily;
                        break;
                    case 'weekly':
                        rentalAmount = vehicle.rentalPriceWeekly;
                        break;
                    case 'monthly':
                        rentalAmount = vehicle.rentalPriceMonthly;
                        break;
                }
                document.getElementById('rentalAmount').value = rentalAmount;
            }
        }

        // Setup delete event listeners
        function setupDeleteEventListeners() {
            // Vehicle delete
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-vehicle')) {
                    const vehicleId = e.target.closest('.delete-vehicle').getAttribute('data-id');
                    deleteVehicle(vehicleId);
                }
                
                if (e.target.closest('.delete-maintenance')) {
                    const maintenanceId = e.target.closest('.delete-maintenance').getAttribute('data-id');
                    deleteMaintenance(maintenanceId);
                }
                
                if (e.target.closest('.delete-fine')) {
                    const fineId = e.target.closest('.delete-fine').getAttribute('data-id');
                    deleteFineTax(fineId);
                }
                
                if (e.target.closest('.delete-user')) {
                    const username = e.target.closest('.delete-user').getAttribute('data-username');
                    deleteUser(username);
                }
                
                if (e.target.closest('.mark-paid')) {
                    const fineId = e.target.closest('.mark-paid').getAttribute('data-id');
                    markFineAsPaid(fineId);
                }
                
                if (e.target.closest('.edit-vehicle')) {
                    const vehicleId = e.target.closest('.edit-vehicle').getAttribute('data-id');
                    editVehicle(vehicleId);
                }
                
                if (e.target.closest('.edit-customer')) {
                    const customerId = e.target.closest('.edit-customer').getAttribute('data-id');
                    editCustomer(customerId);
                }
                
                if (e.target.closest('.edit-user')) {
                    const username = e.target.closest('.edit-user').getAttribute('data-username');
                    editUser(username);
                }
                
                if (e.target.closest('.print-invoice')) {
                    const rentalId = e.target.closest('.print-invoice').getAttribute('data-id');
                    printRentalInvoice(rentalId);
                }

                // زیادکردنی فەنکشنی بینین و سڕینەوەی فاکتور
                if (e.target.closest('.view-invoice')) {
                    const rentalId = e.target.closest('.view-invoice').getAttribute('data-id');
                    viewRentalInvoice(rentalId);
                }

                if (e.target.closest('.delete-rental')) {
                    const rentalId = e.target.closest('.delete-rental').getAttribute('data-id');
                    deleteRental(rentalId);
                }
            });
        }

        // Setup view and delete event listeners for all modules
        function setupViewDeleteEventListeners() {
            document.addEventListener('click', function(e) {
                // بینینی گەیاندنەوە
                if (e.target.closest('.view-return')) {
                    const returnId = e.target.closest('.view-return').getAttribute('data-id');
                    viewReturnDetails(returnId);
                }
                
                // سڕینەوەی گەیاندنەوە
                if (e.target.closest('.delete-return')) {
                    const returnId = e.target.closest('.delete-return').getAttribute('data-id');
                    deleteReturn(returnId);
                }
                
                // بینینی چاکسازی
                if (e.target.closest('.view-maintenance')) {
                    const maintenanceId = e.target.closest('.view-maintenance').getAttribute('data-id');
                    viewMaintenanceDetails(maintenanceId);
                }
                
                // بینینی تاوان
                if (e.target.closest('.view-fine')) {
                    const fineId = e.target.closest('.view-fine').getAttribute('data-id');
                    viewFineDetails(fineId);
                }
                
                // بینینی پارەدان
                if (e.target.closest('.view-payment')) {
                    const paymentId = e.target.closest('.view-payment').getAttribute('data-id');
                    viewPaymentDetails(paymentId);
                }
                
                // سڕینەوەی پارەدان
                if (e.target.closest('.delete-payment-record')) {
                    const paymentId = e.target.closest('.delete-payment-record').getAttribute('data-id');
                    deletePaymentRecord(paymentId);
                }
                
                // بینینی کرێ
                if (e.target.closest('.view-rental')) {
                    const rentalId = e.target.closest('.view-rental').getAttribute('data-id');
                    viewRentalDetails(rentalId);
                }
            });
        }

        // Handle user login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = systemData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                // Store current user
                systemData.currentUser = user;
                saveDataToStorage();
                
                // Switch to main application
                document.body.classList.remove('login-page');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Update UI for current user
                document.getElementById('currentUser').textContent = user.fullName;
                
                // Apply user permissions
                applyUserPermissions(user);
                
                // Show success message
                showAlert('چوونەژوورەوە سەرکەوتوو بوو!', 'success');
            } else {
                showAlert('ناوی بەکارهێنەر یان پاسۆرد هەڵەیە!', 'danger');
                // Shake animation for login form
                const loginForm = document.getElementById('loginForm');
                loginForm.classList.add('shake-animation');
                setTimeout(() => loginForm.classList.remove('shake-animation'), 500);
            }
        }

        // Handle user logout
        function handleLogout() {
            systemData.currentUser = null;
            saveDataToStorage();
            
            // Switch back to login page
            document.body.classList.add('login-page');
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginForm').reset();
            
            // Reset password field to hidden
            const passwordInput = document.getElementById('password');
            passwordInput.setAttribute('type', 'password');
            const toggleIcon = document.getElementById('togglePassword').querySelector('i');
            toggleIcon.className = 'fas fa-eye';
        }

        // Apply user permissions to UI
        function applyUserPermissions(user) {
            const permissions = systemData.permissions[user.role] || [];
            
            // Show/hide admin-only elements
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            adminOnlyElements.forEach(el => {
                el.style.display = user.role === 'admin' ? 'block' : 'none';
            });
            
            // Show/hide modules based on permissions
            const moduleElements = {
                dashboard: document.querySelector('.dashboard-item'),
                vehicles: document.querySelector('.vehicles-item'),
                rentals: document.querySelector('.rentals-customers-item'),
                returns: document.querySelector('.returns-item'),
                maintenance: document.querySelector('.maintenance-item'),
                payments: document.querySelector('.payments-item'),
                fines: document.querySelector('.fines-item'),
                reports: document.querySelector('.reports-item'),
                settings: document.querySelector('.settings-item')
            };
            
            for (const [module, element] of Object.entries(moduleElements)) {
                if (element) {
                    element.style.display = permissions.includes(module) ? 'block' : 'none';
                }
            }
        }

        // Handle adding a new vehicle
        function handleAddVehicle(e) {
            e.preventDefault();
            
            const vehicle = {
                id: generateId(),
                name: document.getElementById('vehicleName').value,
                model: document.getElementById('vehicleModel').value,
                color: document.getElementById('vehicleColor').value,
                plate: document.getElementById('vehiclePlate').value,
                vin: document.getElementById('vehicleVin').value,
                odometer: parseFloat(document.getElementById('vehicleOdometer').value),
                rentalPriceDaily: parseFloat(document.getElementById('vehicleRentalPriceDaily').value),
                rentalPriceWeekly: parseFloat(document.getElementById('vehicleRentalPriceWeekly').value),
                rentalPriceMonthly: parseFloat(document.getElementById('vehicleRentalPriceMonthly').value),
                status: 'available',
                image: null,
                created: new Date().toISOString()
            };
            
            // Handle image upload
            const imageInput = document.getElementById('vehicleImage');
            if (imageInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    vehicle.image = e.target.result;
                    completeAddVehicle(vehicle);
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                completeAddVehicle(vehicle);
            }
        }

        function completeAddVehicle(vehicle) {
            systemData.vehicles.push(vehicle);
            saveDataToStorage();
            
            document.getElementById('addVehicleForm').reset();
            loadVehicleTable();
            
            showAlert('Vehicle added successfully!', 'success');
        }

        // Handle creating a new rental - UPDATED VERSION WITH VALIDATIONS
        function handleCreateRental(e) {
            e.preventDefault();
            
            // Clear any previous error highlights
            clearErrorHighlights();
            
            // 🔴 تێستی نوێ: پشکنین بۆ سەیارەی هەڵبژێردراو
            const vehicleName = document.getElementById('rentalVehicle').value;
            const rentalAmount = document.getElementById('rentalAmount').value;
            const rentalDays = document.getElementById('rentalDays').value;
            const customerName = document.getElementById('rentalCustomer').value;
            const startDate = document.getElementById('rentalStartDate').value;
            const endDate = document.getElementById('rentalEndDate').value;
            
            let hasError = false;
            
            // 1. پشکنین ئایا سەیارە هەڵبژێردراوە
            if (!vehicleName || vehicleName.trim() === '') {
                showAlert('تکایە سەیارەیەک هەڵبژێرە!', 'danger');
                highlightErrorField('rentalVehicle');
                hasError = true;
            } else {
                // 2. پشکنین ئایا سەیارە بوونی هەیە لە سیستەمدا
                const vehicle = systemData.vehicles.find(v => v.name === vehicleName);
                if (!vehicle) {
                    showAlert('سەیارە بوونی نیە! تکایە سەیارەیەکی دروست هەڵبژێرە.', 'danger');
                    highlightErrorField('rentalVehicle');
                    hasError = true;
                } else {
                    // 3. پشکنین ئایا سەیارە بەردەستە (نەکرێدراوە)
                    if (vehicle.status !== 'available') {
                        showAlert('ئەم سەیارەیە بەردەست نیە! سەیارەیەکی تر هەڵبژێرە.', 'danger');
                        highlightErrorField('rentalVehicle');
                        hasError = true;
                    }
                }
            }
            
            // 4. پشکنین ئایا نرخی کرێ دیاریکراوە
            if (!rentalAmount || isNaN(parseFloat(rentalAmount)) || parseFloat(rentalAmount) <= 0) {
                showAlert('نرخی کرێیەکی دروست داخڵ بکە!', 'danger');
                highlightErrorField('rentalAmount');
                hasError = true;
            }
            
            // 5. پشکنین ئایا ماوەی کرێ دیاریکراوە
            if (!rentalDays || isNaN(rentalDays) || parseInt(rentalDays) <= 0) {
                showAlert('ماوەی کرێیەکی دروست داخڵ بکە!', 'danger');
                highlightErrorField('rentalDays');
                hasError = true;
            }
            
            // 6. پشکنین ئایا کڕیار دیاریکراوە
            if (!customerName || customerName.trim() === '') {
                showAlert('تکایە کڕیارێک هەڵبژێرە یان کڕیارێکی نوێ زیاد بکە!', 'danger');
                highlightErrorField('rentalCustomer');
                hasError = true;
            }
            
            // 7. پشکنین ئایا بەرواری دەستپێک دیاریکراوە
            if (!startDate || startDate.trim() === '') {
                showAlert('تکایە بەرواری دەستپێک دیاری بکە!', 'danger');
                highlightErrorField('rentalStartDate');
                hasError = true;
            }
            
            // 8. پشکنین ئایا بەرواری کۆتایی دیاریکراوە
            if (!endDate || endDate.trim() === '') {
                showAlert('تکایە بەرواری کۆتایی دیاری بکە!', 'danger');
                highlightErrorField('rentalEndDate');
                hasError = true;
            }
            
            // 9. پشکنین ئایا بەرواری کۆتایی دوای بەرواری دەستپێکە
            if (startDate && endDate && new Date(endDate) <= new Date(startDate)) {
                showAlert('بەرواری کۆتایی دەبێت دوای بەرواری دەستپێک بێت!', 'danger');
                highlightErrorField('rentalEndDate');
                hasError = true;
            }
            
            // If there are errors, stop processing
            if (hasError) {
                return;
            }
            
            // Check if we need to create a new customer
            let customer = systemData.customers.find(c => c.fullName === customerName);
            
            if (!customer) {
                // پشکنین ئایا فۆرمی کڕیاری نوێ کراوەتەوە
                const customerForm = document.getElementById('newCustomerForm');
                if (customerForm.style.display === 'none' || customerForm.style.display === '') {
                    showAlert('تکایە زانیارییەکانی کڕیاری نوێ پڕبکەوە یان کڕیارێکی تر هەڵبژێرە!', 'danger');
                    highlightErrorField('rentalCustomer');
                    return;
                }
                
                // پشکنینی زانیارییە پێویستەکانی کڕیاری نوێ
                const fullName = document.getElementById('customerFullName').value;
                const dateOfBirth = document.getElementById('customerDateOfBirth').value;
                const idNumber = document.getElementById('customerId').value;
                const nationality = document.getElementById('customerNationality').value;
                const contact = document.getElementById('customerContact').value;
                const address = document.getElementById('customerAddress').value;
                
                let customerErrors = false;
                
                if (!fullName || fullName.trim() === '') {
                    showAlert('ناوی تەواوی کڕیار داخڵ بکە!', 'danger');
                    highlightErrorField('customerFullName');
                    customerErrors = true;
                }
                
                if (!dateOfBirth || dateOfBirth.trim() === '') {
                    showAlert('بەرواری لەدایکبوونی کڕیار دیاری بکە!', 'danger');
                    highlightErrorField('customerDateOfBirth');
                    customerErrors = true;
                } else {
                    // پشکنینی تەمەن
                    const age = calculateAge(dateOfBirth);
                    if (age < 18) {
                        showAlert('کڕیار دەبێت لانی کەم ١٨ ساڵ بێت!', 'danger');
                        highlightErrorField('customerDateOfBirth');
                        customerErrors = true;
                    }
                }
                
                if (!idNumber || idNumber.trim() === '') {
                    showAlert('ناسنامەی کڕیار داخڵ بکە!', 'danger');
                    highlightErrorField('customerId');
                    customerErrors = true;
                }
                
                if (!nationality || nationality.trim() === '') {
                    showAlert('نەتەوەی کڕیار داخڵ بکە!', 'danger');
                    highlightErrorField('customerNationality');
                    customerErrors = true;
                }
                
                if (!contact || contact.trim() === '') {
                    showAlert('ژمارەی پەیوەندی کڕیار داخڵ بکە!', 'danger');
                    highlightErrorField('customerContact');
                    customerErrors = true;
                }
                
                if (!address || address.trim() === '') {
                    showAlert('ناونیشانی کڕیار داخڵ بکە!', 'danger');
                    highlightErrorField('customerAddress');
                    customerErrors = true;
                }
                
                if (customerErrors) {
                    return;
                }
                
                // Create new customer
                customer = {
                    id: generateId(),
                    fullName: fullName,
                    dateOfBirth: dateOfBirth,
                    idNumber: idNumber,
                    nationality: nationality,
                    contact: contact,
                    address: address,
                    guaranteeDoc: null,
                    created: new Date().toISOString()
                };
                
                // Calculate age
                customer.age = calculateAge(customer.dateOfBirth);
                
                // Handle document upload
                const docInput = document.getElementById('guaranteeDoc');
                if (docInput.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        customer.guaranteeDoc = e.target.result;
                        completeCreateRental(customer);
                    };
                    reader.readAsDataURL(docInput.files[0]);
                } else {
                    completeCreateRental(customer);
                }
            } else {
                completeCreateRental(customer);
            }
        }

        function completeCreateRental(customer) {
            // Add customer if new
            if (!systemData.customers.some(c => c.id === customer.id)) {
                systemData.customers.push(customer);
            }
            
            // Find vehicle
            const vehicleName = document.getElementById('rentalVehicle').value;
            const vehicle = systemData.vehicles.find(v => v.name === vehicleName);
            
            if (!vehicle) {
                showAlert('Vehicle not found!', 'danger');
                return;
            }
            
            // Get rental period type and amount
            const periodType = document.getElementById('rentalPeriodType').value;
            const rentalAmount = parseFloat(document.getElementById('rentalAmount').value);
            const rentalDays = parseInt(document.getElementById('rentalDays').value);
            
            // Create rental
            const rental = {
                id: generateId(),
                invoiceCode: document.getElementById('invoiceCode').value || generateInvoiceCode(),
                customerId: customer.id,
                vehicleId: vehicle.id,
                startDate: document.getElementById('rentalStartDate').value,
                endDate: document.getElementById('rentalEndDate').value,
                rentalDays: rentalDays,
                rentalAmount: rentalAmount,
                rentalPeriodType: periodType,
                advancePayment: parseFloat(document.getElementById('advancePayment').value) || 0,
                status: 'active',
                created: new Date().toISOString()
            };
            
            // Update vehicle status
            vehicle.status = 'rented';
            
            systemData.rentals.push(rental);
            saveDataToStorage();
            
            document.getElementById('createRentalForm').reset();
            loadRentalTable();
            loadVehicleTable();
            
            // Show success and print invoice
            showAlert('Rental created successfully!', 'success');
            printInvoice(rental, customer, vehicle);
        }

        // Handle vehicle return - Updated Version
        function handleReturnVehicle(e) {
            e.preventDefault();
            
            const invoiceCode = document.getElementById('returnInvoiceCode').value;
            const returnDate = document.getElementById('returnDate').value;
            const notes = document.getElementById('returnNotes').value;
            
            // Find rental
            const rental = systemData.rentals.find(r => r.invoiceCode === invoiceCode && r.status === 'active');
            
            if (!rental) {
                showAlert('Active rental with this invoice code not found!', 'danger');
                return;
            }
            
            // Update rental status and return date ONLY
            rental.status = 'returned';
            rental.returnDate = returnDate;
            
            // Find vehicle and update status
            const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
            if (vehicle) {
                vehicle.status = 'available';
            }
            
            // Create return record
            const returnRecord = {
                id: generateId(),
                rentalId: rental.id,
                returnDate: returnDate,
                notes: notes,
                created: new Date().toISOString()
            };
            
            systemData.returns.push(returnRecord);
            saveDataToStorage();
            
            document.getElementById('returnVehicleForm').reset();
            loadReturnHistoryTable();
            loadRentalTable();
            loadVehicleTable();
            
            showAlert('Vehicle returned successfully! Customer debt remains unchanged.', 'success');
        }

        // Handle adding maintenance record
        function handleAddMaintenance(e) {
            e.preventDefault();
            
            const vehicleName = document.getElementById('maintenanceVehicle').value;
            const vehicle = systemData.vehicles.find(v => v.name === vehicleName);
            
            if (!vehicle) {
                showAlert('Vehicle not found!', 'danger');
                return;
            }
            
            const maintenance = {
                id: generateId(),
                vehicleId: vehicle.id,
                type: document.getElementById('maintenanceType').value,
                date: document.getElementById('maintenanceDate').value,
                cost: parseFloat(document.getElementById('maintenanceCost').value),
                description: document.getElementById('maintenanceDescription').value,
                created: new Date().toISOString()
            };
            
            systemData.maintenance.push(maintenance);
            saveDataToStorage();
            
            document.getElementById('maintenanceForm').reset();
            loadMaintenanceHistoryTable();
            
            showAlert('Maintenance record added successfully!', 'success');
        }

        // Handle adding payment - Updated with print functionality
        function handleAddPayment(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('paymentCustomerSearch').value;
            const customer = systemData.customers.find(c => c.fullName === customerName);
            
            if (!customer) {
                showAlert('Please select a customer first!', 'danger');
                return;
            }
            
            const payment = {
                id: generateId(),
                customerId: customer.id,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                date: document.getElementById('paymentDate').value,
                type: document.getElementById('paymentType').value,
                description: document.getElementById('paymentDescription').value,
                created: new Date().toISOString()
            };
            
            systemData.payments.push(payment);
            saveDataToStorage();
            
            document.getElementById('addPaymentForm').reset();
            loadCustomerPaymentDetails(customer);
            
            // Show print option
            showAlert('Payment added successfully! <button class="btn btn-sm btn-success ms-2" onclick="printPaymentReceipt(\'' + payment.id + '\')">Print Receipt</button>', 'success');
        }

        // Print payment receipt
        function printPaymentReceipt(paymentId) {
            const payment = systemData.payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const customer = systemData.customers.find(c => c.id === payment.customerId);
            
            // Create print content
            const printContent = `
                <div class="print-only">
                    <div class="invoice-logo">
                        ${systemData.settings.logo ? 
                            `<img src="${systemData.settings.logo}" style="max-width: 200px;">` : 
                            `<i class="fas fa-car fa-3x"></i>`
                        }
                        <h3>${systemData.settings.systemName}</h3>
                    </div>
                    <div class="card">
                        <div class="card-header text-center">
                            <h3>Payment Receipt</h3>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Receipt #:</strong> PAY-${payment.id.substr(-6).toUpperCase()}
                                </div>
                                <div class="col-6 text-end">
                                    <strong>Date:</strong> ${formatDate(payment.date)}
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5>Customer Information</h5>
                                    <table class="table table-bordered">
                                        <tr>
                                            <td><strong>Name:</strong></td>
                                            <td>${customer.fullName}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ID Number:</strong></td>
                                            <td>${customer.idNumber}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Contact:</strong></td>
                                            <td>${customer.contact}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5>Payment Details</h5>
                                    <table class="table table-bordered">
                                        <tr>
                                            <td><strong>Amount:</strong></td>
                                            <td>${payment.amount} ${systemData.settings.currency}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Payment Type:</strong></td>
                                            <td>${payment.type}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Description:</strong></td>
                                            <td>${payment.description || '-'}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Payment Date:</strong></td>
                                            <td>${formatDate(payment.date)}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="row signature-area">
                                <div class="col-6">
                                    <strong>Customer Signature:</strong>
                                    <div style="height: 50px; border-bottom: 1px solid #000; margin-top: 10px;"></div>
                                </div>
                                <div class="col-6 text-end">
                                    <strong>Company Signature:</strong>
                                    <div style="height: 50px; border-bottom: 1px solid #000; margin-top: 10px;"></div>
                                </div>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-12 text-center">
                                    <small>Thank you for your payment!</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Payment Receipt</title>
                        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                        <style>
                            body { font-family: Arial, sans-serif; }
                            .print-only { display: block !important; }
                            .no-print { display: none !important; }
                            .invoice-logo { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                            .signature-area { margin-top: 50px; border-top: 1px solid #000; padding-top: 10px; }
                        </style>
                    </head>
                    <body>
                        ${printContent}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 500);
                            };
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Handle adding fine/tax
        function handleAddFineTax(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('fineCustomer').value;
            const customer = systemData.customers.find(c => c.fullName === customerName);
            
            if (!customer) {
                showAlert('Customer not found!', 'danger');
                return;
            }
            
            const fineTax = {
                id: generateId(),
                customerId: customer.id,
                type: document.getElementById('fineType').value,
                amount: parseFloat(document.getElementById('fineAmount').value),
                date: document.getElementById('fineDate').value,
                description: document.getElementById('fineDescription').value,
                status: 'unpaid',
                created: new Date().toISOString()
            };
            
            systemData.finesTaxes.push(fineTax);
            saveDataToStorage();
            
            document.getElementById('addFineTaxForm').reset();
            loadFinesTaxesTable();
            
            showAlert('Fine/Tax added successfully!', 'success');
        }

        // Handle saving system settings
        function handleSaveSettings(e) {
            e.preventDefault();
            
            systemData.settings.systemName = document.getElementById('systemName').value;
            systemData.settings.currency = document.getElementById('currency').value;
            systemData.settings.dateFormat = document.getElementById('dateFormat').value;
            
            // Handle logo upload
            const logoInput = document.getElementById('systemLogo');
            if (logoInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    systemData.settings.logo = e.target.result;
                    completeSaveSettings();
                };
                reader.readAsDataURL(logoInput.files[0]);
            } else {
                completeSaveSettings();
            }
        }

        function completeSaveSettings() {
            saveDataToStorage();
            applySystemSettings();
            showAlert('Settings saved successfully!', 'success');
        }

        // Handle changing password
        function handleChangePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match!', 'danger');
                return;
            }
            
            if (systemData.currentUser.password !== currentPassword) {
                showAlert('Current password is incorrect!', 'danger');
                return;
            }
            
            systemData.currentUser.password = newPassword;
            
            // Update in users array
            const userIndex = systemData.users.findIndex(u => u.username === systemData.currentUser.username);
            if (userIndex !== -1) {
                systemData.users[userIndex].password = newPassword;
            }
            
            saveDataToStorage();
            
            document.getElementById('changePasswordForm').reset();
            document.getElementById('changePasswordModal').querySelector('.btn-close').click();
            
            showAlert('Password changed successfully!', 'success');
        }

        // Handle adding user
        function handleAddUser(e) {
            e.preventDefault();
            
            const user = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newUserPassword').value,
                fullName: document.getElementById('newFullName').value,
                role: document.getElementById('newUserRole').value,
                status: 'active',
                created: new Date().toISOString()
            };
            
            // Check if username already exists
            if (systemData.users.some(u => u.username === user.username)) {
                showAlert('Username already exists!', 'danger');
                return;
            }
            
            systemData.users.push(user);
            saveDataToStorage();
            
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserModal').querySelector('.btn-close').click();
            loadUserTable();
            
            showAlert('User added successfully!', 'success');
        }

        // Search for payment customer
        function searchPaymentCustomer() {
            const customerName = document.getElementById('paymentCustomerSearch').value;
            const customer = systemData.customers.find(c => c.fullName === customerName);
            
            if (customer) {
                loadCustomerPaymentDetails(customer);
            } else {
                showAlert('Customer not found!', 'danger');
            }
        }

        // Updated function to calculate customer debt - ensures debt is preserved after return
        function calculateCustomerDebt(customerId) {
            const customerRentals = systemData.rentals.filter(r => r.customerId === customerId);
            const customerFines = systemData.finesTaxes.filter(f => f.customerId === customerId && f.status === 'unpaid');
            const customerPayments = systemData.payments.filter(p => p.customerId === customerId);
            
            // Calculate total rental amount (including returned rentals)
            const totalRentalAmount = customerRentals.reduce((sum, rental) => {
                return sum + (rental.rentalAmount * rental.rentalDays);
            }, 0);
            
            // Calculate total advance payments
            const totalAdvancePayment = customerRentals.reduce((sum, rental) => sum + rental.advancePayment, 0);
            
            // Calculate total fines
            const totalFinesTaxes = customerFines.reduce((sum, fine) => sum + fine.amount, 0);
            
            // Calculate total payments made
            const totalAmountPaid = customerPayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            // Total debt = (Total rentals - advance payments) + fines - payments
            const remainingBalance = (totalRentalAmount - totalAdvancePayment) + totalFinesTaxes - totalAmountPaid;
            
            return {
                totalRentalAmount,
                totalAdvancePayment,
                totalFinesTaxes,
                totalAmountPaid,
                remainingBalance
            };
        }

        // Updated loadCustomerPaymentDetails function with payment history management
        function loadCustomerPaymentDetails(customer) {
            document.getElementById('customerPaymentDetails').style.display = 'block';
            
            // Calculate debts using the updated function
            const debtInfo = calculateCustomerDebt(customer.id);
            
            // Update UI
            document.getElementById('totalRentalDebt').textContent = `${debtInfo.totalRentalAmount - debtInfo.totalAdvancePayment} ${systemData.settings.currency}`;
            document.getElementById('totalFinesTaxes').textContent = `${debtInfo.totalFinesTaxes} ${systemData.settings.currency}`;
            document.getElementById('totalAmountPaid').textContent = `${debtInfo.totalAmountPaid} ${systemData.settings.currency}`;
            document.getElementById('remainingBalance').textContent = `${debtInfo.remainingBalance} ${systemData.settings.currency}`;
            
            // Load payment history
            loadPaymentHistoryTable(customer);
        }

        // Delete payment
        function deletePayment(paymentId, customer) {
            if (confirm('Are you sure you want to delete this payment?')) {
                systemData.payments = systemData.payments.filter(p => p.id !== paymentId);
                saveDataToStorage();
                loadCustomerPaymentDetails(customer);
                showAlert('Payment deleted successfully!', 'success');
            }
        }

        // Delete vehicle
        function deleteVehicle(vehicleId) {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                // Check if vehicle is currently rented
                const activeRental = systemData.rentals.find(r => r.vehicleId === vehicleId && r.status === 'active');
                if (activeRental) {
                    showAlert('Cannot delete vehicle that is currently rented!', 'danger');
                    return;
                }
                
                systemData.vehicles = systemData.vehicles.filter(v => v.id !== vehicleId);
                saveDataToStorage();
                loadVehicleTable();
                showAlert('Vehicle deleted successfully!', 'success');
            }
        }

        // Delete maintenance record
        function deleteMaintenance(maintenanceId) {
            if (confirm('Are you sure you want to delete this maintenance record?')) {
                systemData.maintenance = systemData.maintenance.filter(m => m.id !== maintenanceId);
                saveDataToStorage();
                loadMaintenanceHistoryTable();
                showAlert('Maintenance record deleted successfully!', 'success');
            }
        }

        // Delete fine/tax
        function deleteFineTax(fineId) {
            if (confirm('Are you sure you want to delete this fine/tax record?')) {
                systemData.finesTaxes = systemData.finesTaxes.filter(f => f.id !== fineId);
                saveDataToStorage();
                loadFinesTaxesTable();
                showAlert('Fine/Tax record deleted successfully!', 'success');
            }
        }

        // Delete user
        function deleteUser(username) {
            if (username === 'admin') {
                showAlert('Cannot delete admin user!', 'danger');
                return;
            }
            
            if (confirm('Are you sure you want to delete this user?')) {
                systemData.users = systemData.users.filter(u => u.username !== username);
                saveDataToStorage();
                loadUserTable();
                showAlert('User deleted successfully!', 'success');
            }
        }

        // Mark fine as paid
        function markFineAsPaid(fineId) {
            const fine = systemData.finesTaxes.find(f => f.id === fineId);
            if (fine) {
                fine.status = 'paid';
                saveDataToStorage();
                loadFinesTaxesTable();
                showAlert('Fine/Tax marked as paid!', 'success');
            }
        }

        // Edit vehicle
        function editVehicle(vehicleId) {
            const vehicle = systemData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            // Populate form with vehicle data
            document.getElementById('vehicleName').value = vehicle.name;
            document.getElementById('vehicleModel').value = vehicle.model;
            document.getElementById('vehicleColor').value = vehicle.color;
            document.getElementById('vehiclePlate').value = vehicle.plate;
            document.getElementById('vehicleVin').value = vehicle.vin;
            document.getElementById('vehicleOdometer').value = vehicle.odometer;
            document.getElementById('vehicleRentalPriceDaily').value = vehicle.rentalPriceDaily;
            document.getElementById('vehicleRentalPriceWeekly').value = vehicle.rentalPriceWeekly;
            document.getElementById('vehicleRentalPriceMonthly').value = vehicle.rentalPriceMonthly;
            
            // Switch to add vehicle tab
            document.querySelector('[href="#addVehicle"]').click();
            
            showAlert('Vehicle data loaded for editing. Update and submit to save changes.', 'info');
        }

        // Edit customer
        function editCustomer(customerId) {
            const customer = systemData.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Populate form with customer data
            document.getElementById('customerFullName').value = customer.fullName;
            document.getElementById('customerDateOfBirth').value = customer.dateOfBirth;
            calculateAndDisplayAge(customer.dateOfBirth);
            document.getElementById('customerId').value = customer.idNumber;
            document.getElementById('customerNationality').value = customer.nationality;
            document.getElementById('customerContact').value = customer.contact;
            document.getElementById('customerAddress').value = customer.address;
            
            // Switch to rental car tab and show customer form
            document.querySelector('[href="#rentalCar"]').click();
            document.getElementById('newCustomerForm').style.display = 'block';
            document.getElementById('rentalCustomer').value = customer.fullName;
            
            showAlert('Customer data loaded for editing.', 'info');
        }

        // Edit user
        function editUser(username) {
            const user = systemData.users.find(u => u.username === username);
            if (!user) return;
            
            // Populate form with user data
            document.getElementById('newUsername').value = user.username;
            document.getElementById('newFullName').value = user.fullName;
            document.getElementById('newUserRole').value = user.role;
            document.getElementById('newUserPassword').value = user.password;
            
            // Open add user modal
            document.getElementById('addUserModal').querySelector('.modal-title').textContent = 'Edit User';
            new bootstrap.Modal(document.getElementById('addUserModal')).show();
            
            showAlert('User data loaded for editing.', 'info');
        }

        // Print rental invoice
        function printRentalInvoice(rentalId) {
            const rental = systemData.rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            const customer = systemData.customers.find(c => c.id === rental.customerId);
            const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
            
            if (customer && vehicle) {
                printInvoice(rental, customer, vehicle);
            }
        }

        // Print invoice - Updated Version with period type
        function printInvoice(rental, customer, vehicle) {
            // Update print content
            document.getElementById('printInvoiceCode').textContent = rental.invoiceCode;
            document.getElementById('printInvoiceDate').textContent = formatDate(new Date());
            document.getElementById('printCustomerName').textContent = customer.fullName;
            document.getElementById('printCustomerAge').textContent = customer.age || calculateAge(customer.dateOfBirth);
            document.getElementById('printCustomerAddress').textContent = customer.address;
            document.getElementById('printCustomerId').textContent = customer.idNumber;
            document.getElementById('printVehicleName').textContent = vehicle.name;
            document.getElementById('printVehicleModel').textContent = vehicle.model;
            document.getElementById('printVehicleColor').textContent = vehicle.color;
            
            // Set vehicle image
            const vehicleImageContainer = document.getElementById('printVehicleImage');
            if (vehicle.image) {
                vehicleImageContainer.innerHTML = `<img src="${vehicle.image}" style="max-width: 150px; max-height: 100px; object-fit: cover;" alt="${vehicle.name}">`;
            } else {
                vehicleImageContainer.innerHTML = '<i class="fas fa-car fa-2x text-muted"></i>';
            }
            
            // Calculate payment details
            const totalAmount = rental.rentalAmount * rental.rentalDays;
            const advancePayment = rental.advancePayment || 0;
            const remainingBalance = totalAmount - advancePayment;
            
            // Update rental details table
            document.getElementById('printRentalDetails').innerHTML = `
                <tr>
                    <td>${formatDate(rental.startDate)}</td>
                    <td>${formatDate(rental.endDate)}</td>
                    <td>${rental.rentalDays} ${getPeriodTypeLabel(rental.rentalPeriodType)}</td>
                    <td>${rental.rentalPeriodType}</td>
                    <td>${rental.rentalAmount} ${systemData.settings.currency}/${getPeriodTypeShort(rental.rentalPeriodType)}</td>
                    <td>${totalAmount} ${systemData.settings.currency}</td>
                    <td>${advancePayment} ${systemData.settings.currency}</td>
                    <td>${remainingBalance} ${systemData.settings.currency}</td>
                </tr>
            `;
            
            // Update payment summary
            document.getElementById('printTotalAmount').textContent = `${totalAmount} ${systemData.settings.currency}`;
            document.getElementById('printAdvancePayment').textContent = `${advancePayment} ${systemData.settings.currency}`;
            document.getElementById('printRemainingBalance').textContent = `${remainingBalance} ${systemData.settings.currency}`;
            
            // Set logo if available
            const printLogo = document.getElementById('printLogo');
            if (systemData.settings.logo) {
                printLogo.src = systemData.settings.logo;
                printLogo.style.display = 'block';
            } else {
                printLogo.style.display = 'none';
            }
            
            // Set system name
            document.getElementById('printSystemName').textContent = systemData.settings.systemName;
            
            // Print the invoice
            window.print();
        }

        // Helper function to get period type label
        function getPeriodTypeLabel(periodType) {
            switch(periodType) {
                case 'daily': return 'days';
                case 'weekly': return 'weeks';
                case 'monthly': return 'months';
                default: return 'days';
            }
        }

        // Helper function to get period type short label
        function getPeriodTypeShort(periodType) {
            switch(periodType) {
                case 'daily': return 'day';
                case 'weekly': return 'week';
                case 'monthly': return 'month';
                default: return 'day';
            }
        }

        // View Rental Invoice Details
        function viewRentalInvoice(rentalId) {
            const rental = systemData.rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            const customer = systemData.customers.find(c => c.id === rental.customerId);
            const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
            
            if (!customer || !vehicle) {
                showAlert('Customer or vehicle not found!', 'danger');
                return;
            }
            
            // Calculate totals
            const totalAmount = rental.rentalAmount * rental.rentalDays;
            const advancePayment = rental.advancePayment || 0;
            const remainingBalance = totalAmount - advancePayment;
            
            // Create modal for viewing invoice
            const modalHtml = `
                <div class="modal fade" id="viewInvoiceModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Rental Invoice Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="invoice-logo text-center mb-4">
                                    ${systemData.settings.logo ? 
                                        `<img src="${systemData.settings.logo}" style="max-width: 150px;" alt="${systemData.settings.systemName}">` : 
                                        `<i class="fas fa-car fa-3x text-primary"></i>`
                                    }
                                    <h3>${systemData.settings.systemName}</h3>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-6">
                                        <strong>Invoice Code:</strong> ${rental.invoiceCode}
                                    </div>
                                    <div class="col-6 text-end">
                                        <strong>Date:</strong> ${formatDate(rental.created)}
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-6">
                                        <h5>Customer Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Name:</strong></td><td>${customer.fullName}</td></tr>
                                            <tr><td><strong>Age:</strong></td><td>${customer.age || calculateAge(customer.dateOfBirth)}</td></tr>
                                            <tr><td><strong>ID:</strong></td><td>${customer.idNumber}</td></tr>
                                            <tr><td><strong>Contact:</strong></td><td>${customer.contact}</td></tr>
                                            <tr><td><strong>Address:</strong></td><td>${customer.address}</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-6">
                                        <h5>Vehicle Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Vehicle:</strong></td><td>${vehicle.name}</td></tr>
                                            <tr><td><strong>Model:</strong></td><td>${vehicle.model}</td></tr>
                                            <tr><td><strong>Color:</strong></td><td>${vehicle.color}</td></tr>
                                            <tr><td><strong>Plate:</strong></td><td>${vehicle.plate}</td></tr>
                                            <tr><td><strong>Period Type:</strong></td><td>${rental.rentalPeriodType}</td></tr>
                                            <tr><td><strong>Rate:</strong></td><td>${rental.rentalAmount} ${systemData.settings.currency}/${getPeriodTypeShort(rental.rentalPeriodType)}</td></tr>
                                        </table>
                                        ${vehicle.image ? 
                                            `<img src="${vehicle.image}" class="img-fluid mt-2" style="max-height: 100px;" alt="${vehicle.name}">` : 
                                            ''
                                        }
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <h5>Rental Details</h5>
                                        <table class="table table-bordered">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Start Date</th>
                                                    <th>End Date</th>
                                                    <th>Period</th>
                                                    <th>Period Type</th>
                                                    <th>Rate</th>
                                                    <th>Total Amount</th>
                                                    <th>Advance Payment</th>
                                                    <th>Remaining Balance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>${formatDate(rental.startDate)}</td>
                                                    <td>${formatDate(rental.endDate)}</td>
                                                    <td>${rental.rentalDays}</td>
                                                    <td>${rental.rentalPeriodType}</td>
                                                    <td>${rental.rentalAmount} ${systemData.settings.currency}/${getPeriodTypeShort(rental.rentalPeriodType)}</td>
                                                    <td>${totalAmount} ${systemData.settings.currency}</td>
                                                    <td>${advancePayment} ${systemData.settings.currency}</td>
                                                    <td>${remainingBalance} ${systemData.settings.currency}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-12">
                                        <div class="alert ${remainingBalance > 0 ? 'alert-warning' : 'alert-success'}">
                                            <strong>Status:</strong> ${rental.status} | 
                                            <strong>Remaining Balance:</strong> ${remainingBalance} ${systemData.settings.currency}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="printRentalInvoice('${rental.id}')">
                                    <i class="fas fa-print"></i> Print Invoice
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('viewInvoiceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body and show it
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('viewInvoiceModal'));
            modal.show();
        }

        // Delete Rental Function
        function deleteRental(rentalId) {
            const rental = systemData.rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            // Check if rental is active
            if (rental.status === 'active') {
                showAlert('Cannot delete active rental! Please return the vehicle first.', 'danger');
                return;
            }
            
            if (confirm('Are you sure you want to delete this rental record? This action cannot be undone.')) {
                // Find and update vehicle status if it was returned
                if (rental.status === 'returned') {
                    const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
                    if (vehicle) {
                        vehicle.status = 'available';
                    }
                    
                    // Remove return record
                    systemData.returns = systemData.returns.filter(r => r.rentalId !== rental.id);
                }
                
                // Remove rental
                systemData.rentals = systemData.rentals.filter(r => r.id !== rental.id);
                saveDataToStorage();
                
                // Reload tables
                loadRentalTable();
                loadVehicleTable();
                loadReturnHistoryTable();
                
                showAlert('Rental record deleted successfully!', 'success');
            }
        }

        // بینینی وردەکارییەکانی گەیاندنەوە
        function viewReturnDetails(returnId) {
            const returnRecord = systemData.returns.find(r => r.id === returnId);
            if (!returnRecord) return;
            
            const rental = systemData.rentals.find(r => r.id === returnRecord.rentalId);
            const customer = rental ? systemData.customers.find(c => c.id === rental.customerId) : null;
            const vehicle = rental ? systemData.vehicles.find(v => v.id === rental.vehicleId) : null;
            
            if (!rental || !customer || !vehicle) {
                showAlert('Return record details not found!', 'danger');
                return;
            }
            
            const modalHtml = `
                <div class="modal fade" id="viewReturnModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Return Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Rental Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Invoice Code:</strong></td><td>${rental.invoiceCode}</td></tr>
                                            <tr><td><strong>Vehicle:</strong></td><td>${vehicle.name}</td></tr>
                                            <tr><td><strong>Customer:</strong></td><td>${customer.fullName}</td></tr>
                                            <tr><td><strong>Rental Period:</strong></td><td>${formatDate(rental.startDate)} to ${formatDate(rental.endDate)} (${rental.rentalDays} ${getPeriodTypeLabel(rental.rentalPeriodType)})</td></tr>
                                            <tr><td><strong>Period Type:</strong></td><td>${rental.rentalPeriodType}</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Return Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Return Date:</strong></td><td>${formatDate(returnRecord.returnDate)}</td></tr>
                                            <tr><td><strong>Return Time:</strong></td><td>${new Date(returnRecord.created).toLocaleTimeString()}</td></tr>
                                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-success">Returned</span></td></tr>
                                        </table>
                                    </div>
                                </div>
                                
                                ${returnRecord.notes ? `
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h5>Notes</h5>
                                        <div class="alert alert-info">${returnRecord.notes}</div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h5>Payment Summary</h5>
                                        <table class="table table-bordered">
                                            <tr>
                                                <td><strong>Total Rental Amount:</strong></td>
                                                <td>${rental.rentalAmount * rental.rentalDays} ${systemData.settings.currency}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Advance Payment:</strong></td>
                                                <td>${rental.advancePayment} ${systemData.settings.currency}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Remaining Balance:</strong></td>
                                                <td class="fw-bold">${(rental.rentalAmount * rental.rentalDays) - rental.advancePayment} ${systemData.settings.currency}</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('viewReturnModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body and show it
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('viewReturnModal'));
            modal.show();
        }

        // بینینی وردەکارییەکانی چاکسازی
        function viewMaintenanceDetails(maintenanceId) {
            const maintenance = systemData.maintenance.find(m => m.id === maintenanceId);
            if (!maintenance) return;
            
            const vehicle = systemData.vehicles.find(v => v.id === maintenance.vehicleId);
            
            const modalHtml = `
                <div class="modal fade" id="viewMaintenanceModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Maintenance Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Vehicle Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Vehicle:</strong></td><td>${vehicle ? vehicle.name : 'N/A'}</td></tr>
                                            <tr><td><strong>Model:</strong></td><td>${vehicle ? vehicle.model : 'N/A'}</td></tr>
                                            <tr><td><strong>Plate:</strong></td><td>${vehicle ? vehicle.plate : 'N/A'}</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Maintenance Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Type:</strong></td><td>${maintenance.type}</td></tr>
                                            <tr><td><strong>Date:</strong></td><td>${formatDate(maintenance.date)}</td></tr>
                                            <tr><td><strong>Cost:</strong></td><td>${maintenance.cost} ${systemData.settings.currency}</td></tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h5>Description</h5>
                                        <div class="alert alert-info">${maintenance.description}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('viewMaintenanceModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body and show it
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('viewMaintenanceModal'));
            modal.show();
        }

        // بینینی وردەکارییەکانی تاوان
        function viewFineDetails(fineId) {
            const fineTax = systemData.finesTaxes.find(f => f.id === fineId);
            if (!fineTax) return;
            
            const customer = systemData.customers.find(c => c.id === fineTax.customerId);
            
            const modalHtml = `
                <div class="modal fade" id="viewFineModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Fine/Tax Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Customer Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Name:</strong></td><td>${customer ? customer.fullName : 'N/A'}</td></tr>
                                            <tr><td><strong>ID:</strong></td><td>${customer ? customer.idNumber : 'N/A'}</td></tr>
                                            <tr><td><strong>Contact:</strong></td><td>${customer ? customer.contact : 'N/A'}</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Fine/Tax Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Type:</strong></td><td>${fineTax.type}</td></tr>
                                            <tr><td><strong>Amount:</strong></td><td>${fineTax.amount} ${systemData.settings.currency}</td></tr>
                                            <tr><td><strong>Date:</strong></td><td>${formatDate(fineTax.date)}</td></tr>
                                            <tr><td><strong>Status:</strong></td><td>
                                                <span class="badge ${fineTax.status === 'paid' ? 'bg-success' : 'bg-danger'}">
                                                    ${fineTax.status}
                                                </span>
                                            </td></tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h5>Description</h5>
                                        <div class="alert alert-info">${fineTax.description}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                ${fineTax.status === 'unpaid' ? 
                                    `<button type="button" class="btn btn-success" onclick="markFineAsPaid('${fineTax.id}'); document.getElementById('viewFineModal').querySelector('.btn-close').click();">
                                        Mark as Paid
                                    </button>` : ''
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('viewFineModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body and show it
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('viewFineModal'));
            modal.show();
        }

        // بینینی وردەکارییەکانی پارەدان
        function viewPaymentDetails(paymentId) {
            const payment = systemData.payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const customer = systemData.customers.find(c => c.id === payment.customerId);
            
            const modalHtml = `
                <div class="modal fade" id="viewPaymentModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Payment Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-12">
                                        <table class="table table-bordered">
                                            <tr><td><strong>Customer:</strong></td><td>${customer ? customer.fullName : 'N/A'}</td></tr>
                                            <tr><td><strong>Amount:</strong></td><td>${payment.amount} ${systemData.settings.currency}</td></tr>
                                            <tr><td><strong>Date:</strong></td><td>${formatDate(payment.date)}</td></tr>
                                            <tr><td><strong>Type:</strong></td><td>${payment.type}</td></tr>
                                            <tr><td><strong>Description:</strong></td><td>${payment.description || '-'}</td></tr>
                                            <tr><td><strong>Payment Time:</strong></td><td>${new Date(payment.created).toLocaleString()}</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('viewPaymentModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body and show it
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('viewPaymentModal'));
            modal.show();
        }

        // بینینی وردەکارییەکانی کرێ
        function viewRentalDetails(rentalId) {
            const rental = systemData.rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            const customer = systemData.customers.find(c => c.id === rental.customerId);
            const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
            
            if (!customer || !vehicle) {
                showAlert('Rental details not found!', 'danger');
                return;
            }
            
            const modalHtml = `
                <div class="modal fade" id="viewRentalModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Rental Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Customer Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Name:</strong></td><td>${customer.fullName}</td></tr>
                                            <tr><td><strong>Age:</strong></td><td>${customer.age || calculateAge(customer.dateOfBirth)}</td></tr>
                                            <tr><td><strong>ID:</strong></td><td>${customer.idNumber}</td></tr>
                                            <tr><td><strong>Contact:</strong></td><td>${customer.contact}</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Vehicle Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Vehicle:</strong></td><td>${vehicle.name}</td></tr>
                                            <tr><td><strong>Model:</strong></td><td>${vehicle.model}</td></tr>
                                            <tr><td><strong>Color:</strong></td><td>${vehicle.color}</td></tr>
                                            <tr><td><strong>Plate:</strong></td><td>${vehicle.plate}</td></tr>
                                            <tr><td><strong>Period Type:</strong></td><td>${rental.rentalPeriodType}</td></tr>
                                            <tr><td><strong>Rate:</strong></td><td>${rental.rentalAmount} ${systemData.settings.currency}/${getPeriodTypeShort(rental.rentalPeriodType)}</td></tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <h5>Rental Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Invoice Code:</strong></td><td>${rental.invoiceCode}</td></tr>
                                            <tr><td><strong>Start Date:</strong></td><td>${formatDate(rental.startDate)}</td></tr>
                                            <tr><td><strong>End Date:</strong></td><td>${formatDate(rental.endDate)}</td></tr>
                                            <tr><td><strong>Rental Period:</strong></td><td>${rental.rentalDays} ${getPeriodTypeLabel(rental.rentalPeriodType)}</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Payment Information</h5>
                                        <table class="table table-bordered table-sm">
                                            <tr><td><strong>Rate:</strong></td><td>${rental.rentalAmount} ${systemData.settings.currency}/${getPeriodTypeShort(rental.rentalPeriodType)}</td></tr>
                                            <tr><td><strong>Total Amount:</strong></td><td>${rental.rentalAmount * rental.rentalDays} ${systemData.settings.currency}</td></tr>
                                            <tr><td><strong>Advance Payment:</strong></td><td>${rental.advancePayment} ${systemData.settings.currency}</td></tr>
                                            <tr><td><strong>Remaining Balance:</strong></td><td class="fw-bold">${(rental.rentalAmount * rental.rentalDays) - rental.advancePayment} ${systemData.settings.currency}</td></tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="alert ${rental.status === 'active' ? 'alert-warning' : 'alert-success'}">
                                            <strong>Status:</strong> ${rental.status} | 
                                            <strong>Return Date:</strong> ${rental.returnDate ? formatDate(rental.returnDate) : 'Not Returned'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="printRentalInvoice('${rental.id}')">
                                    <i class="fas fa-print"></i> Print Invoice
                                </button>
                                ${rental.status === 'returned' ? 
                                    `<button type="button" class="btn btn-danger" onclick="deleteRental('${rental.id}'); document.getElementById('viewRentalModal').querySelector('.btn-close').click();">
                                        <i class="fas fa-trash"></i> Delete Rental
                                    </button>` : ''
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('viewRentalModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body and show it
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('viewRentalModal'));
            modal.show();
        }

        // سڕینەوەی تۆمارێکی گەیاندنەوە
        function deleteReturn(returnId) {
            const returnRecord = systemData.returns.find(r => r.id === returnId);
            if (!returnRecord) return;
            
            const rental = systemData.rentals.find(r => r.id === returnRecord.rentalId);
            
            if (confirm('Are you sure you want to delete this return record? This will make the rental active again.')) {
                // Make rental active again
                if (rental) {
                    rental.status = 'active';
                    rental.returnDate = null;
                    
                    // Make vehicle rented again
                    const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
                    if (vehicle) {
                        vehicle.status = 'rented';
                    }
                }
                
                // Remove return record
                systemData.returns = systemData.returns.filter(r => r.id !== returnId);
                saveDataToStorage();
                
                // Reload tables
                loadReturnHistoryTable();
                loadRentalTable();
                loadVehicleTable();
                
                showAlert('Return record deleted successfully!', 'success');
            }
        }

        // سڕینەوەی تۆمارێکی پارەدان
        function deletePaymentRecord(paymentId) {
            const payment = systemData.payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            if (confirm('Are you sure you want to delete this payment record?')) {
                systemData.payments = systemData.payments.filter(p => p.id !== paymentId);
                saveDataToStorage();
                
                // Reload payment tables if open
                const customer = systemData.customers.find(c => c.id === payment.customerId);
                if (customer && document.getElementById('customerPaymentDetails').style.display === 'block') {
                    loadCustomerPaymentDetails(customer);
                }
                
                showAlert('Payment record deleted successfully!', 'success');
            }
        }

        // Toggle customer form visibility
        function toggleCustomerForm() {
            const form = document.getElementById('newCustomerForm');
            form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
        }

        // Close vehicle details
        function closeVehicleDetails() {
            document.getElementById('vehicleDetailsCard').style.display = 'none';
        }

        // Close customer details
        function closeCustomerDetails() {
            document.getElementById('customerDetailsCard').style.display = 'none';
        }

        // Generate Customer Rental Report - FIXED VERSION
        function generateCustomerRentalReport(e) {
            if (e) e.preventDefault();
            
            const customerName = document.getElementById('reportCustomer').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            // Find customer
            const customer = systemData.customers.find(c => 
                c.fullName.toLowerCase().includes(customerName.toLowerCase())
            );
            
            if (!customer) {
                showAlert('Customer not found!', 'danger');
                return;
            }
            
            // Get customer rentals
            let customerRentals = systemData.rentals.filter(r => r.customerId === customer.id);
            
            // Apply date filters if provided
            if (startDate) {
                customerRentals = customerRentals.filter(r => r.startDate >= startDate);
            }
            
            if (endDate) {
                customerRentals = customerRentals.filter(r => r.startDate <= endDate);
            }
            
            // Update report table
            const tableBody = document.getElementById('customerRentalReportBody');
            tableBody.innerHTML = '';
            
            let totalRentalAmount = 0;
            let totalAdvancePayment = 0;
            let totalPayment = 0;
            let totalDebt = 0;
            
            customerRentals.forEach(rental => {
                const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
                const rentalPayments = systemData.payments.filter(p => p.customerId === customer.id);
                const totalPaid = rentalPayments.reduce((sum, payment) => sum + payment.amount, 0);
                const totalAmount = rental.rentalAmount * rental.rentalDays;
                const remainingDebt = totalAmount - rental.advancePayment - totalPaid;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vehicle ? vehicle.name : 'N/A'}</td>
                    <td>${formatDate(rental.startDate)}</td>
                    <td>${rental.returnDate ? formatDate(rental.returnDate) : 'Not Returned'}</td>
                    <td>${rental.rentalDays}</td>
                    <td>${rental.rentalPeriodType}</td>
                    <td>${formatCurrency(rental.rentalAmount)}/${getPeriodTypeShort(rental.rentalPeriodType)}</td>
                    <td>${formatCurrency(totalAmount)}</td>
                    <td>${formatCurrency(rental.advancePayment)}</td>
                    <td>${formatCurrency(totalPaid)}</td>
                    <td>${formatCurrency(remainingDebt)}</td>
                    <td>
                        <span class="badge ${rental.status === 'active' ? 'bg-warning' : 'bg-success'}">
                            ${rental.status}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
                
                // Update totals
                totalRentalAmount += totalAmount;
                totalAdvancePayment += rental.advancePayment;
                totalPayment += totalPaid;
                totalDebt += remainingDebt;
            });
            
            // Update totals in the table footer
            document.getElementById('totalRentalAmount').textContent = formatCurrency(totalRentalAmount);
            document.getElementById('totalAdvancePayment').textContent = formatCurrency(totalAdvancePayment);
            document.getElementById('totalPayment').textContent = formatCurrency(totalPayment);
            document.getElementById('totalDebt').textContent = formatCurrency(totalDebt);
            
            showAlert('Customer rental report generated successfully!', 'success');
        }

        // Export Customer Rental Report to Excel
        function exportCustomerRentalReport() {
            const customerName = document.getElementById('reportCustomer').value;
            
            if (!customerName) {
                showAlert('Please generate a report first!', 'warning');
                return;
            }
            
            // Find customer
            const customer = systemData.customers.find(c => 
                c.fullName.toLowerCase().includes(customerName.toLowerCase())
            );
            
            if (!customer) {
                showAlert('Customer not found!', 'danger');
                return;
            }
            
            // Get customer rentals
            let customerRentals = systemData.rentals.filter(r => r.customerId === customer.id);
            
            // Create CSV content
            let csvContent = "Vehicle Name,Rental Date,Return Date,Rental Period,Period Type,Rental Amount,Total Amount,Advance Payment,Total Payment,Total Debt,Status\n";
            
            customerRentals.forEach(rental => {
                const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
                const vehicleName = vehicle ? vehicle.name : 'N/A';
                const returnDate = rental.returnDate ? formatDate(rental.returnDate) : 'Not Returned';
                const rentalPayments = systemData.payments.filter(p => p.customerId === customer.id);
                const totalPaid = rentalPayments.reduce((sum, payment) => sum + payment.amount, 0);
                const totalAmount = rental.rentalAmount * rental.rentalDays;
                const remainingDebt = totalAmount - rental.advancePayment - totalPaid;
                
                csvContent += `"${vehicleName}","${formatDate(rental.startDate)}","${returnDate}","${rental.rentalDays}","${rental.rentalPeriodType}","${rental.rentalAmount} ${systemData.settings.currency}/${getPeriodTypeShort(rental.rentalPeriodType)}","${totalAmount}","${rental.advancePayment}","${totalPaid}","${remainingDebt}","${rental.status}"\n`;
            });
            
            // Create and download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `customer_rental_report_${customer.fullName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Customer rental report exported to Excel successfully!', 'success');
        }

        // Save permissions
        function savePermissions() {
            const role = document.getElementById('permissionRole').value;
            const permissions = [];
            
            document.querySelectorAll('.module-permission:checked').forEach(checkbox => {
                permissions.push(checkbox.value);
            });
            
            systemData.permissions[role] = permissions;
            saveDataToStorage();
            
            showAlert('Permissions saved successfully!', 'success');
        }

        // Load role permissions
        function loadRolePermissions() {
            const role = document.getElementById('permissionRole').value;
            const permissions = systemData.permissions[role] || [];
            
            // Uncheck all first
            document.querySelectorAll('.module-permission').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Check the ones that are in permissions
            permissions.forEach(permission => {
                const checkbox = document.querySelector(`.module-permission[value="${permission}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }

        // Add new role
        function addNewRole() {
            const roleName = prompt('Enter new role name:');
            if (roleName && !systemData.roles.includes(roleName)) {
                systemData.roles.push(roleName);
                systemData.permissions[roleName] = [];
                
                // Update role dropdowns
                updateRoleDropdowns();
                
                saveDataToStorage();
                showAlert('Role added successfully!', 'success');
            } else if (roleName) {
                showAlert('Role already exists!', 'danger');
            }
        }

        // Delete role
        function deleteRole() {
            const role = document.getElementById('permissionRole').value;
            
            if (role === 'admin') {
                showAlert('Cannot delete admin role!', 'danger');
                return;
            }
            
            if (confirm(`Are you sure you want to delete the ${role} role? This will affect all users with this role.`)) {
                // Remove role from system
                systemData.roles = systemData.roles.filter(r => r !== role);
                delete systemData.permissions[role];
                
                // Update users with this role to 'staff'
                systemData.users.forEach(user => {
                    if (user.role === role) {
                        user.role = 'staff';
                    }
                });
                
                // Update role dropdowns
                updateRoleDropdowns();
                
                saveDataToStorage();
                showAlert('Role deleted successfully!', 'success');
            }
        }

        // Update role dropdowns
        function updateRoleDropdowns() {
            const roleSelects = [
                document.getElementById('permissionRole'),
                document.getElementById('newUserRole')
            ];
            
            roleSelects.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '';
                    
                    systemData.roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role;
                        option.textContent = role;
                        select.appendChild(option);
                    });
                    
                    // Try to restore previous selection
                    if (systemData.roles.includes(currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
            
            // Reload permissions for current role
            loadRolePermissions();
        }

        // Backup and Restore Functions
        // Create backup function
        function createBackup() {
            // Get current data
            const dataToBackup = {
                systemData: systemData,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            // Create blob and download link
            const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Create filename with timestamp
            const date = new Date();
            const filename = `car_rental_backup_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}.json`;
            
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Save backup info to localStorage
            saveBackupInfo(filename, blob.size);
            
            showAlert('باکەپ بە سەرکەوتوویی دروست کرا!', 'success');
        }

        // Restore backup function
        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('تکایە فایلێکی باکەپ هەڵبژێرە!', 'warning');
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                showAlert('تکایە فایلێکی JSON هەڵبژێرە!', 'danger');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Verify backup structure
                    if (!backupData.systemData || !backupData.timestamp) {
                        showAlert('فایلی باکەپ نادروستە!', 'danger');
                        return;
                    }
                    
                    // Confirm restore action
                    if (confirm('ئایا دڵنیای کە دەتەوێت هەموو داتاکانی ئێستا بسڕیتەوە و باکەپەکە باربکەیت؟ ئەم کردارە ناگەڕێتەوە!')) {
                        // Restore data
                        Object.keys(systemData).forEach(key => {
                            if (backupData.systemData[key]) {
                                systemData[key] = backupData.systemData[key];
                            }
                        });
                        
                        // Save to localStorage
                        saveDataToStorage();
                        
                        // Reload the page to reflect changes
                        location.reload();
                        
                        showAlert('باکەپ بە سەرکەوتوویی بارکرایەوە!', 'success');
                    }
                } catch (error) {
                    console.error('Error restoring backup:', error);
                    showAlert('هەڵە لە خوێندنەوەی فایلی باکەپ!', 'danger');
                }
            };
            
            reader.onerror = function() {
                showAlert('هەڵە لە خوێندنەوەی فایل!', 'danger');
            };
            
            reader.readAsText(file);
        }

        // Save backup information to localStorage
        function saveBackupInfo(filename, size) {
            let backupHistory = JSON.parse(localStorage.getItem('backupHistory') || '[]');
            
            backupHistory.unshift({
                filename: filename,
                size: size,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 10 backups in history
            if (backupHistory.length > 10) {
                backupHistory = backupHistory.slice(0, 10);
            }
            
            localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
            
            // Update backup history table
            loadBackupHistory();
        }

        // Load backup history
        function loadBackupHistory() {
            const backupHistory = JSON.parse(localStorage.getItem('backupHistory') || '[]');
            const tableBody = document.getElementById('backupHistoryTable');
            
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (backupHistory.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">هیچ باکەپێک بوونی نیە</td>
                    </tr>
                `;
                return;
            }
            
            backupHistory.forEach(backup => {
                const date = new Date(backup.timestamp);
                const formattedDate = date.toLocaleString();
                const sizeInKB = (backup.size / 1024).toFixed(2);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${backup.filename}</td>
                    <td>${sizeInKB} KB</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary download-backup" data-filename="${backup.filename}">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-backup" data-filename="${backup.filename}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Add event listeners for download and delete buttons
            document.querySelectorAll('.download-backup').forEach(button => {
                button.addEventListener('click', function() {
                    const filename = this.getAttribute('data-filename');
                    downloadBackup(filename);
                });
            });
            
            document.querySelectorAll('.delete-backup').forEach(button => {
                button.addEventListener('click', function() {
                    const filename = this.getAttribute('data-filename');
                    deleteBackup(filename);
                });
            });
        }

        // Download specific backup
        function downloadBackup(filename) {
            // In a real application, this would retrieve the actual backup file
            // For this demo, we'll create a new backup with the requested filename
            const dataToBackup = {
                systemData: systemData,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert(`باکەپی ${filename} بارکرا!`, 'success');
        }

        // Delete backup from history
        function deleteBackup(filename) {
            if (confirm(`ئایا دڵنیای کە دەتەوێت باکەپی ${filename} بسڕیتەوە؟`)) {
                let backupHistory = JSON.parse(localStorage.getItem('backupHistory') || '[]');
                backupHistory = backupHistory.filter(backup => backup.filename !== filename);
                localStorage.setItem('backupHistory', JSON.stringify(backupHistory));
                loadBackupHistory();
                showAlert('باکەپ سڕدرایەوە!', 'success');
            }
        }

        // Auto backup function (optional - runs automatically)
        function autoBackup() {
            // Check if auto backup is enabled and last backup was more than 24 hours ago
            const lastBackup = localStorage.getItem('lastAutoBackup');
            const now = new Date().getTime();
            
            if (!lastBackup || (now - parseInt(lastBackup)) > 24 * 60 * 60 * 1000) {
                createBackup();
                localStorage.setItem('lastAutoBackup', now.toString());
            }
        }

        // دەستکاری نوێ: فەنکشنی ڕەنگکردنی هەڵە بۆ خانەکان
        function highlightErrorField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.add('error-field');
                
                // لابردنی ڕەنگەکە دوای چەند چرکەیەک
                setTimeout(() => {
                    field.classList.remove('error-field');
                }, 3000);
            }
        }

        // دەستکاری نوێ: فەنکشنی پاککردنەوەی هەموو ڕەنگی هەڵەکان
        function clearErrorHighlights() {
            document.querySelectorAll('.error-field').forEach(field => {
                field.classList.remove('error-field');
            });
        }

        // Setup auto-suggestions
        function setupAutoSuggestions() {
            // Color suggestions
            const colors = ['Red', 'Blue', 'Green', 'Black', 'White', 'Silver', 'Gray', 'Yellow', 'Orange', 'Purple'];
            setupSuggestionInput('vehicleColor', 'colorSuggestions', colors);
            
            // Model suggestions
            const models = ['2020', '2021', '2022', '2023', '2024'];
            setupSuggestionInput('vehicleModel', 'modelSuggestions', models);
            
            // Customer suggestions
            setupCustomerSuggestions();
            
            // Vehicle suggestions
            setupVehicleSuggestions();
            
            // Invoice suggestions
            setupInvoiceSuggestions();
            
            // Nationality suggestions
            const nationalities = ['United Arab Emirates', 'Saudi Arabia', 'Oman', 'Kuwait', 'Qatar', 'Bahrain', 'Egypt', 'Jordan', 'Lebanon', 'Syria', 'India', 'Pakistan', 'Bangladesh', 'Philippines', 'United States', 'United Kingdom', 'Canada', 'Australia'];
            setupSuggestionInput('customerNationality', 'nationalitySuggestions', nationalities);
            
            // Payment customer suggestions
            setupSuggestionInput('paymentCustomerSearch', 'paymentCustomerSuggestions', systemData.customers.map(c => c.fullName));
            
            // Fine customer suggestions
            setupSuggestionInput('fineCustomer', 'fineCustomerSuggestions', systemData.customers.map(c => c.fullName));
            
            // Maintenance vehicle suggestions
            setupSuggestionInput('maintenanceVehicle', 'maintenanceVehicleSuggestions', systemData.vehicles.map(v => v.name));
            
            // Report customer suggestions
            setupSuggestionInput('reportCustomer', 'reportCustomerSuggestions', systemData.customers.map(c => c.fullName));
        }

        // Setup suggestion input
        function setupSuggestionInput(inputId, suggestionId, suggestions) {
            const input = document.getElementById(inputId);
            const suggestionList = document.getElementById(suggestionId);
            
            if (!input || !suggestionList) return;
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const filtered = suggestions.filter(s => s.toLowerCase().includes(value));
                
                if (filtered.length > 0 && value) {
                    suggestionList.innerHTML = '';
                    filtered.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = item;
                        div.addEventListener('click', function() {
                            input.value = item;
                            suggestionList.style.display = 'none';
                            // پاککردنەوەی ڕەنگی هەڵە کاتێک بەشێوەیەکی دروست هەڵدەبژێردرێت
                            input.classList.remove('error-field');
                        });
                        suggestionList.appendChild(div);
                    });
                    suggestionList.style.display = 'block';
                } else {
                    suggestionList.style.display = 'none';
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== input) {
                    suggestionList.style.display = 'none';
                }
            });
        }

        // Setup customer suggestions
        function setupCustomerSuggestions() {
            const input = document.getElementById('rentalCustomer');
            const suggestionList = document.getElementById('customerSuggestions');
            
            if (!input || !suggestionList) return;
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const filtered = systemData.customers.filter(c => 
                    c.fullName.toLowerCase().includes(value)
                );
                
                if (filtered.length > 0 && value) {
                    suggestionList.innerHTML = '';
                    filtered.forEach(customer => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = customer.fullName;
                        div.addEventListener('click', function() {
                            input.value = customer.fullName;
                            suggestionList.style.display = 'none';
                            
                            // Hide new customer form if showing
                            document.getElementById('newCustomerForm').style.display = 'none';
                            // پاککردنەوەی ڕەنگی هەڵە
                            input.classList.remove('error-field');
                        });
                        suggestionList.appendChild(div);
                    });
                    suggestionList.style.display = 'block';
                } else {
                    suggestionList.style.display = 'none';
                }
            });
        }

        // Setup vehicle suggestions
        function setupVehicleSuggestions() {
            const input = document.getElementById('rentalVehicle');
            const suggestionList = document.getElementById('vehicleSuggestions');
            
            if (!input || !suggestionList) return;
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const filtered = systemData.vehicles.filter(v => 
                    v.status === 'available' && v.name.toLowerCase().includes(value)
                );
                
                if (filtered.length > 0 && value) {
                    suggestionList.innerHTML = '';
                    filtered.forEach(vehicle => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = vehicle.name;
                        div.addEventListener('click', function() {
                            input.value = vehicle.name;
                            // Update rental amount based on current period type
                            updateRentalAmountByPeriodType();
                            suggestionList.style.display = 'none';
                            // پاککردنەوەی ڕەنگی هەڵە
                            input.classList.remove('error-field');
                        });
                        suggestionList.appendChild(div);
                    });
                    suggestionList.style.display = 'block';
                } else {
                    suggestionList.style.display = 'none';
                }
            });
        }

        // Setup invoice suggestions
        function setupInvoiceSuggestions() {
            const input = document.getElementById('returnInvoiceCode');
            const suggestionList = document.getElementById('invoiceSuggestions');
            
            if (!input || !suggestionList) return;
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const filtered = systemData.rentals.filter(r => 
                    r.status === 'active' && r.invoiceCode.toLowerCase().includes(value)
                );
                
                if (filtered.length > 0 && value) {
                    suggestionList.innerHTML = '';
                    filtered.forEach(rental => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = rental.invoiceCode;
                        div.addEventListener('click', function() {
                            input.value = rental.invoiceCode;
                            suggestionList.style.display = 'none';
                        });
                        suggestionList.appendChild(div);
                    });
                    suggestionList.style.display = 'block';
                } else {
                    suggestionList.style.display = 'none';
                }
            });
        }

        // Load dashboard data - Updated Version with auto-refresh
        function loadDashboardData() {
            // Update statistics
            const availableVehicles = systemData.vehicles.filter(v => v.status === 'available').length;
            const rentedVehicles = systemData.vehicles.filter(v => v.status === 'rented').length;
            const activeRentals = systemData.rentals.filter(r => r.status === 'active').length;
            const totalCustomers = systemData.customers.length;
            
            // Calculate total payments including advance payments from rentals
            const totalAdvancePayments = systemData.rentals.reduce((sum, rental) => sum + rental.advancePayment, 0);
            const totalPaymentSectionPayments = systemData.payments.reduce((sum, payment) => sum + payment.amount, 0);
            const totalPayments = totalAdvancePayments + totalPaymentSectionPayments;
            
            document.getElementById('dashboardStats').innerHTML = `
                <div class="col-md-2">
                    <div class="card dashboard-card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${availableVehicles}</h4>
                                    <p>Available Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-car fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${rentedVehicles}</h4>
                                    <p>Rented Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-key fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${activeRentals}</h4>
                                    <p>Active Rentals</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clipboard-list fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${totalCustomers}</h4>
                                    <p>Total Customers</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${totalPayments}</h4>
                                    <p>Total Payments</p>
                                    <small class="opacity-75">(Includes advance payments)</small>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-secondary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${systemData.vehicles.length}</h4>
                                    <p>Total Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-car-side fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load recent rentals
            const recentRentals = systemData.rentals.slice(-5).reverse();
            const recentRentalsBody = document.getElementById('recentRentalsTable');
            recentRentalsBody.innerHTML = '';
            
            recentRentals.forEach(rental => {
                const customer = systemData.customers.find(c => c.id === rental.customerId);
                const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
                
                if (customer && vehicle) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.fullName}</td>
                        <td>${vehicle.name}</td>
                        <td>${formatDate(rental.startDate)}</td>
                        <td>${rental.rentalAmount * rental.rentalDays} ${systemData.settings.currency}</td>
                        <td><span class="badge ${rental.status === 'active' ? 'bg-success' : 'bg-secondary'}">${rental.status}</span></td>
                    `;
                    recentRentalsBody.appendChild(row);
                }
            });
            
            // Load vehicle status chart
            loadVehicleStatusChart();
        }

        // Auto-refresh dashboard every 30 seconds
        setInterval(function() {
            if (document.getElementById('dashboard').classList.contains('active')) {
                loadDashboardData();
            }
        }, 30000);

        // Load vehicle status chart
        function loadVehicleStatusChart() {
            const ctx = document.getElementById('vehicleStatusChart');
            if (!ctx) return;
            
            const available = systemData.vehicles.filter(v => v.status === 'available').length;
            const rented = systemData.vehicles.filter(v => v.status === 'rented').length;
            const maintenance = systemData.vehicles.filter(v => v.status === 'maintenance').length;
            
            // Destroy existing chart if it exists
            if (window.vehicleStatusChart) {
                window.vehicleStatusChart.destroy();
            }
            
            window.vehicleStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Rented', 'Maintenance'],
                    datasets: [{
                        data: [available, rented, maintenance],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(0, 123, 255, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(0, 123, 255, 1)',
                            'rgba(255, 193, 7, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Load vehicle table - Updated with rental prices
        function loadVehicleTable() {
            const vehicleTableBody = document.getElementById('vehicleTableBody');
            if (!vehicleTableBody) return;
            
            vehicleTableBody.innerHTML = '';
            
            systemData.vehicles.forEach(vehicle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        ${vehicle.image ? 
                            `<img src="${vehicle.image}" class="vehicle-image" alt="${vehicle.name}">` : 
                            '<i class="fas fa-car fa-2x text-muted"></i>'
                        }
                    </td>
                    <td>${vehicle.name}</td>
                    <td>${vehicle.model}</td>
                    <td>${vehicle.color}</td>
                    <td>${vehicle.plate}</td>
                    <td>${vehicle.odometer}</td>
                    <td>
                        <small>Daily: ${vehicle.rentalPriceDaily} ${systemData.settings.currency}</small><br>
                        <small>Weekly: ${vehicle.rentalPriceWeekly} ${systemData.settings.currency}</small><br>
                        <small>Monthly: ${vehicle.rentalPriceMonthly} ${systemData.settings.currency}</small>
                    </td>
                    <td>
                        <span class="badge ${vehicle.status === 'available' ? 'bg-success' : 
                                          vehicle.status === 'rented' ? 'bg-primary' : 'bg-warning'}">
                            ${vehicle.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info view-vehicle" data-id="${vehicle.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning edit-vehicle" data-id="${vehicle.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-vehicle" data-id="${vehicle.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                vehicleTableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-vehicle').forEach(button => {
                button.addEventListener('click', function() {
                    const vehicleId = this.getAttribute('data-id');
                    viewVehicleDetails(vehicleId);
                });
            });
        }

        // Load customer table - Updated with calculated age
        function loadCustomerTable() {
            const customerTableBody = document.getElementById('customerTableBody');
            if (!customerTableBody) return;
            
            customerTableBody.innerHTML = '';
            
            systemData.customers.forEach(customer => {
                // Calculate age if not already calculated
                if (!customer.age && customer.dateOfBirth) {
                    customer.age = calculateAge(customer.dateOfBirth);
                }
                
                // Calculate total debt
                const customerRentals = systemData.rentals.filter(r => r.customerId === customer.id);
                const customerFines = systemData.finesTaxes.filter(f => f.customerId === customer.id && f.status === 'unpaid');
                
                const totalRentalDebt = customerRentals.reduce((sum, rental) => {
                    const rentalAmount = rental.rentalAmount * rental.rentalDays;
                    return sum + (rentalAmount - rental.advancePayment);
                }, 0);
                
                const totalFinesDebt = customerFines.reduce((sum, fine) => sum + fine.amount, 0);
                const totalDebt = totalRentalDebt + totalFinesDebt;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.fullName}</td>
                    <td>${customer.age || 'N/A'}</td>
                    <td>${customer.idNumber}</td>
                    <td>${customer.nationality}</td>
                    <td>${customer.contact}</td>
                    <td>${totalDebt} ${systemData.settings.currency}</td>
                    <td>
                        <button class="btn btn-sm btn-info view-customer" data-id="${customer.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning edit-customer" data-id="${customer.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                customerTableBody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-customer').forEach(button => {
                button.addEventListener('click', function() {
                    const customerId = this.getAttribute('data-id');
                    viewCustomerDetails(customerId);
                });
            });
        }

        // Load rental table - Updated with period type
        function loadRentalTable() {
            const rentalTableBody = document.getElementById('rentalTableBody');
            if (!rentalTableBody) return;
            
            rentalTableBody.innerHTML = '';
            
            systemData.rentals.forEach(rental => {
                const customer = systemData.customers.find(c => c.id === rental.customerId);
                const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
                
                if (customer && vehicle) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${rental.invoiceCode}</td>
                        <td>${customer.fullName}</td>
                        <td>${vehicle.name}</td>
                        <td>${formatDate(rental.startDate)}</td>
                        <td>${formatDate(rental.endDate)}</td>
                        <td>${rental.rentalAmount * rental.rentalDays} ${systemData.settings.currency}</td>
                        <td>${rental.rentalPeriodType}</td>
                        <td>
                            <span class="badge ${rental.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                ${rental.status}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info view-rental" data-id="${rental.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary print-invoice" data-id="${rental.id}">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-sm btn-warning view-invoice" data-id="${rental.id}">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-rental" data-id="${rental.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    rentalTableBody.appendChild(row);
                }
            });
        }

        // Load return history table
        function loadReturnHistoryTable() {
            const returnHistoryBody = document.getElementById('returnHistoryTableBody');
            if (!returnHistoryBody) return;
            
            returnHistoryBody.innerHTML = '';
            
            systemData.returns.forEach(returnRecord => {
                const rental = systemData.rentals.find(r => r.id === returnRecord.rentalId);
                
                if (rental) {
                    const customer = systemData.customers.find(c => c.id === rental.customerId);
                    const vehicle = systemData.vehicles.find(v => v.id === rental.vehicleId);
                    
                    if (customer && vehicle) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${rental.invoiceCode}</td>
                            <td>${customer.fullName}</td>
                            <td>${vehicle.name}</td>
                            <td>${formatDate(returnRecord.returnDate)}</td>
                            <td>${returnRecord.notes || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-return" data-id="${returnRecord.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-return" data-id="${returnRecord.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        returnHistoryBody.appendChild(row);
                    }
                }
            });
        }

        // Load maintenance history table
        function loadMaintenanceHistoryTable() {
            const maintenanceHistoryBody = document.getElementById('maintenanceHistoryTableBody');
            if (!maintenanceHistoryBody) return;
            
            maintenanceHistoryBody.innerHTML = '';
            
            systemData.maintenance.forEach(maintenance => {
                const vehicle = systemData.vehicles.find(v => v.id === maintenance.vehicleId);
                
                if (vehicle) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${vehicle.name}</td>
                        <td>${maintenance.type}</td>
                        <td>${formatDate(maintenance.date)}</td>
                        <td>${maintenance.cost} ${systemData.settings.currency}</td>
                        <td>${maintenance.description}</td>
                        <td>
                            <button class="btn btn-sm btn-info view-maintenance" data-id="${maintenance.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-maintenance" data-id="${maintenance.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    maintenanceHistoryBody.appendChild(row);
                }
            });
        }

        // Load fines and taxes table
        function loadFinesTaxesTable() {
            const finesTaxesBody = document.getElementById('finesTaxesTableBody');
            if (!finesTaxesBody) return;
            
            finesTaxesBody.innerHTML = '';
            
            systemData.finesTaxes.forEach(fineTax => {
                const customer = systemData.customers.find(c => c.id === fineTax.customerId);
                
                if (customer) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.fullName}</td>
                        <td>${fineTax.type}</td>
                        <td>${fineTax.amount} ${systemData.settings.currency}</td>
                        <td>${formatDate(fineTax.date)}</td>
                        <td>${fineTax.description}</td>
                        <td>
                            <span class="badge ${fineTax.status === 'paid' ? 'bg-success' : 'bg-danger'}">
                                ${fineTax.status}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info view-fine" data-id="${fineTax.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-success mark-paid" data-id="${fineTax.id}">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-fine" data-id="${fineTax.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    finesTaxesBody.appendChild(row);
                }
            });
        }

        // Load user table
        function loadUserTable() {
            const userTableBody = document.getElementById('userTableBody');
            if (!userTableBody) return;
            
            userTableBody.innerHTML = '';
            
            systemData.users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.fullName}</td>
                    <td>${user.role}</td>
                    <td>
                        <span class="badge ${user.status === 'active' ? 'bg-success' : 'bg-danger'}">
                            ${user.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-user" data-username="${user.username}">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${user.username !== 'admin' ? 
                            `<button class="btn btn-sm btn-danger delete-user" data-username="${user.username}">
                                <i class="fas fa-trash"></i>
                            </button>` : 
                            ''
                        }
                    </td>
                `;
                userTableBody.appendChild(row);
            });
        }

        // Updated loadPaymentHistoryTable function with enhanced actions
        function loadPaymentHistoryTable(customer) {
            const paymentHistoryBody = document.getElementById('paymentHistoryTableBody');
            if (!paymentHistoryBody) return;
            
            paymentHistoryBody.innerHTML = '';
            
            const customerPayments = systemData.payments.filter(p => p.customerId === customer.id);
            customerPayments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${payment.amount} ${systemData.settings.currency}</td>
                    <td>${payment.type}</td>
                    <td>${payment.description || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info view-payment" data-id="${payment.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary print-payment" data-id="${payment.id}">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-warning edit-payment" data-id="${payment.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-payment-record" data-id="${payment.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                paymentHistoryBody.appendChild(row);
            });
            
            // Add event listeners for new buttons
            document.querySelectorAll('.print-payment').forEach(button => {
                button.addEventListener('click', function() {
                    const paymentId = this.getAttribute('data-id');
                    printPaymentReceipt(paymentId);
                });
            });
            
            document.querySelectorAll('.edit-payment').forEach(button => {
                button.addEventListener('click', function() {
                    const paymentId = this.getAttribute('data-id');
                    editPayment(paymentId);
                });
            });
        }

        // Edit payment function
        function editPayment(paymentId) {
            const payment = systemData.payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const customer = systemData.customers.find(c => c.id === payment.customerId);
            
            // Populate payment form
            document.getElementById('paymentCustomerSearch').value = customer.fullName;
            document.getElementById('paymentAmount').value = payment.amount;
            document.getElementById('paymentDate').value = payment.date;
            document.getElementById('paymentType').value = payment.type;
            document.getElementById('paymentDescription').value = payment.description || '';
            
            // Show customer payment details
            loadCustomerPaymentDetails(customer);
            
            // Change form submit behavior to update instead of add
            const form = document.getElementById('addPaymentForm');
            const originalSubmit = form.onsubmit;
            
            form.onsubmit = function(e) {
                e.preventDefault();
                
                // Update payment
                payment.amount = parseFloat(document.getElementById('paymentAmount').value);
                payment.date = document.getElementById('paymentDate').value;
                payment.type = document.getElementById('paymentType').value;
                payment.description = document.getElementById('paymentDescription').value;
                
                saveDataToStorage();
                loadCustomerPaymentDetails(customer);
                
                // Restore original submit behavior
                form.onsubmit = originalSubmit;
                form.reset();
                
                showAlert('Payment updated successfully!', 'success');
            };
            
            // Change button text
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Update Payment';
            
            // Restore original button text when form is reset
            form.addEventListener('reset', function() {
                submitButton.textContent = originalText;
                form.onsubmit = originalSubmit;
            });
            
            showAlert('Payment data loaded for editing. Update and submit to save changes.', 'info');
        }

        // View vehicle details - Updated with rental prices
        function viewVehicleDetails(vehicleId) {
            const vehicle = systemData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            const detailsContent = document.getElementById('vehicleDetailsContent');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        ${vehicle.image ? 
                            `<img src="${vehicle.image}" class="img-fluid" alt="${vehicle.name}">` : 
                            '<div class="text-center"><i class="fas fa-car fa-5x text-muted"></i></div>'
                        }
                    </div>
                    <div class="col-md-8">
                        <h4>${vehicle.name}</h4>
                        <table class="table table-bordered">
                            <tr>
                                <th>Model</th>
                                <td>${vehicle.model}</td>
                            </tr>
                            <tr>
                                <th>Color</th>
                                <td>${vehicle.color}</td>
                            </tr>
                            <tr>
                                <th>Plate Number</th>
                                <td>${vehicle.plate}</td>
                            </tr>
                            <tr>
                                <th>VIN #</th>
                                <td>${vehicle.vin}</td>
                            </tr>
                            <tr>
                                <th>Odometer</th>
                                <td>${vehicle.odometer}</td>
                            </tr>
                            <tr>
                                <th>Daily Rental Price</th>
                                <td>${vehicle.rentalPriceDaily} ${systemData.settings.currency}</td>
                            </tr>
                            <tr>
                                <th>Weekly Rental Price</th>
                                <td>${vehicle.rentalPriceWeekly} ${systemData.settings.currency}</td>
                            </tr>
                            <tr>
                                <th>Monthly Rental Price</th>
                                <td>${vehicle.rentalPriceMonthly} ${systemData.settings.currency}</td>
                            </tr>
                            <tr>
                                <th>Status</th>
                                <td>
                                    <span class="badge ${vehicle.status === 'available' ? 'bg-success' : 
                                                      vehicle.status === 'rented' ? 'bg-primary' : 'bg-warning'}">
                                        ${vehicle.status}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('vehicleDetailsCard').style.display = 'block';
        }

        // View customer details - Updated with calculated age
        function viewCustomerDetails(customerId) {
            const customer = systemData.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            // Calculate customer statistics
            const customerRentals = systemData.rentals.filter(r => r.customerId === customer.id);
            const activeRentals = customerRentals.filter(r => r.status === 'active');
            const totalRentals = customerRentals.length;
            
            const customerFines = systemData.finesTaxes.filter(f => f.customerId === customer.id);
            const unpaidFines = customerFines.filter(f => f.status === 'unpaid');
            
            const totalSpent = customerRentals.reduce((sum, rental) => 
                sum + (rental.rentalAmount * rental.rentalDays), 0);
            
            // Calculate age if not already calculated
            if (!customer.age && customer.dateOfBirth) {
                customer.age = calculateAge(customer.dateOfBirth);
            }
            
            const detailsContent = document.getElementById('customerDetailsContent');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h4>${customer.fullName}</h4>
                        <table class="table table-bordered">
                            <tr>
                                <th>Date of Birth</th>
                                <td>${formatDate(customer.dateOfBirth)}</td>
                            </tr>
                            <tr>
                                <th>Age</th>
                                <td>${customer.age || 'N/A'}</td>
                            </tr>
                            <tr>
                                <th>ID Number</th>
                                <td>${customer.idNumber}</td>
                            </tr>
                            <tr>
                                <th>Nationality</th>
                                <td>${customer.nationality}</td>
                            </tr>
                            <tr>
                                <th>Contact</th>
                                <td>${customer.contact}</td>
                            </tr>
                            <tr>
                                <th>Address</th>
                                <td>${customer.address}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Customer Statistics</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th>Total Rentals</th>
                                <td>${totalRentals}</td>
                            </tr>
                            <tr>
                                <th>Active Rentals</th>
                                <td>${activeRentals.length}</td>
                            </tr>
                            <tr>
                                <th>Unpaid Fines</th>
                                <td>${unpaidFines.length}</td>
                            </tr>
                            <tr>
                                <th>Total Spent</th>
                                <td>${totalSpent} ${systemData.settings.currency}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                ${customer.guaranteeDoc ? 
                    `<div class="row mt-3">
                        <div class="col-12">
                            <h5>Guarantee Document</h5>
                            <a href="${customer.guaranteeDoc}" target="_blank" class="btn btn-sm btn-info">
                                <i class="fas fa-file-pdf"></i> View Document
                            </a>
                        </div>
                    </div>` : ''
                }
            `;
            
            document.getElementById('customerDetailsCard').style.display = 'block';
        }

        // Search vehicles
        function searchVehicles() {
            const query = document.getElementById('vehicleSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#vehicleTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        // Search customers
        function searchCustomers() {
            const query = document.getElementById('customerSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#customerTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        // Search rentals
        function searchRentals() {
            const query = document.getElementById('rentalSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#rentalTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function generateInvoiceCode() {
            const date = new Date();
            const year = date.getFullYear().toString().substr(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.random().toString(36).substr(2, 5).toUpperCase();
            return `INV-${year}${month}${day}-${random}`;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            const format = systemData.settings.dateFormat;
            
            if (format === 'dd/mm/yyyy') {
                return date.toLocaleDateString('en-GB');
            } else if (format === 'mm/dd/yyyy') {
                return date.toLocaleDateString('en-US');
            } else {
                return date.toISOString().split('T')[0];
            }
        }

        function formatCurrency(amount) {
            return `${amount} ${systemData.settings.currency}`;
        }

        function showAlert(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Find a good place to insert the alert
            const tabContent = document.querySelector('.tab-content');
            if (tabContent) {
                tabContent.insertBefore(alertDiv, tabContent.firstChild);
            } else {
                document.body.insertBefore(alertDiv, document.body.firstChild);
            }
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
